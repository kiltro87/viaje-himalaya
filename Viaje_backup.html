<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <title>Mi Aventura en el Himalaya</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Viaje NB">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- Favicon/Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%233b82f6'%3E%3Cpath d='M12 2L2 7v10c0 5.55 3.84 9.739 9 11 5.16-1.261 9-5.45 9-11V7l-10-5z'/%3E%3Cpath d='M12 6L6 9v6c0 3.33 2.31 5.85 6 6.6 3.69-.75 6-3.27 6-6.6V9l-6-3z' fill='white'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%233b82f6'%3E%3Cpath d='M12 2L2 7v10c0 5.55 3.84 9.739 9 11 5.16-1.261 9-5.45 9-11V7l-10-5z'/%3E%3Cpath d='M12 6L6 9v6c0 3.33 2.31 5.85 6 6.6 3.69-.75 6-3.27 6-6.6V9l-6-3z' fill='white'/%3E%3C/svg%3E">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
    <!-- LeafletJS for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>

    <!-- PDF Export & Chart Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>


    <!-- Custom Styles & Tailwind Config -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        .dark ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #64748b; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        #sidebar { transition: transform 0.3s ease-in-out; transform: translateX(0); }
        #sidebar.is-hidden { transform: translateX(-100%); }
        #main-content { transition: margin-left 0.3s ease-in-out; }
        
        .custom-div-icon { transition: transform 0.2s ease-in-out; }
        .custom-div-icon:hover { transform: scale(1.2); }

        /* Estilos para el modal del itinerario */
        #itinerary-modal.hidden { display: none; }
        .leaflet-popup-content-wrapper { border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .leaflet-popup-content { margin: 0; width: auto !important; }
        .leaflet-popup-close-button { top: 8px; right: 8px; color: #64748b; }
        .expense-paid { text-decoration: line-through; color: #9ca3af; }
        .expense-paid .editable-cost { color: #16a34a; text-decoration: none; font-weight: 600; }
        
        /* Estilos para secciones colapsables */
        .collapsible-section {
            overflow: visible;
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        
        /* Solo aplicar overflow hidden durante la animación de colapso */
        .collapsible-section.collapsed {
            overflow: hidden;
        }
        
        /* Asegurar que las tarjetas tengan espacio suficiente para sus bordes */
        .bg-white.dark\\:bg-slate-800 {
            margin: 2px;
        }
        

        
        .collapsible-section.collapsed {
            max-height: 0 !important;
            opacity: 0 !important;
        }
        
        .collapsible-section.expanded {
            opacity: 1 !important;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    keyframes: {
                        'enter': {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        'modal-in': {
                            '0%': { transform: 'scale(0.95)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        }
                    },
                    animation: { 
                        'enter': 'enter 0.5s ease-out forwards',
                        'modal-in': 'modal-in 0.2s ease-out forwards',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 transition-colors duration-300">

    <!-- Main Container -->
    <div class="relative min-h-screen">

        <!-- Sidebar / Navigation -->
        <aside id="sidebar" class="fixed top-0 left-0 h-screen w-72 flex-shrink-0 p-6 bg-white/80 dark:bg-slate-800/80 backdrop-blur-lg lg:border-r border-slate-200 dark:border-slate-700 z-40">
            <div class="flex flex-col h-full">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-blue-600 dark:text-blue-400">Aventura Himalaya</h1>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mt-1" id="sidebar-subtitle">Un recorrido de 18 días para descubrir Nepal y Bután.</p>
                    </div>
                </div>
                <nav class="mt-8 overflow-y-auto">
                    <ul id="nav-links" class="space-y-2"></ul>
                </nav>
                <div class="mt-auto pt-8">
                    <button id="theme-toggle" type="button" class="w-full flex items-center justify-center gap-2 text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg text-sm p-2.5 transition-colors">
                        <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                        <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                        <span id="theme-text"></span>
                    </button>
                    <button id="export-pdf-btn" class="mt-2 w-full flex items-center justify-center gap-2 bg-blue-600 text-white rounded-lg text-sm p-2.5 hover:bg-blue-700 transition-colors disabled:bg-blue-400">
                        <svg id="pdf-icon-download" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        <svg id="pdf-icon-loading" class="h-5 w-5 hidden animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <span>Exportar PDF</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main id="main-content" class="flex-1">
            <button id="sidebar-toggle" class="fixed top-4 left-4 z-50 p-2 rounded-md bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm text-slate-700 dark:text-slate-200 hover:bg-slate-200 dark:hover:bg-slate-700">
                <svg id="menu-open-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                <svg id="menu-close-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div class="w-full max-w-none lg:max-w-6xl xl:max-w-7xl mx-auto space-y-8 md:space-y-12 lg:space-y-16 p-3 sm:p-4 md:p-6 lg:p-8 xl:p-12">
                <header class="relative h-96 rounded-2xl overflow-hidden shadow-2xl shadow-slate-900/20">
                    <div id="parallax-bg" class="absolute inset-0 bg-cover bg-center transition-transform duration-300 ease-out" style="background-image: url('https://www.lasociedadgeografica.com/blog/uploads/2019/10/bhutan-peaceful-tours-nido-del-tigre.jpg'); transform: scale(1.1);"></div>
                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-black/20"></div>
                    <div class="relative h-full flex flex-col justify-end p-8 md:p-12 text-white">
                        <h1 class="text-4xl md:text-6xl font-black leading-tight">Mi Aventura en el Himalaya</h1>
                        <p class="text-lg md:text-xl mt-2 max-w-2xl" id="hero-subtitle">Un recorrido de 18 días para descubrir Nepal y Bután.</p>
                    </div>
                </header>
                
                <!-- Sections will be injected here -->
                <section id="overview" class="space-y-6 md:space-y-8" data-nav="Visión General" data-icon="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></section>
                <section id="flights" class="space-y-6 md:space-y-8" data-nav="Vuelos" data-icon="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L6 12z"></section>
                <section id="map-section" class="space-y-6 md:space-y-8" data-nav="Mapa" data-icon="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m-6 3l6-3m0 0l6 3m-6-3v10"></section>
                <section id="itinerary" class="space-y-6 md:space-y-8" data-nav="Itinerario" data-icon="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></section>
                <section id="budget" class="space-y-6 md:space-y-8" data-nav="Presupuesto" data-icon="M14.25 7.756a4.5 4.5 0 100 8.488M7.5 10.5h5.25m-5.25 3h5.25M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></section>
                <section id="weather" class="space-y-6 md:space-y-8" data-nav="Clima" data-icon="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></section>
                <section id="packing-list" class="space-y-6 md:space-y-8" data-nav="Equipaje" data-icon="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.75 7.5h16.5v-1.5c0-1.242-1.008-2.25-2.25-2.25h-12c-1.242 0-2.25 1.008-2.25 2.25v1.5z"></section>
                <section id="tour-packages" class="space-y-6 md:space-y-8" data-nav="Paquetes de Viaje" data-icon="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"></section>
            </div>
        </main>
    </div>
    
    <!-- Modal para Itinerario -->
    <div id="itinerary-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div id="itinerary-modal-content" class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-4xl max-h-[95vh] overflow-y-auto animate-modal-in relative">
            <!-- Content will be injected by JS -->
        </div>
    </div>

    <!-- Modal para Exportar PDF -->
    <div id="pdf-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 max-w-sm w-full animate-modal-in">
            <h3 class="text-xl font-bold mb-4">Personalizar PDF</h3>
            <p class="text-sm text-slate-500 mb-6">Selecciona las secciones que quieres incluir en tu documento.</p>
            <div id="pdf-options" class="space-y-3 mb-6"></div>
            <div class="flex gap-3">
                <button id="pdf-cancel" class="w-full p-2 rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600">Cancelar</button>
                <button id="pdf-confirm" class="w-full p-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Crear PDF</button>
            </div>
        </div>
    </div>


<!-- Bloque 1: Datos del Viaje (trip-data.js) -->
<script>
const tripConfig = {
    flightsData: [
                    { type: 'Internacional', title: 'Vuelo de Ida', airline: 'Qatar Airways', segments: [ { from: 'MAD', fromDateTime: '9 de Octubre 22:45', to: 'DOH', toDateTime: '10 de Octubre 06:30', layover: 'Tránsito de 2h 55m en Doha (DOH)' }, { from: 'DOH', fromDateTime: '10 de Octubre 09:25', to: 'KTM', toDateTime: '10 de Octubre 16:45' } ] },
                    { type: 'Regional', title: 'Katmandú → Paro', airline: 'Druk Air', segments: [{ from: 'KTM', fromDateTime: '20 de Octubre 09:10', to: 'PBH', toDateTime: '20 de Octubre 10:30' }] },
                    { type: 'Regional', title: 'Paro → Katmandú', airline: 'Bhutan Airlines', segments: [{ from: 'PBH', fromDateTime: '25 de Octubre 07:05', to: 'KTM', toDateTime: '25 de Octubre 08:00' }] },
        { type: 'Internacional', title: 'Vuelo de Vuelta', airline: 'Qatar Airways', segments: [ { from: 'KTM', fromDateTime: '26 de Octubre 09:35', to: 'DOH', toDateTime: '26 de Octubre 12:25', layover: 'Tránsito de 2h 55m en Doha (DOH)' }, { from: 'DOH', fromDateTime: '26 de Octubre 15:20', to: 'MAD', toDateTime: '26 de Octubre 20:55' } ] }
    ],
    budgetData: {
        vuelos: [{category: 'Transporte',concept: 'Vuelos Principales',icon: '✈️',subItems: [ { concept: 'Madrid ↔ Katmandú (Qatar)', cost: 270.00 }, { concept: 'Katmandú → Paro (Drukair)', cost: 227.76 }, { concept: 'Paro → Katmandú (Bhutan Airlines)', cost: 196.21 } ]}],
        nepal: [ { category: 'Tour', concept: 'Itinerario "Nepal 360"', cost: 1100.00, icon: '🗺️' }, { category: 'Transporte', concept: 'Transporte Local (Katmandú)', icon: '🚕', subItems: [ { concept: 'Taxis Aeropuerto (4 viajes)', cost: 28.00 }, { concept: 'Taxis Ciudad (4 viajes)', cost: 12.00 }, { concept: 'Autobuses (2 viajes)', cost: 1.00 } ]}, { category: 'Comida y Bebida', concept: 'Comidas en Nepal', cost: 187.00, icon: '🍛' }, { category: 'Entradas y Visados', concept: 'Visados y Entradas', icon: '🏛️',subItems: [ { concept: 'Visado de Nepal (30 días)', cost: 50.00 }, { concept: 'Plaza Durbar, Katmandú', cost: 7.00 }, { concept: 'Swayambhunath (Templo de los Monos)', cost: 1.50 }, { concept: 'Pashupatinath', cost: 7.00 }, { concept: 'Estupa de Boudhanath', cost: 3.00 } ]}, { category: 'Varios', concept: 'Gastos Varios y Propinas', icon: '🛍️',subItems: [ { concept: 'Propinas', cost: 55.00 }, { concept: 'Fondo Común Estimado', cost: 50.00 }, { concept: 'Parapente en Pokhara (Opcional)', cost: 80.00, dayId: 'day-6' }, { concept: 'Comunicaciones (SIM)', cost: 4.00 }, { concept: 'Souvenirs', cost: 22.50 }, { concept: 'Lavandería', cost: 5.00 } ]}, { category: 'Contingencia', concept: 'Fondo para Imprevistos (Nepal)', cost: 149.20, icon: '🛡️' } ],
        butan: [{ category: 'Tour', concept: 'Itinerario "Best of Bhutan"', cost: 1602.00, icon: '🗺️' },{ category: 'Entradas y Visados', concept: 'Entradas a Monumentos', icon: '🏛️',subItems: [{ concept: 'Monasterio Taktsang (Nido del Tigre)', cost: 22.00, dayId: 'day-15' },{ concept: 'Tashichho Dzong', cost: 11.00 },{ concept: 'Punakha Dzong', cost: 11.00 },{ concept: 'Memorial Chorten', cost: 11.00 },{ concept: 'Buddha Dordenma', cost: 11.00 },{ concept: 'Rinpung Dzong', cost: 11.00 }]},{ category: 'Comida y Bebida', concept: 'Bebidas', cost: 45.00, icon: '🥤' },{ category: 'Varios', concept: 'Gastos Varios y Propinas', icon: '🛍️',subItems: [{ concept: 'Propinas Guía y Conductor', cost: 90.00 },{ concept: 'Comunicaciones (SIM)', cost: 4.00 },{ concept: 'Souvenirs', cost: 22.50 }]},{ category: 'Contingencia', concept: 'Fondo para Imprevistos (Bután)', cost: 176.35, icon: '🛡️' }]
    },
    itineraryData: [
        { id: 'day-1', phase: 'nepal', title: 'Salida desde Madrid', description: "El viaje comienza con el vuelo nocturno desde Madrid-Barajas (MAD) con destino a Katmandú.", image: "https://images.unsplash.com/photo-1436491865332-7a61a109cc05?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2074&q=80", icon: '✈️', planA: "Embarque en el vuelo nocturno de Qatar Airways. Acomódate para el primer trayecto largo hasta Doha. Cena y desayuno a bordo.", planB: "Asegúrate de haber hecho el check-in online para elegir un buen asiento.", consejo: "Usa un cojín de viaje y antifaz. Dormir en el primer vuelo es clave para combatir el jet lag.", bocado: "Cena ligera antes de embarcar. En el avión, bebe mucha agua." },
        { id: 'day-2', phase: 'nepal', title: 'Llegada a Katmandú', description: "Llegada al aeropuerto, trámites de visado y traslado al hotel en Thamel para un primer contacto con la ciudad.", image: "https://www.conmochila.com/wp-content/uploads/2019/12/thamel-kathmandu-01.jpg", coords: [27.7172, 85.3240], icon: '🛬', planA: "Llegada a KTM. Pasa por inmigración para obtener el visado on-arrival. Recoge tu equipaje y busca al representante del tour o toma un taxi prepago al hotel en Thamel. Check-in y tiempo para refrescarse.", planB: "Si llegas con energía, da un primer paseo por las caóticas y fascinantes calles de Thamel para ubicarte. Para un respiro, visita el cercano Jardín de los Sueños.", consejo: "Ten a mano 50 USD en efectivo para el visado de 30 días. El proceso en el aeropuerto es sencillo pero puede haber cola. Un taxi a Thamel cuesta entre 400-800 NPR.", bocado: "Tu primer Dal Bhat. ¡El plato nacional! Pide uno en un restaurante local en Thamel." },
        { id: 'day-3', phase: 'nepal', title: 'Plaza Durbar y Encuentro WeRoad', description: "Mañana libre para explorar el corazón histórico de Katmandú, la Plaza Durbar, antes de unirte al grupo de WeRoad por la tarde para la cena de bienvenida.", image: "https://images.unsplash.com/photo-1544551763-46a013bb70d5?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80", coords: [27.7048, 85.3074], icon: '🏛️', planA: "Aprovecha la mañana para visitar la Plaza Durbar de Katmandú, Patrimonio de la Humanidad. Explora el Palacio Real de Hanuman Dhoka y busca a la diosa viviente en el Kumari Chowk. Por la tarde, check-in en el Hotel Manang o similar para el encuentro con el grupo WeRoad y la cena de bienvenida.", planB: "Piérdete por los mercados de Asan Tole e Indra Chowk, cerca de la Plaza Durbar, para una inmersión total en la vida local antes de la tranquilidad del tour.", consejo: "La entrada a la Plaza Durbar cuesta 1000 NPR y te permite acceder a varios templos y al museo del palacio. Guarda la entrada, te la pueden pedir.", bocado: "Prueba un 'Lassi' en las tiendas especializadas cerca de Indra Chowk. Es una bebida de yogur refrescante, perfecta para una pausa." },
        { id: 'day-4', phase: 'nepal', title: 'Rafting en el Trisuli y Llegada a Pokhara', description: "Viaje por carretera hacia Pokhara con una parada para una emocionante sesión de rafting en el río Trisuli. Tarde en el tranquilo barrio tibetano.", image: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80", coords: [28.2096, 83.9856], icon: '🚣', planA: "Salida temprano por carretera hacia Pokhara (aprox. 6 horas). Parada para una sesión de rafting en el río Trisuli. Llegada a Pokhara y check-in en el Hotel White Pearl o similar. Por la tarde, visita al barrio tibetano, con sus casas de colores, su templo y tiendas de artesanía. Atardecer paseando por Lakeside.", planB: "Al llegar a Pokhara, alquila una barca en el lago Phewa y rema hasta el templo Tal Barahi, situado en una isla en medio del lago. Es una experiencia muy serena.", consejo: "Para el rafting, no lleves nada de valor que no se pueda mojar. Te darán bolsas estancas para lo imprescindible. Lleva un cambio de ropa.", bocado: "Cena en un restaurante en la orilla del lago (Lakeside) en Pokhara. Prueba un Thukpa, una sopa de fideos de origen tibetano, muy reconfortante." },
        { id: 'day-5', phase: 'nepal', title: 'Trekking a Ghandruk (1.940m)', description: "Comienzo del trekking. Viaje en jeep y caminata de 5-6h (8 km) a través de selva y pueblos hasta el asentamiento Gurung de Ghandruk.", image: "https://himalayan-masters.com/wp-content/uploads/2024/08/Gurung-Cottage-Ghandruk.webp", coords: [28.375, 83.81], icon: '🏔️', planA: "Traslado en jeep hasta Landruk (aprox. 4h). Inicio de la caminata desde Jhinu Danda. La ruta pasa por Saulibazaar (parada para almorzar) y atraviesa senderos selváticos y pequeños pueblos. Llegada a Ghandruk por la tarde. Visita al museo local para entender la cultura Gurung. Noche en una pensión local.", planB: "Charla con los locales en los pueblos que atravieses. Su hospitalidad es legendaria y te permitirá conocer de cerca su modo de vida.", consejo: "La segunda parte de la ruta tiene muchas escaleras. Camina a tu propio ritmo ('bistari, bistari'). No es una carrera. Disfruta del paisaje.", bocado: "Prueba el té de jengibre, limón y miel en uno de los lodges. Es reconfortante y se dice que ayuda con la altitud." },
        { id: 'day-6', phase: 'nepal', title: 'Trekking a Chhomrong (2.170m)', description: "Segunda jornada de trekking (6-7h, 8 km) hasta Chhomrong, la puerta de entrada al Santuario del Annapurna, con vistas espectaculares.", image: "https://media.istockphoto.com/id/1493335414/es/foto/hermosa-estupa-de-budismo-tibetano-en-el-pueblo-de-chhomrong-con-el-monte-annapurna-al-sur-en.jpg?s=612x612&w=0&k=20&c=A5-ydGKKdxpFmvEYeaNQeZvYtMIX59ue3a3yl_oE3H8=", coords: [28.415, 83.82], icon: '🏔️', planA: "Desayuno con vistas. La ruta de hoy incluye un ascenso a Kimrung Danda para almorzar, seguido de un descenso hasta Chhomrong. Este pueblo es el último antes del Campo Base del Annapurna. Disfruta del atardecer sobre el Annapurna Sur y el Machhapuchhre. Noche en pensión local.", planB: "Busca la 'German Bakery' de Chhomrong. Encontrar un pastel de chocolate o un apple crumble en medio de la montaña no tiene precio.", consejo: "Las vistas del Annapurna Sur y Machhapuchhre desde Chhomrong al atardecer son espectaculares. Ten la cámara preparada.", bocado: "Recarga energías con un plato de 'garlic soup' (sopa de ajo). Es un clásico del trekking para combatir el mal de altura y entrar en calor." },
        { id: 'day-7', phase: 'nepal', title: 'Aguas Termales y Regreso a Pokhara', description: "Caminata corta de descenso (2-3h) para un baño en aguas termales en Jhimodanda y regreso en jeep a Pokhara.", image: "https://cdn.getyourguide.com/img/tour/4d032f9b41e3de55b58794f65eafe292beea2718366b16bab7fb83cfa48b9144.jpg/68.jpg", coords: [28.2096, 83.9856], icon: '♨️', planA: "Última etapa del trekking. Descenso hasta Jhimodanda. Tiempo para relajarse en las piscinas de aguas termales. Almuerzo y traslado en jeep de vuelta a Pokhara (pasando por Nayapul). Tarde libre para descansar o actividades opcionales.", planB: "Si te sientes con adrenalina, la tarde en Pokhara es ideal para hacer parapente, una de las actividades estrella de la ciudad, con vistas increíbles del lago y las montañas.", consejo: "Lleva bañador para las aguas termales. Es la mejor recompensa para los músculos después del trekking.", bocado: "Celebra el fin del trekking con una pizza en Pokhara. Hay pizzerías sorprendentemente buenas como la de Roadhouse Cafe." },
        { id: 'day-8', phase: 'nepal', title: 'Parque Nacional de Chitwan', description: "Viaje a la selva de Chitwan. Por la tarde, safari en jeep en busca de rinocerontes y otra fauna salvaje.", image: "https://dynamic-media-cdn.tripadvisor.com/media/photo-o/16/ee/68/e7/chitwan-jungle-safari.jpg?w=1200&h=900&s=1", coords: [27.5291, 84.4220], icon: '🐘', planA: "Salida por carretera hacia el sur, a la región de Terai. Llegada al Parque Nacional de Chitwan. Por la tarde, primer safari en jeep por la jungla para avistar fauna, especialmente rinocerontes de un cuerno. Cena en el lodge junto al río Rapti.", planB: "Paseo al atardecer por la orilla del río Rapti. Es muy relajante y se ven muchos pájaros y locales bañando a sus elefantes.", consejo: "Usa ropa de colores neutros (verde, beige) para el safari y no te olvides del repelente de mosquitos. Mantén silencio para no asustar a los animales.", bocado: "Prueba un curry de pescado fresco en algún restaurante cerca del río, es una especialidad de la zona." },
        { id: 'day-9', phase: 'nepal', title: 'Chitwan y Regreso a Katmandú', description: "Actividad matutina en Chitwan (paseo en canoa o visita a un pueblo Tharu) y largo viaje de vuelta a Katmandú.", image: "https://media.tacdn.com/media/attractions-splice-spp-674x446/07/9a/f2/ec.jpg", coords: [27.7172, 85.3240], icon: '🚙', planA: "Actividad matutina: paseo en canoa por el río Rapti para observar aves y cocodrilos gaviales. Desayuno y visita a un pueblo de la etnia Tharu para conocer su cultura única. Comienzo del viaje de regreso por carretera a Katmandú (aprox. 6 horas).", planB: "El paseo en canoa por el río Rapti es muy recomendable al amanecer. La niebla matutina sobre el río crea una atmósfera mágica.", consejo: "El viaje de vuelta puede ser largo y pesado. Ten a mano un libro o música para el trayecto. Compra algunos snacks locales para el camino.", bocado: "Para cenar en Katmandú, busca un restaurante que sirva 'Chatamari', a menudo llamada la 'pizza nepalí', una fina crepe de arroz con toppings." },
        { id: 'day-10', phase: 'nepal', title: 'Katmandú: Cocina y Despedida', description: "Día para explorar Katmandú de forma independiente, seguido de una clase de cocina nepalí y la cena de despedida del grupo.", image: "https://almamochilera.com/images/blog/abhishek-sanwa-limbu-lr559dcst70-unsplash-compressor.jpg", coords: [27.7172, 85.3240], icon: '🧑‍🍳', planA: "Mañana libre para explorar Thamel, visitar el Jardín de los Sueños o hacer compras. Por la tarde, participación en una clase de cocina para aprender a preparar platos como los momos. Cena de despedida del grupo para compartir las experiencias.", planB: "Visita el mercado de Asan Tole, a un corto paseo de Thamel. Es el mercado más antiguo y bullicioso de la ciudad, una experiencia sensorial auténtica.", consejo: "En la clase de cocina, no tengas miedo de pringarte las manos. Hacer la masa de los momos es muy divertido y una habilidad que te llevarás a casa.", bocado: "¡Los momos que tú mismo has preparado! Sin duda, la mejor cena de despedida." },
        { id: 'day-11', phase: 'nepal', title: 'Estupas Sagradas de Katmandú', description: "Mañana de despedida del grupo y tarde libre para explorar dos de los lugares más sagrados del budismo en el valle: Swayambhunath y Boudhanath.", image: "https://pasaportenomada.es/wp-content/uploads/2024/08/que-ver-en-katmandu-boudanath.webp", coords: [27.7147, 85.3445], icon: '☸️', planA: "Desayuno y despedida del grupo WeRoad. Tarde libre. Toma un taxi a Swayambhunath (Templo de los Monos), sube sus 365 escalones y disfruta de las vistas panorámicas de la ciudad. Por la tarde-noche, visita la gran estupa de Boudhanath.", planB: "Ve a la estupa de Boudhanath al atardecer. La atmósfera con los monjes y peregrinos dando vueltas (kora) mientras encienden lámparas de mantequilla es mágica.", consejo: "Para visitar estos dos lugares, negocia un precio con un taxista para que te lleve a ambos y te espere. Ahorrarás tiempo y dinero.", bocado: "Cena en una de las terrazas de los restaurantes que rodean la estupa de Boudhanath, con vistas a la cúpula iluminada." },
        { id: 'day-12', phase: 'butan', title: 'Llegada a Bután y Capital Thimphu', description: "Vuelo panorámico a Paro y traslado a la capital, Thimphu. Visita al Museo Nacional, al Buda Dordenma y al centro de tejido.", image: "https://upload.wikimedia.org/wikipedia/commons/4/4e/Buddha_Dordenma.jpg", coords: [27.4728, 89.6390], icon: '✈️', planA: "Traslado al aeropuerto para el espectacular vuelo a Paro. A la llegada, encuentro con el guía local. Visita al Museo Nacional (Ta Dzong) para una introducción a la historia de Bután. Traslado a Thimphu. Visita a la estatua del Buda Dordenma y al Weaving Center. Tarde libre para un primer paseo por la capital.", planB: "Pide a tu guía parar en el mirador del río Chuzom, donde se unen los ríos de Paro y Thimphu, marcados por tres estupas de diferentes estilos.", consejo: "¡Pide asiento de ventanilla en el lado izquierdo en el vuelo a Paro! Si el día está claro, verás el Everest.", bocado: "Tu primera comida en Bután seguramente incluirá 'Ema Datshi' (chiles y queso). ¡Pide que no pique mucho al principio!" },
        { id: 'day-13', phase: 'butan', title: 'Arte y Cultura en Thimphu', description: "Caminata al Monasterio de Tango y visita a los centros culturales de Thimphu: el Instituto Zorig Chusum, la Biblioteca Nacional y el Museo Postal.", image: "https://dynamic-media-cdn.tripadvisor.com/media/photo-o/11/3e/05/86/tashichho-dzong-it-was.jpg?w=900&h=500&s=1", coords: [27.578, 89.636], icon: '🎨', planA: "Por la mañana, caminata de 2.5h (ida y vuelta) al Monasterio de Tango. Almuerzo tradicional en el Folk Heritage Restaurant. Por la tarde, visita al Instituto Nacional Zorig Chusum (escuela de las 13 artes), la Biblioteca Nacional, el Authentic Craft Bazaar y el Museo Postal.", planB: "Visita la Reserva de Takines para ver el curioso animal nacional de Bután y el Tashichho Dzong (Fortaleza de la Gloriosa Religión), sede del gobierno.", consejo: "En el Museo Postal puedes imprimir un sello con tu propia foto. ¡El mejor y más original souvenir!", bocado: "Prueba los 'momos' butaneses. Son similares a los nepalíes pero a menudo más picantes y con rellenos diferentes." },
        { id: 'day-14', phase: 'butan', title: 'Hacia Punakha vía Dochula Pass', description: "Viaje a Punakha a través del paso Dochula (3.150m). Visita al 'Templo de la Fertilidad' y al majestuoso Punakha Dzong.", image: "https://www.authenticindiatours.com/app/uploads/2022/04/Monument-with-108-chorten-Dochula-Pass-Bhutan-min-1400x550-c-default.jpg", coords: [27.5843, 89.8631], icon: '🏯', planA: "Salida hacia Punakha. Parada en el paso de Dochula para admirar las 108 estupas y las vistas del Himalaya. Descenso al valle y caminata hasta el Chimi Lhakhang, el 'Templo de la Fertilidad'. Por la tarde, visita al Punakha Dzong, situado en la confluencia de los ríos Phochu y Mochu.", planB: "Cruza el puente colgante cerca del Punakha Dzong, uno de los más largos de Bután. ¡Las vistas y la sensación son geniales!", consejo: "En el paso Dochula, si el día está despejado, la vista de la cordillera del Himalaya es sobrecogedora. Tómate tu tiempo y abrígate.", bocado: "El arroz rojo es una especialidad de Bután. Lo servirán en casi todas las comidas, es nutritivo y tiene un sabor particular, a nuez." },
        { id: 'day-15', phase: 'butan', title: 'Valle de Punakha y Regreso a Paro', description: "Caminata matutina al Khamsum Yuelley Namgyel Chorten y regreso por carretera a Paro, con una posible caminata adicional en ruta.", image: "https://dynamic-media-cdn.tripadvisor.com/media/photo-o/17/1c/1e/22/khamsum-yulley-namgyal.jpg?w=1200&h=-1&s=1", coords: [27.618, 89.861], icon: '🚶‍♂️', planA: "Caminata matutina de 2.5h a través de campos de arroz hasta el Khamsum Yuelley Namgyel Chorten. Disfruta de las vistas del valle. Viaje de regreso a Paro, con almuerzo en el Dochula Cafe. Por la tarde, caminata opcional de 1h al monasterio Tashigang Gonpa desde el paso.", planB: "Pide a tu guía que te cuente la historia del 'Divino Loco', Drukpa Kunley, asociada al Templo de la Fertilidad. Es muy curiosa y fundamental para entender parte de la cultura butanesa.", consejo: "La caminata al Chorten es suave y muy fotogénica, atravesando campos de arroz y un puente colgante. Un paseo muy agradable.", bocado: "Prueba el 'Suja', el té de mantequilla butanés. Es una bebida de sabor fuerte y salado, una experiencia cultural en sí misma." },
        { id: 'day-16', phase: 'butan', title: 'Trekking al Nido del Tigre', description: "Día dedicado al trekking al icónico Monasterio de Taktsang, el 'Nido del Tigre', y cena de despedida en una granja local.", image: "https://www.earthtrekkers.com/wp-content/uploads/2017/02/Tigers-Nest-Bhutan.jpg.webp", coords: [27.4915, 89.3632], icon: '🐅', planA: "Día cumbre en Bután. Desayuno temprano y trekking al Monasterio de Taktsang (4-5h ida y vuelta). Visita al monasterio. Descenso y almuerzo. Tarde libre. Cena de despedida en una granja local con opción de baño de piedras calientes.", planB: "Si te quedan fuerzas, visita el Kyichu Lhakhang por la tarde, uno de los templos más antiguos y sagrados de Bután, para una experiencia más tranquila y espiritual.", consejo: "Empieza a caminar antes de las 8 am para evitar multitudes y el calor. El camino es empinado, usa bastones si lo necesitas. Viste con decoro (mangas y pantalones largos).", bocado: "La comida en la cafetería a mitad de camino del Nido del Tigre tiene las mejores vistas del mundo. Para la cena, prueba el 'Phaksha Paa' (cerdo con chiles)." },
        { id: 'day-17', phase: 'farewell', title: 'Joyas de Patan y Despedida', description: "Llegada a Katmandú por la mañana y tarde libre para explorar la ciudad de Patan, conocida por su exquisita Plaza Durbar y su Templo Dorado.", image: "https://upload.wikimedia.org/wikipedia/commons/4/48/Patan-Palastplatz-14-Tauben-2013-gje.jpg", coords: [27.6736, 85.3250], icon: '🏛️', planA: "Llegada al aeropuerto de Katmandú a las 9am y traslado al hotel. Por la tarde, visita la Plaza Durbar de Patan, a menudo considerada la más bella del valle. No te pierdas el increíble Museo de Patan y el cercano Templo Dorado.", planB: "En Patan, piérdete por los patios interiores (bahals) que rodean la plaza. Descubrirás pequeños santuarios, talleres de artesanos y una vida local muy tranquila.", consejo: "En el vuelo de Paro a Katmandú, pide ventanilla en el lado derecho para volver a ver el Himalaya.", bocado: "Disfruta de una última cena nepalí en un buen restaurante de Patan o Thamel. Prueba la cocina Newari, como la 'choyla' o el 'yomari'." },
        { id: 'day-18', phase: 'farewell', title: 'Vuelo de Vuelta a Casa', description: "Desayuno y traslado al aeropuerto para el vuelo de regreso, lleno de recuerdos del Himalaya.", image: "https://media.istockphoto.com/id/1465916031/es/foto/el-camino-al-avi%C3%B3n.jpg?s=612x612&w=0&k=20&c=h7qjRLIKPBelNG5e3PP6fje3D9pOxvYDHN1hoQLZHms=", coords: [27.6966, 85.3533], icon: '🏠', planA: "Desayuno en el hotel. Dependiendo de la hora del vuelo, tiempo para un último paseo por Thamel. Traslado al Aeropuerto Internacional Tribhuvan para el vuelo de regreso a casa.", planB: "Si tienes tiempo, compra té nepalí de buena calidad en alguna tienda especializada. Es un gran recuerdo y regalo.", consejo: "Llega al aeropuerto con bastante antelación. El proceso de facturación y seguridad en Katmandú puede ser lento.", bocado: "Un último café nepalí en el aeropuerto mientras esperas el embarque." }
    ],
    weatherData: [
        { location: 'Katmandú', dayTemp: '22-25°C', nightTemp: '5-10°C', icon: '☀️' }, 
        { location: 'Pokhara', dayTemp: '22-25°C', nightTemp: '5-10°C', icon: '☀️' },
        { location: 'Chitwan', dayTemp: '25-30°C', nightTemp: '15-20°C', icon: '🥵' }, 
        { location: 'Thimphu', dayTemp: '15-22°C', nightTemp: '0-7°C', icon: '🏔️' },
        { location: 'Paro', dayTemp: '15-22°C', nightTemp: '0-7°C', icon: '🏔️' }, 
        { location: 'Punakha', dayTemp: '18-25°C', nightTemp: '10-15°C', icon: '🏞️' },
        { location: 'Clima General', description: 'Octubre es ideal: días soleados y secos, noches frescas.', icon: '🌡️' }
    ],
    packingListData: {
        '👕 Ropa': ['6-7 Camisetas/Capas base', '2 Camisas de manga larga', '1 Forro polar', '1 Chaqueta impermeable/cortavientos', '2 Pantalones de trekking', '1 Pantalón cómodo (ciudad)', '8-10 Pares de ropa interior', '5 Pares de calcetines de trekking', '3 Pares de calcetines casuales'],
        '👟 Calzado': ['Botas de trekking (ya usadas)', 'Zapatillas cómodas', 'Sandalias o chanclas (para hotel/ducha)'],
        '🎒 Equipo': ['Mochila principal', 'Mochila de día (20-30L)', 'Botella de agua reutilizable', 'Gafas de sol y sombrero/gorra', 'Protector solar (SPF 50+)', 'Linterna frontal', 'Power Bank', 'Adaptador universal'],
        '📄 Documentos y Salud': ['Pasaporte y visados', 'Billetes de avión (digital/impreso)', 'Fotocopias y fotos carnet', 'Botiquín personal (analgésicos, tiritas, antidiarreico)', 'Repelente de mosquitos (para Chitwan)']
    },
    
    // Datos para el calendario interactivo
    calendarData: {
        // Generar fases dinámicamente basadas en los datos del itinerario
        get phases() {
            const phaseGroups = {};
            tripConfig.itineraryData.forEach(day => {
                const dayNumber = parseInt(day.id.replace('day-', ''));
                if (!phaseGroups[day.phase]) {
                    phaseGroups[day.phase] = [];
                }
                phaseGroups[day.phase].push(dayNumber);
            });
            
            const phaseColors = {
                'nepal': 'from-green-500 to-emerald-600',
                'butan': 'from-amber-500 to-orange-600',
                'farewell': 'from-sky-500 to-blue-600'
            };
            
            return Object.entries(phaseGroups).map(([phase, days]) => ({
                name: phase === 'nepal' ? 'Nepal' : phase === 'butan' ? 'Bután' : 'Despedida',
                color: phaseColors[phase] || 'from-gray-500 to-slate-600',
                days: days.sort((a, b) => a - b)
            }));
        },
        
        // Generar días especiales dinámicamente basados en los vuelos
        get specialDays() {
            const special = [];
            
            // Colores genéricos por tipo de vuelo
            const flightTypeColors = {
                'Internacional': 'from-red-500 to-pink-600',
                'Regional': 'from-purple-500 to-indigo-600',
                'Local': 'from-blue-500 to-cyan-600'
            };
            
            // Mapear días específicos de vuelos manualmente basándose en la información del itinerario
            const flightDays = [
                { day: 1, type: 'Internacional', from: 'MAD', to: 'KTM', label: 'MAD → KTM' },
                { day: 12, type: 'Regional', from: 'KTM', to: 'PBH', label: 'KTM → PBH' },
                { day: 17, type: 'Regional', from: 'PBH', to: 'KTM', label: 'PBH → KTM' },
                { day: 18, type: 'Internacional', from: 'KTM', to: 'MAD', label: 'KTM → MAD' }
            ];
            
            flightDays.forEach(flight => {
                // Determinar icono basado en el tipo de vuelo
                const icon = flight.type === 'Internacional' ? '✈️' : 
                            flight.type === 'Regional' ? '🛩️' : '🚁';
                
                special.push({
                    day: flight.day,
                    type: 'flight',
                    icon: icon,
                    label: flight.label,
                    color: flightTypeColors[flight.type] || 'from-gray-500 to-slate-600',
                    flightType: flight.type,
                    origin: flight.from,
                    destination: flight.to
                });
            });
            
            // Ordenar por día del viaje
            return special.sort((a, b) => a.day - b.day);
        },
        
        /**
         * Parsea la fecha de un vuelo (ej: "2025-10-09" + "22:45")
         * @param {string} dateStr - Fecha en formato ISO "2025-10-09"
         * @param {string} timeStr - Hora en formato "22:45"
         * @returns {Date} Objeto Date del vuelo
         */
        parseFlightDate(dateStr, timeStr) {
            try {
                const [hours, minutes] = timeStr.split(':');
                const flightDate = new Date(dateStr + 'T' + timeStr + ':00');
                
                return flightDate;
            } catch (error) {
                Utils.error('Error parseando fecha de vuelo:', error);
                return null;
            }
        },
        
        /**
         * Obtiene el índice del mes (0-11) a partir del nombre abreviado
         * @param {string} monthStr - Nombre del mes (ej: "Oct")
         * @returns {number} Índice del mes (0-11)
         */
        getMonthIndex(monthStr) {
            const months = {
                'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
                'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
            };
            return months[monthStr] || 0;
        },
        
        /**
         * Calcula el día del viaje (1-18) basándose en la fecha del vuelo
         * @param {Date} flightDate - Fecha del vuelo
         * @returns {number|null} Día del viaje (1-18) o null si está fuera del rango
         */
        calculateTripDay(flightDate) {
            if (!flightDate || !Utils.TRIP_START_DATE) return null;
            
            const timeDiff = flightDate.getTime() - Utils.TRIP_START_DATE.getTime();
            const dayDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            
            // El día 1 es el día de salida (9 Oct 2025), así que ajustamos
            const tripDay = dayDiff + 1;
            
            // Verificar que esté en el rango válido (1-18)
            if (tripDay >= 1 && tripDay <= 18) {
                return tripDay;
            }
            
            return null;
        },
        
        // Funciones para calcular dinámicamente
        getTotalDays() {
            return this.phases.reduce((total, phase) => total + phase.days.length, 0);
        },
        
        getTotalCountries() {
            return this.phases.length-1;
        },
        
        getDaysByPhase(phaseName) {
            const phase = this.phases.find(p => p.name.toLowerCase() === phaseName.toLowerCase());
            return phase ? phase.days.length : 0;
        }
    },
    
    // Lugares cercanos y relacionados por día
    placesByDay: {
        'day-1': [
            { name: 'Aeropuerto de Madrid-Barajas (MAD)', coords: [40.4936, -3.5668], icon: '✈️', description: 'Punto de partida del viaje' }
        ],
        'day-2': [
            { name: 'Aeropuerto Internacional Tribhuvan (KTM)', coords: [27.6966, 85.3533], icon: '🛬', description: 'Punto de llegada a Nepal' },
            { name: 'Thamel', coords: [27.7172, 85.3138], icon: '🛍️', description: 'Barrio turístico y centro neurálgico' },
            { name: 'Jardín de los Sueños', coords: [27.7172, 85.3150], icon: '🌳', description: 'Oasis de paz de estilo neoclásico' }
        ],
        'day-3': [
            { name: 'Plaza Durbar de Katmandú', coords: [27.7048, 85.3074], icon: '🏛️', description: 'Corazón histórico y Patrimonio UNESCO' },
            { name: 'Kumari Chowk', coords: [27.7045, 85.3065], icon: '🙏', description: 'Residencia de la diosa viviente' },
            { name: 'Asan Tole', coords: [27.708, 85.311], icon: '🌶️', description: 'Mercado local auténtico y bullicioso' },
            { name: 'Hotel Manang (o similar)', coords: [27.7172, 85.3138], icon: '🏨', description: 'Punto de encuentro WeRoad' }
        ],
        'day-4': [
            { name: 'Río Trisuli', coords: [27.87, 84.76], icon: '🚣', description: 'Rafting de aguas bravas' },
            { name: 'Pokhara', coords: [28.2096, 83.9856], icon: '🏞️', description: 'Ciudad a orillas del lago Phewa' },
            { name: 'Barrio Tibetano (Pokhara)', coords: [28.216, 83.96], icon: '🏘️', description: 'Asentamiento con templo y artesanía' },
            { name: 'Lago Phewa', coords: [28.2096, 83.9856], icon: '⛵', description: 'Vistas al Annapurna y Templo Tal Barahi' }
        ],
        'day-5': [
            { name: 'Ghandruk', coords: [28.375, 83.81], icon: '🏔️', description: 'Pueblo Gurung a 1.940m' },
            { name: 'Museo Gurung (Ghandruk)', coords: [28.375, 83.81], icon: '🏛️', description: 'Cultura e historia local' }
        ],
        'day-6': [
            { name: 'Chhomrong', coords: [28.415, 83.82], icon: '🏔️', description: 'Puerta del Santuario del Annapurna (2.170m)' },
            { name: 'Annapurna Sur (vista)', coords: [28.52, 83.81], icon: '⛰️', description: 'Pico de 7.219m' },
            { name: 'Machhapuchhre (vista)', coords: [28.49, 83.94], icon: '⛰️', description: 'Montaña sagrada \'Cola de Pez\' (6.993m)' }
        ],
        'day-7': [
            { name: 'Aguas Termales de Jhimodanda', coords: [28.33, 83.80], icon: '♨️', description: 'Piscinas naturales para relajación muscular' },
            { name: 'Pokhara', coords: [28.2096, 83.9856], icon: '🏞️', description: 'Regreso a la ciudad base del trekking' }
        ],
        'day-8': [
            { name: 'Parque Nacional de Chitwan', coords: [27.5291, 84.4220], icon: '🐘', description: 'Safari en busca de rinocerontes' },
            { name: 'Río Rapti', coords: [27.57, 84.49], icon: '🌊', description: 'Paseos al atardecer y canoas' }
        ],
        'day-9': [
            { name: 'Pueblo Tharu (Chitwan)', coords: [27.57, 84.49], icon: '🏘️', description: 'Cultura indígena de la región de Terai' },
            { name: 'Katmandú', coords: [27.7172, 85.3240], icon: '🏙️', description: 'Regreso a la capital' }
        ],
        'day-10': [
            { name: 'Thamel', coords: [27.7172, 85.3138], icon: '🛍️', description: 'Compras, exploración y clase de cocina' },
            { name: 'Jardín de los Sueños', coords: [27.7172, 85.3150], icon: '🌳', description: 'Oasis de paz (opcional)' }
        ],
        'day-11': [
            { name: 'Swayambhunath Stupa (Templo de los Monos)', coords: [27.7147, 85.2903], icon: '🐒', description: 'Estupa sagrada con vistas panorámicas' },
            { name: 'Boudhanath Stupa', coords: [27.7215, 85.3615], icon: '☸️', description: 'La estupa más grande de Nepal' }
        ],
        'day-12': [
            { name: 'Aeropuerto Internacional de Paro (PBH)', coords: [27.4032, 89.4246], icon: '✈️', description: 'Llegada a Bután' },
            { name: 'Museo Nacional de Bután', coords: [27.4287, 89.4265], icon: '🏛️', description: 'Historia y cultura en la atalaya Ta Dzong' },
            { name: 'Buda Dordenma', coords: [27.443, 89.637], icon: '🙏', description: 'Estatua gigante con vistas a Thimphu' }
        ],
        'day-13': [
            { name: 'Monasterio de Tango', coords: [27.578, 89.636], icon: '🏯', description: 'Caminata espiritual' },
            { name: 'Instituto Nacional Zorig Chusum', coords: [27.48, 89.63], icon: '🎨', description: 'Escuela de las 13 artes de Bután' },
            { name: 'Museo Postal de Bután', coords: [27.47, 89.63], icon: '📮', description: 'Crea tu propio sello postal' },
            { name: 'Tashichho Dzong', coords: [27.4897, 89.6350], icon: '🏛️', description: 'Sede del gobierno y cuerpo monástico' }
        ],
        'day-14': [
            { name: 'Paso Dochula', coords: [27.492, 89.744], icon: '🏔️', description: '108 estupas y vistas del Himalaya' },
            { name: 'Chimi Lhakhang', coords: [27.57, 89.83], icon: '❤️', description: 'Templo de la Fertilidad' },
            { name: 'Punakha Dzong', coords: [27.5843, 89.8631], icon: '🏯', description: 'Palacio de la Gran Felicidad' },
            { name: 'Puente Colgante de Punakha', coords: [27.58, 89.86], icon: '🌉', description: 'Uno de los más largos de Bután' }
        ],
        'day-15': [
            { name: 'Khamsum Yuelley Namgyel Chorten', coords: [27.618, 89.861], icon: '🏯', description: 'Chorten sagrado con vistas al valle' }
        ],
        'day-16': [
            { name: 'Monasterio de Taktsang (Nido del Tigre)', coords: [27.4915, 89.3632], icon: '🐅', description: 'El icono sagrado de Bután' },
            { name: 'Kyichu Lhakhang', coords: [27.4411, 89.3764], icon: '🏛️', description: 'Uno de los templos más antiguos de Bután' }
        ],
        'day-17': [
            { name: 'Plaza Durbar de Patan', coords: [27.6736, 85.3250], icon: '🏛️', description: 'Patrimonio UNESCO, la \'Ciudad de la Belleza\'' },
            { name: 'Museo de Patan', coords: [27.6736, 85.3250], icon: '🏺', description: 'Considerado uno de los mejores de Asia' },
            { name: 'Templo Dorado (Hiranya Varna Mahavihar)', coords: [27.675, 85.323], icon: '✨', description: 'Monasterio budista del siglo XII' }
        ],
        'day-18': [
            { name: 'Aeropuerto Internacional Tribhuvan (KTM)', coords: [27.6966, 85.3533], icon: '✈️', description: 'Punto de partida final' }
        ]
    }
};
</script>

<!-- Bloque 2: Lógica de la Aplicación (Refactorizada) -->
<script>
// ===== CONFIGURACIÓN Y ESTADO GLOBAL =====
const AppState = {
        activeBudgetCategories: new Set(),
        isScrolling: false,
        map: null,
        expenses: JSON.parse(localStorage.getItem('tripExpensesV1')) || [],
        realCosts: JSON.parse(localStorage.getItem('tripRealCostsV1')) || {},
        modalMaps: new Map(),
        
        // Sistema de persistencia mejorado
        saveAllData() {
            try {
                localStorage.setItem('tripExpensesV1', JSON.stringify(this.expenses));
                localStorage.setItem('tripRealCostsV1', JSON.stringify(this.realCosts));
                localStorage.setItem('tripPackedItemsV1', JSON.stringify([...ThemeManager.getPackedItems()]));
                localStorage.setItem('tripThemeV1', ThemeManager.isDarkMode() ? 'dark' : 'light');
                localStorage.setItem('tripLastAccessV1', new Date().toISOString());
                Utils.log('💾 Todos los datos guardados en localStorage');
            } catch (error) {
                Utils.error('❌ Error al guardar datos:', error);
            }
        },
        
        loadAllData() {
            try {
                this.expenses = JSON.parse(localStorage.getItem('tripExpensesV1')) || [];
                this.realCosts = JSON.parse(localStorage.getItem('tripRealCostsV1')) || {};
                
                // Restaurar tema
                const savedTheme = localStorage.getItem('tripThemeV1');
                if (savedTheme === 'dark') {
                    ThemeManager.enableDarkMode();
                } else if (savedTheme === 'light') {
                    ThemeManager.enableLightMode();
                }
                
                // Restaurar items empacados
                const packedItems = JSON.parse(localStorage.getItem('tripPackedItemsV1') || '[]');
                packedItems.forEach(item => ThemeManager.addPackedItem(item));
                
                const lastAccess = localStorage.getItem('tripLastAccessV1');
                if (lastAccess) {
                    Utils.log(`📱 Datos restaurados. Último acceso: ${new Date(lastAccess).toLocaleString()}`);
                }
            } catch (error) {
                Utils.error('❌ Error al cargar datos:', error);
            }
        }
};

// ===== UTILIDADES =====
/**
 * Utilidades compartidas para toda la aplicación
 * Proporciona funciones comunes de formateo, cálculo y logging
 */
const Utils = {
    /**
     * Fecha de salida del viaje (9 de octubre)
     * Se usa como base para calcular todas las fechas del itinerario
     */
    TRIP_START_DATE: new Date('2025-10-09'),

    /**
     * Calcula la fecha para un día específico del viaje
     * @param {number} dayNumber - Número del día (0-17)
     * @returns {Date} Fecha calculada
     */
    getTripDate: (dayNumber) => {
        const date = new Date(Utils.TRIP_START_DATE);
        date.setDate(date.getDate() + dayNumber);
        return date;
    },

    /**
     * Formatea una fecha en formato corto (ej: "9 Oct")
     * @param {Date} date - Fecha a formatear
     * @returns {string} Fecha formateada
     */
    formatShortDate: (date) => {
        const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
        return `${date.getDate()} ${months[date.getMonth()]}`;
    },

    /**
     * Formatea un importe como moneda EUR
     * @param {number} amount - Importe a formatear
     * @param {boolean} round - Si redondear a números enteros
     * @returns {string} Importe formateado (ej: "1.234,56 €")
     */
    formatCurrency: (amount, round = false) => {
        const value = round ? Math.round(amount) : amount;
        return new Intl.NumberFormat('es-ES', { 
            style: 'currency', 
            currency: 'EUR', 
            minimumFractionDigits: 0, 
            maximumFractionDigits: round ? 0 : 2 
        }).format(value);
    },

    /**
     * Calcula el subtotal de una lista de items, considerando costos reales
     * @param {Array} items - Lista de items con costos
     * @returns {number} Subtotal calculado
     */
    calculateSubtotal: (items) => items.reduce((sum, item) => {
        const itemId = `${item.category}-${item.concept}`;
        if (item.subItems) {
            // Si tiene sub-items, sumar cada uno con su costo real
            return sum + item.subItems.reduce((subSum, subItem) => {
                const subItemId = `${item.category}-${item.concept}-${subItem.concept}`;
                return subSum + (AppState.realCosts[subItemId] || subItem.cost);
            }, 0);
        }
        // Si no tiene sub-items, usar el costo real o el estimado
        return sum + (AppState.realCosts[itemId] || item.cost);
    }, 0),

    /**
     * Crea el HTML del encabezado de una sección
     * @param {string} title - Título de la sección
     * @returns {string} HTML del encabezado
     */
            createSectionHeader: (title, sectionId = null) => {
            const headerId = sectionId || title.toLowerCase().replace(/\s+/g, '-');
            return `
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-bold text-slate-900 dark:text-white">${title}</h2>
                    <button 
                        onclick="Utils.toggleSection('${headerId}')" 
                        class="p-2 rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
                        title="Colapsar/Expandir sección"
                    >
                        <svg class="w-5 h-5 transform transition-transform" id="icon-${headerId}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                </div>
                <div id="content-${headerId}" class="collapsible-section expanded transition-all duration-300" style="overflow: visible;">
            `;
        },
        
        /**
         * Alterna el estado colapsado/expandido de una sección
         * @param {string} sectionId - ID de la sección a alternar
         */
        toggleSection(sectionId) {
            const content = document.getElementById(`content-${sectionId}`);
            const icon = document.getElementById(`icon-${sectionId}`);
            
            if (content && icon) {
                // Verificar si está colapsado usando una clase CSS
                const isCollapsed = content.classList.contains('collapsed');
                
                if (isCollapsed) {
                    // Expandir
                    content.classList.remove('collapsed');
                    content.classList.add('expanded');
                    // Establecer maxHeight al scrollHeight para la animación
                    content.style.maxHeight = content.scrollHeight + 'px';
                    icon.style.transform = 'rotate(0deg)';
                    
                    // Después de la animación, quitar el maxHeight para permitir crecimiento dinámico
                    setTimeout(() => {
                        if (content.classList.contains('expanded')) {
                            content.style.maxHeight = 'none';
                        }
                    }, 300);
                } else {
                    // Colapsar
                    // Primero establecer el maxHeight actual
                    content.style.maxHeight = content.scrollHeight + 'px';
                    
                    // Forzar un reflow
                    content.offsetHeight;
                    
                    // Luego colapsar
                    content.classList.remove('expanded');
                    content.classList.add('collapsed');
                    content.style.maxHeight = '0px';
                    icon.style.transform = 'rotate(180deg)';
                }
            }
        },
        
        /**
         * Cierra (colapsa) una sección específica
         * @param {string} sectionId - ID de la sección a cerrar
         */
        closeSection(sectionId) {
            const content = document.getElementById(`content-${sectionId}`);
            const icon = document.getElementById(`icon-${sectionId}`);
            
            if (content && icon) {
                content.classList.remove('expanded');
                content.classList.add('collapsed');
                icon.style.transform = 'rotate(180deg)';
            }
        },
        
        /**
         * Inicializa todas las secciones como expandidas
         */
        initializeSections() {
            // Buscar todos los contenedores de contenido de secciones
            const sectionContents = document.querySelectorAll('[id^="content-"]');
            
            sectionContents.forEach(content => {
                // Asegurar que esté expandido por defecto
                content.classList.remove('collapsed');
                content.classList.add('expanded');
                
                // Obtener el icono correspondiente
                const sectionId = content.id.replace('content-', '');
                const icon = document.getElementById(`icon-${sectionId}`);
                if (icon) {
                    icon.style.transform = 'rotate(0deg)';
                }
            });
        },

    /**
     * Implementa debounce para optimizar llamadas frecuentes
     * @param {Function} func - Función a ejecutar
     * @param {number} wait - Tiempo de espera en ms
     * @returns {Function} Función con debounce aplicado
     */
    debounce: (func, wait) => {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    },

    /**
     * Log de información con prefijo de la aplicación
     * @param {string} message - Mensaje a mostrar
     * @param {*} data - Datos adicionales opcionales
     */
    log: (message, data = null) => {
        console.log(`🏔️ [Himalaya App] ${message}`, data || '');
    },

    /**
     * Log de errores con prefijo de la aplicación
     * @param {string} message - Mensaje de error
     * @param {Error} error - Objeto de error opcional
     */
    error: (message, error = null) => {
        console.error(`❌ [Himalaya App] ${message}`, error || '');
    }
};

// ===== GESTORES DE UI =====
/**
 * Gestor del sistema de temas (claro/oscuro)
 * Maneja la alternancia entre modos y persiste la preferencia del usuario
 */
const ThemeManager = {
    /**
     * Inicializa el gestor de temas
     * Configura el tema inicial basado en localStorage o preferencias del sistema
     */
        init() {
        Utils.log('Inicializando Theme Manager');
            this.toggleBtn = document.getElementById('theme-toggle');
            this.lightIcon = document.getElementById('theme-toggle-light-icon');
            this.darkIcon = document.getElementById('theme-toggle-dark-icon');
            this.themeText = document.getElementById('theme-text');
        
        // Configurar tema inicial: priorizar localStorage, luego preferencias del sistema
        if (localStorage.getItem('color-theme') === 'dark' || 
            (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
        
            this.updateUI();
            this.toggleBtn.addEventListener('click', () => this.toggle());
        },

    /**
     * Alterna entre tema claro y oscuro
     * Actualiza localStorage y la interfaz de usuario
     */
        toggle() {
            document.documentElement.classList.toggle('dark');
        const isDark = document.documentElement.classList.contains('dark');
        localStorage.setItem('color-theme', isDark ? 'dark' : 'light');
            this.updateUI();
        Utils.log(`Tema cambiado a: ${isDark ? 'oscuro' : 'claro'}`);
        },

    /**
     * Actualiza la interfaz según el tema activo
     * Muestra/oculta iconos y actualiza el texto del botón
     */
        updateUI() {
            const isDark = document.documentElement.classList.contains('dark');
            this.lightIcon.classList.toggle('hidden', isDark);
            this.darkIcon.classList.toggle('hidden', !isDark);
            this.themeText.textContent = isDark ? 'Modo Claro' : 'Modo Oscuro';
        }
    };

/**
 * Gestor de la barra lateral de navegación
 * Maneja la apertura/cierre, responsive design y auto-ocultación en móviles
 */
const SidebarManager = {
    /**
     * Inicializa el gestor de sidebar
     * Configura event listeners y estado inicial según el tamaño de pantalla
     */
        init() {
        Utils.log('Inicializando Sidebar Manager');
            this.sidebar = document.getElementById('sidebar');
            this.mainContent = document.getElementById('main-content');
            this.toggleBtn = document.getElementById('sidebar-toggle');
            this.openIcon = document.getElementById('menu-open-icon');
            this.closeIcon = document.getElementById('menu-close-icon');
        
            this.toggleBtn.addEventListener('click', () => this.toggle());
        
        // Auto-ocultar en móviles cuando se hace clic fuera del sidebar
        document.addEventListener('click', (e) => this.handleOutsideClick(e));
        
        // Configurar estado inicial según el tamaño de pantalla
        if (window.innerWidth < 1024) {
            this.sidebar.classList.add('is-hidden');
        } else {
            this.mainContent.classList.add('lg:ml-72');
        }
        
            this.updateUI();
        
        // Escuchar cambios de tamaño de ventana con debounce
        window.addEventListener('resize', Utils.debounce(() => {
            this.handleResize();
        }, 250));
    },

    /**
     * Maneja clics fuera del sidebar en dispositivos móviles
     * @param {Event} e - Evento de clic
     */
    handleOutsideClick(e) {
        // Solo en dispositivos móviles (pantalla < 1024px)
        if (window.innerWidth >= 1024) return;
        
        // Si el sidebar está visible y el clic no es en el sidebar ni en el botón de toggle
        if (!this.sidebar.classList.contains('is-hidden') && 
            !this.sidebar.contains(e.target) && 
            !this.toggleBtn.contains(e.target)) {
            this.hide();
        }
    },

    /**
     * Oculta el sidebar programáticamente
     * Útil para auto-ocultación en móviles
     */
    hide() {
        if (!this.sidebar.classList.contains('is-hidden')) {
            this.sidebar.classList.add('is-hidden');
            this.updateUI();
            Utils.log('Sidebar ocultado automáticamente');
        }
    },

    /**
     * Alterna la visibilidad del sidebar
     * Ajusta el margen del contenido principal en desktop
     */
        toggle() {
            const isHidden = this.sidebar.classList.toggle('is-hidden');
            this.updateUI();
        if (window.innerWidth >= 1024) {
            this.mainContent.classList.toggle('lg:ml-72', !isHidden);
        }
        Utils.log(`Sidebar ${isHidden ? 'ocultado' : 'mostrado'}`);
    },

    /**
     * Maneja cambios de tamaño de ventana
     * Ajusta el layout según el breakpoint de pantalla
     */
    handleResize() {
        if (window.innerWidth >= 1024 && !this.sidebar.classList.contains('is-hidden')) {
            this.mainContent.classList.add('lg:ml-72');
        } else if (window.innerWidth < 1024) {
            this.mainContent.classList.remove('lg:ml-72');
        }
    },

    /**
     * Actualiza la interfaz del sidebar
     * Muestra/oculta iconos según el estado actual
     */
        updateUI() {
            const isHidden = this.sidebar.classList.contains('is-hidden');
            this.openIcon.classList.toggle('hidden', !isHidden);
            this.closeIcon.classList.toggle('hidden', isHidden);
        }
    };

const ParallaxManager = {
        init() {
        Utils.log('Inicializando Parallax Manager');
            this.bg = document.getElementById('parallax-bg');
            window.addEventListener('scroll', () => {
            if (!AppState.isScrolling) {
                    window.requestAnimationFrame(() => {
                        this.update();
                    AppState.isScrolling = false;
                    });
                AppState.isScrolling = true;
                }
            }, { passive: true });
        },

        update() {
            const scrolled = window.scrollY;
            const scale = 1.1 - (scrolled * 0.0001);
        if (this.bg) {
            this.bg.style.transform = `translate3d(0, ${scrolled * 0.3}px, 0) scale(${Math.max(1, scale)})`;
        }
        }
    };

const NavigationManager = {
        init() {
        Utils.log('Inicializando Navigation Manager');
            this.navLinksContainer = document.getElementById('nav-links');
            this.sections = document.querySelectorAll('main section[data-nav]');
            this.render();
            this.observeSections();
        },

        render() {
            this.navLinksContainer.innerHTML = Array.from(this.sections).map(section => `
                <li>
                    <a href="#${section.id}" data-nav-link="${section.id}" class="flex items-center gap-3 px-3 py-2 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 font-medium transition-colors">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="${section.dataset.icon}"></path></svg>
                        <span>${section.dataset.nav}</span>
                    </a>
                </li>`).join('');
        },

        observeSections() {
            const observer = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    const id = entry.target.getAttribute('id');
                    const navLink = this.navLinksContainer.querySelector(`[data-nav-link="${id}"]`);
                    if (entry.isIntersecting) {
                        this.navLinksContainer.querySelectorAll('a').forEach(l => l.classList.remove('bg-blue-100', 'dark:bg-blue-900/50', 'text-blue-600', 'dark:text-blue-400'));
                        navLink.classList.add('bg-blue-100', 'dark:bg-blue-900/50', 'text-blue-600', 'dark:text-blue-400');
                    }
                });
            }, { rootMargin: '-40% 0px -60% 0px' });
            this.sections.forEach(section => observer.observe(section));
        }
    };

const PDFExporter = {
        init() {
        Utils.log('Inicializando PDF Exporter');
            this.btn = document.getElementById('export-pdf-btn');
            this.modal = document.getElementById('pdf-modal');
            this.optionsContainer = document.getElementById('pdf-options');
        
            this.btn.addEventListener('click', () => this.showModal());
            document.getElementById('pdf-cancel').addEventListener('click', () => this.hideModal());
            document.getElementById('pdf-confirm').addEventListener('click', () => this.export());
        },

        showModal() {
            this.optionsContainer.innerHTML = Array.from(document.querySelectorAll('main section[data-nav]')).map(section => `
                <label class="flex items-center gap-3 p-3 rounded-lg bg-slate-100 dark:bg-slate-700">
                    <input type="checkbox" name="pdf-section" value="${section.id}" checked class="h-5 w-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                    <span>${section.dataset.nav}</span>
                </label>`).join('');
        
            this.modal.classList.remove('hidden');
            this.modal.classList.add('flex');
        Utils.log('Modal de PDF mostrado');
        },

        hideModal() {
            this.modal.classList.add('hidden');
            this.modal.classList.remove('flex');
        Utils.log('Modal de PDF ocultado');
        },

        async export() {
        Utils.log('Iniciando exportación a PDF');
            alert('La exportación personalizada a PDF es una funcionalidad avanzada. ¡Gracias por probar!');
            this.hideModal();
        }
    };

/**
 * Renderizador principal de la interfaz de usuario
 * Coordina la creación y actualización de todas las secciones de la aplicación
 */
const UIRenderer = {
        /**
         * Inicializa el renderizador de UI
         * Renderiza todas las secciones en el orden correcto
         */
        init() {
            Utils.log('Inicializando UI Renderer');
            this.renderOverview();
            this.renderFlights();
            this.renderMap();
            // El calendario ahora se renderiza en la sección de visión general
            this.renderItinerary();
            this.renderBudget();
            this.renderWeather();
            this.renderPackingList();
            this.renderTourPackages();
            Utils.log('Todas las secciones renderizadas');
        },
        renderOverview() {
            const container = document.getElementById('overview');
            const grandTotal = Utils.calculateSubtotal(Object.values(tripConfig.budgetData).flat());
            // Calcular estadísticas dinámicamente
            const totalDays = tripConfig.calendarData.getTotalDays();
            const totalCountries = tripConfig.calendarData.getTotalCountries();
            const costPerDay = grandTotal / totalDays;
            
            const stats = [
                { value: totalDays.toString(), label: 'Días de Viaje' },
                { value: totalCountries.toString(), label: 'Países Increíbles' },
                { value: Utils.formatCurrency(grandTotal, true), label: 'Presupuesto Total' },
                { value: `~${Utils.formatCurrency(costPerDay, true)}`, label: 'Coste por Día' }
            ];
            // Calcular estilos del viaje dinámicamente basándose en las actividades
            const tripStyles = this.calculateTripStyles();
           
            const statsHTML = stats.map(stat => `<div class="bg-white dark:bg-slate-800 p-6 rounded-2xl text-center shadow-lg border border-slate-200 dark:border-slate-700 flex flex-col justify-center"><p class="text-3xl sm:text-4xl lg:text-3xl xl:text-4xl font-black text-blue-600 dark:text-blue-400 break-words">${stat.value}</p><p class="text-sm font-semibold text-slate-600 dark:text-slate-300 mt-2">${stat.label}</p></div>`).join('');
            const stylesHTML = tripStyles.map(style => `<div class="text-center flex-1 min-w-0"><div class="relative w-full aspect-square max-w-32 mx-auto"><svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100"><circle class="text-slate-200 dark:text-slate-700" stroke-width="8" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" /><circle class="${style.color}" stroke-width="8" stroke-dasharray="283" stroke-dashoffset="${283 - (283 * style.percentage) / 100}" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" /></svg><span class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-2xl sm:text-3xl lg:text-4xl">${style.emoji}</span></div><p class="font-semibold mt-2 sm:mt-3 text-sm sm:text-base lg:text-lg">${style.title}</p></div>`).join('');
            container.innerHTML = `${Utils.createSectionHeader('Visión General')}<div class="space-y-12"><div class="grid grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">${statsHTML}</div><div><h3 class="text-xl font-bold text-slate-900 dark:text-white mb-6">Estilo del Viaje</h3><div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700"><div class="flex justify-between gap-2 sm:gap-4 lg:gap-8">${stylesHTML}</div></div></div><div><h3 class="text-xl font-bold text-slate-900 dark:text-white mb-6">Calendario del Viaje</h3><div id="overview-calendar" class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700"></div></div></div></div>`;
            
            // Renderizar el calendario en el contenedor de la visión general
            setTimeout(() => {
                const overviewCalendar = document.getElementById('overview-calendar');
                if (overviewCalendar) {
                    this.renderCalendar(overviewCalendar);
                }
            }, 100);
        },
        
        /**
         * Genera las fases del itinerario dinámicamente basándose en los datos reales
         * @returns {Array} Array de fases con título y phase
         */
        generateItineraryPhases() {
            // Mapear fases a nombres y emojis
            const phaseMapping = {
                'nepal': { name: '🇳🇵 Aventura en Nepal', emoji: '🇳🇵' },
                'butan': { name: '🇧🇹 El Reino del Dragón', emoji: '🇧🇹' },
                'farewell': { name: '✈️ Despedida del Himalaya', emoji: '✈️' }
            };
            
            // Agrupar días por fase y generar fases ordenadas
            const phaseGroups = tripConfig.itineraryData.reduce((groups, day) => {
                if (!groups[day.phase]) groups[day.phase] = [];
                groups[day.phase].push(day);
                return groups;
            }, {});
            
            return Object.entries(phaseGroups)
                .map(([phaseKey, days], index) => {
                    const phaseInfo = phaseMapping[phaseKey] || { name: phaseKey, emoji: '🌍' };
                    const sortedDays = days.sort((a, b) => 
                        parseInt(a.id.replace('day-', '')) - parseInt(b.id.replace('day-', ''))
                    );
                    
                    return {
                        title: `Parte ${index + 1}: ${phaseInfo.name}`,
                        phase: phaseKey,
                        days: sortedDays,
                        emoji: phaseInfo.emoji
                    };
                })
                .sort((a, b) => 
                    parseInt(a.days[0].id.replace('day-', '')) - parseInt(b.days[0].id.replace('day-', ''))
                );
        },
        
        /**
         * Calcula los estilos del viaje dinámicamente basándose en las actividades del itinerario
         * @returns {Array} Array de estilos con título, porcentaje, color y emoji
         */
        calculateTripStyles() {
            // Definir categorías de actividades y sus pesos
            const activityCategories = {
                'naturaleza': { keywords: ['trekking', 'rafting', 'parque', 'montaña', 'selva', 'río', 'lago'], emoji: '🌲', color: 'text-green-500' },
                'cultura': { keywords: ['templo', 'monasterio', 'museo', 'plaza', 'durbar', 'dzong', 'estupa'], emoji: '🏛️', color: 'text-amber-500' },
                'ciudad': { keywords: ['thamel', 'pokhara', 'thimphu', 'paro', 'katmandú', 'mercado', 'restaurante'], emoji: '🏙️', color: 'text-red-500' },
                'aventura': { keywords: ['parapente', 'rafting', 'trekking', 'safari'], emoji: '🏔️', color: 'text-purple-500' },
                'relax': { keywords: ['aguas termales', 'spa', 'descanso', 'tarde libre'], emoji: '🏖️', color: 'text-sky-500' }
            };
            
            // Contar actividades por categoría
            const categoryCounts = {};
            const totalDays = tripConfig.itineraryData.length;
            
            // Inicializar contadores
            Object.keys(activityCategories).forEach(category => {
                categoryCounts[category] = 0;
            });
            
            // Analizar cada día del itinerario
            tripConfig.itineraryData.forEach(day => {
                const dayText = `${day.title} ${day.description} ${day.planA} ${day.planB}`.toLowerCase();
                
                Object.entries(activityCategories).forEach(([category, config]) => {
                    if (config.keywords.some(keyword => dayText.includes(keyword))) {
                        categoryCounts[category]++;
                    }
                });
            });
            
            // Calcular porcentajes y generar estilos
            return Object.entries(categoryCounts)
                .filter(([_, count]) => count > 0)
                .map(([category, count]) => {
                    const config = activityCategories[category];
                    return {
                        title: this.capitalizeFirst(category),
                        percentage: Math.round((count / totalDays) * 100),
                        color: config.color,
                        emoji: config.emoji
                    };
                })
                .sort((a, b) => b.percentage - a.percentage);
        },
        
        /**
         * Capitaliza la primera letra de una cadena
         * @param {string} str - Cadena a capitalizar
         * @returns {string} Cadena con primera letra mayúscula
         */
        capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        },
        
        renderTourPackages() {
            const container = document.getElementById('tour-packages');
            container.innerHTML = `${Utils.createSectionHeader('Paquetes de Viaje Originales')}<div class="grid md:grid-cols-2 gap-6"><a href="https://www.weroad.es/viajes/nepal-360" target="_blank" class="block bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 hover:border-blue-500 dark:hover:border-blue-400 transition-all duration-300"><h3 class="font-bold text-lg text-blue-600 dark:text-blue-400">Nepal 360°</h3><p class="text-sm text-slate-500 dark:text-slate-400 mt-1">por WeRoad</p></a><a href="https://www.bhutan-acorn.com/tour/6-days-best-of-bhutan-tour" target="_blank" class="block bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 hover:border-blue-500 dark:hover:border-blue-400 transition-all duration-300"><h3 class="font-bold text-lg text-blue-600 dark:text-blue-400">Best of Bhutan Tour</h3><p class="text-sm text-slate-500 dark:text-slate-400 mt-1">por Bhutan Acorn Tours</p></a></div>`;
        },
        renderFlights() {
            const container = document.getElementById('flights');
            const flightSegmentHTML = (segment) => `<div class="flex items-center gap-4"><span class="text-2xl">✈️</span><div><p class="font-bold">${segment.from} ${segment.fromDateTime.split(' ').slice(-1)[0]}</p><p class="text-sm text-slate-500">${segment.fromDateTime.split(' ').slice(0, -1).join(' ')}</p></div><div class="flex-1 border-t border-dashed border-slate-300 dark:border-slate-600"></div><div><p class="font-bold">${segment.to} ${segment.toDateTime.split(' ').slice(-1)[0]}</p><p class="text-sm text-slate-500">${segment.toDateTime.split(' ').slice(0, -1).join(' ')}</p></div></div>`;
            const flightCardHTML = (flight) => `<div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700"><h3 class="font-bold text-lg text-blue-600 dark:text-blue-400 mb-4">${flight.title} <span class="text-sm font-medium text-slate-500 dark:text-slate-400">- ${flight.airline}</span></h3><div class="space-y-4">${flight.segments.map((segment, index) => `${index > 0 && flight.segments[index-1].layover ? `<p class="text-center text-sm text-slate-500 bg-slate-100 dark:bg-slate-700/50 rounded-full py-1">${flight.segments[index-1].layover}</p>` : ''}${flightSegmentHTML(segment)}`).join('')}</div></div>`;
            const internationalFlights = tripConfig.flightsData.filter(f => f.type === 'Internacional');
            const regionalFlights = tripConfig.flightsData.filter(f => f.type === 'Regional');
            container.innerHTML = `${Utils.createSectionHeader('Detalles de Vuelos')}<div class="space-y-6">${flightCardHTML(internationalFlights[0])}<div class="grid md:grid-cols-2 gap-6">${regionalFlights.map(flightCardHTML).join('')}</div>${flightCardHTML(internationalFlights[1])}</div>`;
        },
        renderMap() {
            Utils.log('🗺️ Renderizando mapa principal');
            const container = document.getElementById('map-section');
            container.innerHTML = `${Utils.createSectionHeader('Mapa del Recorrido')}<div id="map" class="h-96 md:h-[500px] bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg ring-1 ring-slate-900/5 dark:ring-white/10 z-10"></div>`;
            setTimeout(() => {
                try {
                    AppState.map = L.map('map', { closePopupOnClick: false }).setView([28.3949, 84.1240], 7);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap &copy; CARTO' }).addTo(AppState.map);
                const latlngs = tripConfig.itineraryData.reduce((acc, day) => {
                    if (day.coords) {
                        const dayNumber = parseInt(day.id.replace('day-', ''));
                        const tripDate = Utils.getTripDate(dayNumber - 1);
                        const popupContent = `<div class="w-48"><img src="${day.image || 'https://placehold.co/400x200/4f46e5/ffffff?text=Himalaya'}" class="w-full h-24 object-cover rounded-t-lg" alt="${day.title}"><div class="p-2"><b class="text-blue-600">${day.title}</b><p class="text-xs">Día ${dayNumber} - ${Utils.formatShortDate(tripDate)}</p><p class="text-xs text-slate-600 mt-1">${day.description.substring(0, 80)}...</p><a href="#${day.id}" class="text-blue-500 text-xs font-semibold mt-1 block">Ver detalles →</a></div></div>`;
                        const marker = L.marker(day.coords, { icon: L.divIcon({ className: 'custom-div-icon', html: `<div class="w-8 h-8 bg-white dark:bg-slate-800 rounded-full flex items-center justify-center text-lg shadow-md border-2 border-blue-500">${day.icon}</div>`, iconSize: [30, 42], iconAnchor: [15, 42] })                         }).addTo(AppState.map).bindPopup(popupContent, { offset: L.point(0, -20), autoClose: false, closeButton: true });
                        
                        let hoverTimeout;
                        marker.on('mouseover', function () { clearTimeout(hoverTimeout); this.openPopup(); });
                        marker.on('mouseout', function () { hoverTimeout = setTimeout(() => this.closePopup(), 2000); });
                        marker.on('click', () => { clearTimeout(hoverTimeout); document.getElementById(day.id)?.scrollIntoView({ behavior: 'smooth', block: 'center' }); });

                        acc.push(day.coords);
                    }
                    return acc;
                }, []);
                const polyline = L.polyline(latlngs, {color: '#2563eb', weight: 3}).addTo(AppState.map);
                L.polylineDecorator(polyline, { patterns: [{ offset: 25, repeat: 100, symbol: L.Symbol.arrowHead({ pixelSize: 12, pathOptions: { fillOpacity: 1, weight: 0, color: '#2563eb' }}) }]}).addTo(AppState.map);
                if (polyline.getBounds().isValid()) AppState.map.fitBounds(polyline.getBounds().pad(0.2));
                
                Utils.log('✅ Mapa principal creado exitosamente');
            } catch (error) {
                Utils.error('Error al crear mapa principal:', error);
            }
            }, 100);
        },
        renderItinerary() {
            Utils.log('Renderizando sección de itinerario');
            const container = document.getElementById('itinerary');
            if (!container) {
                Utils.error('Contenedor de itinerario no encontrado');
                return;
            }
            
            // Generar fases dinámicamente basadas en los datos reales del itinerario
            const phases = this.generateItineraryPhases();
            const timelineHTML = phases.map(p => `
                <div class="mb-12">
                    <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200 mb-8">${p.title}</h3>
                    ${tripConfig.itineraryData.filter(day => day.phase === p.phase).map((day, index) => `
                        <div class="timeline-item grid grid-cols-[auto,1fr] gap-x-6" id="${day.id}" data-coords="${day.coords ? day.coords.join(',') : ''}">
                            <div class="flex flex-col items-center">
                                <div class="w-10 h-10 bg-white dark:bg-slate-800 rounded-full flex items-center justify-center text-xl shadow-md ring-4 ring-slate-100 dark:ring-slate-900 z-10">${day.icon}</div>
                                ${index < tripConfig.itineraryData.filter(d => d.phase === p.phase).length - 1 ? '<div class="w-0.5 h-full bg-slate-300 dark:bg-slate-600"></div>' : ''}
                            </div>
                            <div class="pb-12 opacity-0 -translate-y-4" style="animation-delay: ${index * 100}ms;">
                                <div data-day-id="${day.id}" class="itinerary-card bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 cursor-pointer transition-all">
                                    <p class="text-sm font-semibold text-blue-600 dark:text-blue-400">${(() => {
                                        const dayNumber = parseInt(day.id.replace('day-', ''));
                                        const tripDate = Utils.getTripDate(dayNumber - 1); // Restar 1 porque getTripDate espera 0-17
                                        return `Día ${dayNumber} &bull; ${Utils.formatShortDate(tripDate)}`;
                                    })()}</p>
                                    <h4 class="font-bold text-xl text-slate-900 dark:text-white mt-1">${day.title}</h4>
                                    ${day.image ? `<img loading="lazy" src="${day.image}" alt="${day.title}" class="my-4 rounded-lg aspect-video w-full object-cover pointer-events-none" onerror="this.onerror=null;this.src='https://placehold.co/1920x1080/4f46e5/ffffff?text=Imagen';">` : ''}
                                    <p class="text-slate-600 dark:text-slate-400 text-sm">${day.description}</p>
                                </div>
                            </div>
                        </div>`).join('')}
                </div>`).join('');
            container.innerHTML = `${Utils.createSectionHeader('Itinerario Detallado')}<div class="relative">${timelineHTML}</div>`;
            
            const observer = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.querySelector(':scope > div:last-child').classList.add('animate-enter');
                        const coords = entry.target.dataset.coords;
                        if (coords && AppState.map) {
                            const [lat, lng] = coords.split(',');
                            AppState.map.flyTo([lat, lng], 12, { duration: 1.5, easeLinearity: 0.5 });
                        }
                    }
                });
            }, { threshold: 0.6 });
            document.querySelectorAll('.timeline-item').forEach(item => observer.observe(item));
            
            document.querySelectorAll('.itinerary-card').forEach(card => card.addEventListener('click', (e) => {
                this.showItineraryModal(e.currentTarget.dataset.dayId);
            }));
            
            Utils.log('Sección de itinerario renderizada correctamente');
        },

        /**
         * Renderiza el calendario interactivo del viaje
         * Muestra todos los días con colores por fase y navegación al itinerario
         */
        renderCalendar(targetContainer = null) {
            Utils.log('📅 Renderizando calendario del viaje');
            // Buscar el contenedor del calendario
            let container = targetContainer || document.getElementById('calendar');
            
            // Si no hay contenedor específico, crear la sección del calendario
            if (!container) {
                const itinerarySection = document.getElementById('itinerary');
                if (itinerarySection) {
                    const calendarSection = document.createElement('section');
                    calendarSection.id = 'calendar';
                    calendarSection.className = 'mb-16';
                    calendarSection.setAttribute('data-nav', 'Calendario');
                    calendarSection.setAttribute('data-icon', 'M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z');
                    
                    // Insertar antes del itinerario
                    itinerarySection.parentNode.insertBefore(calendarSection, itinerarySection);
                    container = calendarSection;
                    
                    // Forzar la actualización de la navegación después de crear la sección
                    setTimeout(() => {
                        if (window.NavigationManager && window.NavigationManager.render) {
                            window.NavigationManager.render();
                        }
                    }, 100);
                } else {
                    Utils.error('No se pudo encontrar la sección de itinerario para crear el calendario');
                    return;
                }
            }
            
            const calendarHTML = `
                <div>
                    <h3 class="text-lg font-semibold text-slate-700 dark:text-slate-300 mb-4">Octubre 2025</h3>
                    <div class="grid grid-cols-7 gap-2 mb-8">
                        ${(() => {
                            // Usar variables regionales del dispositivo
                            const locale = navigator.language || 'es-ES';
                            const weekdays = [];
                            for (let i = 0; i < 7; i++) {
                                const date = new Date(2024, 0, i + 1); // Enero 2024
                                weekdays.push(date.toLocaleDateString(locale, { weekday: 'short' }));
                            }
                            return weekdays.map(day => 
                                `<div class="text-center text-sm font-semibold text-slate-500 dark:text-slate-400 py-2">${day}</div>`
                            ).join('');
                        })()}
                        
                        ${(() => {
                            // Generar días del calendario para octubre de 2025
                            const startDate = new Date(2025, 9, 9); // 9 de octubre de 2025
                            const daysInMonth = new Date(2025, 10, 0).getDate(); // Días en octubre
                            
                            // Calcular cuántos días vacíos hay desde el 1 de octubre hasta el 9 de octubre
                            // El 1 de octubre de 2025 es miércoles (3), el 9 es jueves (4)
                            const firstDayOfMonth = new Date(2025, 9, 1).getDay(); // Día de la semana del 1 de octubre
                            const daysToSkip = firstDayOfMonth; // Días vacíos antes del 1 de octubre
                            
                            let calendarDays = '';
                            
                            // Días vacíos antes del 1 de octubre
                            for (let i = 0; i < daysToSkip; i++) {
                                calendarDays += '<div class="h-16"></div>';
                            }
                            
                            // Días del mes
                            for (let day = 1; day <= daysInMonth; day++) {
                                const currentDate = new Date(2025, 9, day); // Octubre es mes 9 (0-indexed)
                                const tripDay = Math.floor((currentDate - startDate) / (1000 * 60 * 60 * 24));
                                
                                if (tripDay >= 0 && tripDay <= 17) { // 18 días del viaje (0-17 = 18 días)
                                    // Es un día del viaje
                                    const actualDayId = tripDay + 1; // Convertir de 0-17 a 1-18
                                    const dayData = tripConfig.itineraryData.find(d => d.id === `day-${actualDayId}`);
                                    const phases = tripConfig.calendarData.phases;
                                    const specialDays = tripConfig.calendarData.specialDays;
                                    const phase = phases.find(p => p.days.includes(actualDayId));
                                    const specialDay = specialDays.find(s => s.day === actualDayId);
                                    
                                    let dayClass = 'h-16 border border-slate-200 dark:border-slate-700 rounded-lg p-2 cursor-pointer hover:shadow-md transition-all';
                                    let dayContent = '';
                                    
                                    if (specialDay) {
                                        // Día especial con gradiente
                                        dayClass += ` bg-gradient-to-br ${specialDay.color} text-white`;
                                        dayContent = `
                                            <div class="text-center h-full flex flex-col items-center justify-center">
                                                <div class="text-lg">${specialDay.icon}</div>
                                                <div class="text-xs font-semibold">${specialDay.label}</div>
                                            </div>
                                        `;
                                    } else if (phase) {
                                        // Día normal con color de fase
                                        dayClass += ` bg-gradient-to-br ${phase.color} text-white`;
                                        dayContent = `
                                            <div class="text-center h-full flex flex-col items-center justify-center">
                                                <div class="text-lg">${dayData?.icon || '📅'}</div>
                                                <div class="text-xs font-semibold">Día ${actualDayId}</div>
                                            </div>
                                        `;
                                    }
                                    
                                    calendarDays += `<div class="${dayClass}" data-day="${tripDay}" onclick="document.getElementById('day-${actualDayId}')?.scrollIntoView({behavior: 'smooth', block: 'center'})">${dayContent}</div>`;
                                } else {
                                    // Día normal del mes
                                    calendarDays += `<div class="h-16 border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-center text-slate-400 dark:text-slate-600 flex items-center justify-center">${day}</div>`;
                                }
                            }
                            
                            return calendarDays;
                        })()}
                    </div>
                    
                    <!-- Leyenda del calendario -->
                    <div class="flex flex-wrap gap-4 text-sm">
                        ${tripConfig.calendarData.phases.map(phase => `
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-gradient-to-r ${phase.color} rounded"></div>
                                <span class="text-slate-700 dark:text-slate-300">${phase.name}</span>
                            </div>
                        `).join('')}
                        ${(() => {
                            // Generar leyenda de vuelos dinámicamente basándose en los tipos únicos
                            const uniqueFlightTypes = [...new Set(tripConfig.calendarData.specialDays.map(day => day.flightType))];
                            return uniqueFlightTypes.map(flightType => {
                                const color = flightType === 'Internacional' ? 'from-red-500 to-pink-600' :
                                             flightType === 'Regional' ? 'from-purple-500 to-indigo-600' :
                                             'from-blue-500 to-cyan-600';
                                const label = flightType === 'Internacional' ? 'Vuelos Internacionales' :
                                            flightType === 'Regional' ? 'Vuelos Regionales' :
                                            'Vuelos Locales';
                                return `
                                    <div class="flex items-center gap-2">
                                        <div class="w-4 h-4 bg-gradient-to-r ${color} rounded"></div>
                                        <span class="text-slate-700 dark:text-slate-300">${label}</span>
                                    </div>
                                `;
                            }).join('');
                        })()}
                    </div>
                </div>
            `;
            
            container.innerHTML = calendarHTML;
            Utils.log('Calendario renderizado correctamente');
        },
        showItineraryModal(dayId) {
            const day = tripConfig.itineraryData.find(d => d.id === dayId);
            if (!day) return;
            
            const modal = document.getElementById('itinerary-modal');
            const modalContent = document.getElementById('itinerary-modal-content');
            const detailItem = (icon, title, content) => content ? `<div class="flex items-start gap-4"><span class="text-2xl pt-1">${icon}</span><div><h5 class="font-semibold text-slate-800 dark:text-slate-200">${title}</h5><p class="text-sm text-slate-600 dark:text-slate-400">${content}</p></div></div>` : '';
            
            // Limpiar event listeners anteriores
            const oldCloseBtn = document.getElementById('close-modal-btn');
            if (oldCloseBtn) {
                oldCloseBtn.replaceWith(oldCloseBtn.cloneNode(true));
            }
            
            modalContent.innerHTML = `
                <!-- Botón de cierre principal -->
                <button id="close-modal-btn" class="absolute top-4 right-4 z-20 p-3 sm:p-2 rounded-full bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-400 transition-colors shadow-lg">
                    <svg class="w-6 h-6 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
                
                <img src="${day.image || 'https://placehold.co/800x400/4f46e5/ffffff?text=Himalaya'}" alt="${day.title}" class="w-full h-60 object-cover rounded-t-2xl">
                <div class="p-6">
                    <p class="text-sm font-semibold text-blue-600 dark:text-blue-400">${(() => {
                        const dayNumber = parseInt(day.id.replace('day-', ''));
                        const tripDate = Utils.getTripDate(dayNumber - 1); // Restar 1 porque getTripDate espera 0-17
                        return `Día ${dayNumber} &bull; ${Utils.formatShortDate(tripDate)}`;
                    })()}</p>
                    <h3 class="text-3xl font-bold text-slate-900 dark:text-white mt-1">${day.title}</h3>
                    <div class="mt-6 space-y-4 border-t border-slate-200 dark:border-slate-700 pt-6">
                        ${detailItem('🗺️', 'Itinerario', day.planA)}
                        ${detailItem('☕', 'Tiempo Libre', day.planB)}
                        ${detailItem('💡', 'Consejo del Día', day.consejo)}
                        ${detailItem('😋', 'Bocado del Día', day.bocado)}
                    </div>
                    ${day.coords ? `
                        <div class="mt-8 border-t border-slate-200 dark:border-slate-700 pt-6">
                            <h4 class="text-lg font-semibold text-slate-800 dark:text-slate-200 mb-4">📍 Ubicación del Día</h4>
                            <div id="modal-map-${dayId}" class="h-64 rounded-xl overflow-hidden border border-slate-200 dark:border-slate-700 flex items-center justify-center">
                                <div class="text-center">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
                                    <p class="text-sm text-slate-500">Cargando mapa...</p>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Botón de cierre adicional para móviles -->
                    <div class="mt-8 pt-6 border-t border-slate-200 dark:border-slate-700">
                        <button id="mobile-close-btn" class="w-full p-3 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 rounded-xl font-semibold transition-colors sm:hidden">
                            Cerrar
                        </button>
                    </div>
                </div>`;
            
            // Mostrar modal
            modal.classList.remove('hidden');
            
            // Event listeners
            modal.addEventListener('click', (e) => {
                if (e.target === modal) this.hideItineraryModal();
            });
            
            // Botón de cierre principal
            const closeBtn = document.getElementById('close-modal-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    this.hideItineraryModal();
                });
            }
            
            // Botón de cierre móvil
            const mobileCloseBtn = document.getElementById('mobile-close-btn');
            if (mobileCloseBtn) {
                mobileCloseBtn.addEventListener('click', () => {
                    this.hideItineraryModal();
                });
            }
            
            // Crear mapa del modal si hay coordenadas
            if (day.coords) {
                setTimeout(() => {
                    this.createModalMap(dayId, day.coords, day.title);
                }, 500);
            }
        },
        hideItineraryModal() {
            document.getElementById('itinerary-modal').classList.add('hidden');
        },
        createModalMap(dayId, coords, title) {
            Utils.log(`🗺️ Creando mapa del modal para: ${dayId}`);
            
            const mapContainer = document.getElementById(`modal-map-${dayId}`);
            if (!mapContainer) {
                Utils.error(`Contenedor del mapa no encontrado: modal-map-${dayId}`);
                return;
            }
            
            try {
                // Limpiar el contenedor
                mapContainer.innerHTML = '';
                
                // Crear el mapa
                const map = L.map(`modal-map-${dayId}`, { 
                    closePopupOnClick: false,
                    zoomControl: false,
                    attributionControl: false
                }).setView(coords, 12);
                
                // Añadir capa de tiles
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { 
                    attribution: '&copy; OpenStreetMap &copy; CARTO' 
                }).addTo(map);
                
                // Marcador principal del día
                L.marker(coords, { 
                    icon: L.divIcon({ 
                        className: 'custom-div-icon', 
                        html: `<div class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm shadow-lg border-2 border-white">📍</div>`, 
                        iconSize: [32, 32], 
                        iconAnchor: [16, 32] 
                    }) 
                }).addTo(map).bindPopup(`<b>${title}</b>`, { closeButton: false });
                
                // Añadir marcadores de lugares cercanos o relacionados
                const nearbyPlaces = this.getNearbyPlaces(coords, dayId);
                nearbyPlaces.forEach(place => {
                    L.marker(place.coords, { 
                        icon: L.divIcon({ 
                            className: 'custom-div-icon', 
                            html: `<div class="w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center text-xs shadow-md border border-white">${place.icon}</div>`, 
                            iconSize: [24, 24], 
                            iconAnchor: [12, 24] 
                        }) 
                    }).addTo(map).bindPopup(`<b>${place.name}</b><br><small>${place.description}</small>`, { closeButton: false });
                });
                
                // Ajustar vista para mostrar todos los marcadores
                if (nearbyPlaces.length > 0) {
                    const allCoords = [coords, ...nearbyPlaces.map(p => p.coords)];
                    const bounds = L.latLngBounds(allCoords);
                    map.fitBounds(bounds, { padding: [20, 20] });
                }
                
                // Forzar redibujado del mapa
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
                
                Utils.log(`✅ Mapa del modal ${dayId} creado exitosamente`);
            } catch (error) {
                Utils.error(`Error al crear mapa del modal ${dayId}:`, error);
                mapContainer.innerHTML = '<div class="h-full flex items-center justify-center text-slate-500">Error al cargar el mapa</div>';
            }
        },
        /**
         * Obtiene los lugares cercanos y relacionados para un día específico del viaje
         * @param {Array} coords - Coordenadas del lugar principal del día
         * @param {string} dayId - ID del día (ej: 'day-0', 'day-1')
         * @returns {Array} Lista de lugares cercanos con coordenadas, iconos y descripciones
         */
        getNearbyPlaces(coords, dayId) {
            // Los lugares ahora están centralizados en tripConfig.placesByDay
            return tripConfig.placesByDay[dayId] || [];
        },
        
        /**
         * Genera las opciones para vincular gastos con el presupuesto
         * @param {string} selectedCategory - Categoría seleccionada para filtrar opciones
         * @returns {string} HTML con las opciones del select
         */
        generateBudgetLinkOptions(selectedCategory = '') {
            const options = [];
            
            // Si no hay categoría seleccionada, mostrar todas las opciones
            if (!selectedCategory) {
                Object.entries(tripConfig.budgetData).forEach(([phase, items]) => {
                    items.forEach(item => {
                        if (item.subItems) {
                            // Si tiene subitems, crear opciones para cada uno
                            item.subItems.forEach(subItem => {
                                options.push(`<option value="${phase}:${item.category}:${subItem.concept}">${subItem.concept} (${Utils.formatCurrency(subItem.cost)})</option>`);
                            });
                        } else {
                            // Si no tiene subitems, crear opción para el item principal
                            options.push(`<option value="${phase}:${item.category}:${item.concept}">${item.concept} (${Utils.formatCurrency(item.cost)})</option>`);
                        }
                    });
                });
            } else {
                // Filtrar solo por la categoría seleccionada
                Object.entries(tripConfig.budgetData).forEach(([phase, items]) => {
                    items.forEach(item => {
                        if (item.category === selectedCategory) {
                            if (item.subItems) {
                                // Si tiene subitems, crear opciones para cada uno
                                item.subItems.forEach(subItem => {
                                    options.push(`<option value="${phase}:${item.category}:${subItem.concept}">${subItem.concept} (${Utils.formatCurrency(subItem.cost)})</option>`);
                                });
                            } else {
                                // Si no tiene subitems, crear opción para el item principal
                                options.push(`<option value="${phase}:${item.category}:${item.concept}">${item.concept} (${Utils.formatCurrency(item.cost)})</option>`);
                            }
                        }
                    });
                });
            }
            
            return options.join('');
        },
        
        renderBudget() {
            Utils.log('💰 Renderizando sección de presupuesto');
            const container = document.getElementById('budget');
            const allExpenses = Object.values(tripConfig.budgetData).flat();
            const allCategories = [...new Set(allExpenses.map(item => item.category))];
            const categoryOptionsHTML = allCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            
            const categoryFiltersHTML = allCategories.map(cat => {
                const icon = allExpenses.find(item => item.category === cat)?.icon || '';
                return `
                    <button data-category="${cat}" class="budget-filter-btn flex flex-col items-center justify-center gap-2 p-3 text-center bg-white dark:bg-slate-800 rounded-2xl shadow-lg ring-1 ring-slate-900/5 dark:ring-white/10 transition-all transform hover:scale-105">
                        <span class="text-3xl">${icon}</span>
                        <span class="text-xs font-semibold">${cat}</span>
                    </button>`;
            }).join('');

            container.innerHTML = `
                ${Utils.createSectionHeader('Análisis del Presupuesto')}
                <div id="budget-summary-container"></div>
                
                <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-4 mt-12">Filtrar por Categoría</h3>
                <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-4 mb-8" id="budget-category-filters">${categoryFiltersHTML}</div>
                
                <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-6">Desglose de Gastos</h3>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6" id="budget-breakdown-container"></div>
                
                <div class="mt-12">
                    <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-6">Seguimiento de Gastos vs. Presupuesto</h3>
                    <div id="budget-comparison-container"></div>
                </div>
                
                <div class="mt-12">
                    <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-6">Añadir Nuevo Gasto</h3>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                        <form id="expense-form" class="grid grid-cols-1 lg:grid-cols-5 gap-4 items-end mb-6">
                            <div class="lg:col-span-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div><label for="expense-concept" class="text-xs font-semibold">Concepto</label><input type="text" id="expense-concept" required class="w-full mt-1 p-2 rounded-lg bg-slate-100 dark:bg-slate-700 border-transparent focus:ring-2 focus:ring-blue-500"></div>
                                <div><label for="expense-amount" class="text-xs font-semibold">Cantidad (€)</label><input type="number" id="expense-amount" step="0.01" required class="w-full mt-1 p-2 rounded-lg bg-slate-100 dark:bg-slate-700 border-transparent focus:ring-2 focus:ring-blue-500"></div>
                                <div><label for="expense-category" class="text-xs font-semibold">Categoría</label><select id="expense-category" required class="w-full mt-1 p-2 rounded-lg bg-slate-100 dark:bg-slate-700 border-transparent focus:ring-2 focus:ring-blue-500">${categoryOptionsHTML}</select></div>
                                <div><label for="expense-budget-link" class="text-xs font-semibold">Presupuesto</label><select id="expense-budget-link" class="w-full mt-1 p-2 rounded-lg bg-slate-100 dark:bg-slate-700 border-transparent focus:ring-2 focus:ring-blue-500"><option value="">Sin vincular</option>${this.generateBudgetLinkOptions()}</select></div>
                            </div>
                            <div class="lg:col-span-1 space-y-2">
                            <button type="submit" class="w-full p-2 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700">Añadir</button>
        
                            </div>
                        </form>
                        <div id="expense-list" class="space-y-2"></div>
                    </div>
                </div>`;

            document.getElementById('budget-category-filters').addEventListener('click', (e) => {
                const btn = e.target.closest('.budget-filter-btn');
                if (!btn) return;
                
                const category = btn.dataset.category;
                btn.classList.toggle('ring-2');
                btn.classList.toggle('ring-blue-500');
                btn.classList.toggle('dark:ring-blue-400');

                if (AppState.activeBudgetCategories.has(category)) {
                    AppState.activeBudgetCategories.delete(category);
                } else {
                    AppState.activeBudgetCategories.add(category);
                }
                this.updateBudgetViews();
            });

            // Event listener para actualizar opciones de presupuesto cuando cambie la categoría
            document.getElementById('expense-category').addEventListener('change', (e) => {
                const selectedCategory = e.target.value;
                const budgetLinkSelect = document.getElementById('expense-budget-link');
                const currentValue = budgetLinkSelect.value;
                
                // Actualizar opciones
                budgetLinkSelect.innerHTML = `<option value="">Sin vincular</option>${this.generateBudgetLinkOptions(selectedCategory)}`;
                
                // Mantener el valor seleccionado si sigue siendo válido
                if (currentValue && budgetLinkSelect.querySelector(`option[value="${currentValue}"]`)) {
                    budgetLinkSelect.value = currentValue;
                }
            });

            document.getElementById('expense-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const concept = document.getElementById('expense-concept').value;
                const amount = parseFloat(document.getElementById('expense-amount').value);
                const category = document.getElementById('expense-category').value;
                
                if (concept && amount > 0 && category) {
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const editId = submitBtn.dataset.editId;
                    const budgetLink = document.getElementById('expense-budget-link').value;
                    
                    if (editId) {
                        // Actualizar gasto existente
                        ExpenseManager.update(editId, { concept, amount, category, budgetLink });
                        // NO cancelar edición - mantener modo edición activo
                        Utils.log(`✅ Gasto actualizado, modo edición mantenido para más cambios`);
                    } else {
                        // Añadir nuevo gasto
                        ExpenseManager.add({ concept, amount, category, budgetLink });
                    e.target.reset();
                    }
                    
                    // Actualizar la lista de gastos para mostrar cambios visuales
                    ExpenseManager.renderList();
                    this.updateBudgetViews();
                }
            });



            // Event listener para eliminar gastos (prioridad alta)
            document.getElementById('expense-list').addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-expense-btn');
                if (deleteBtn) {
                    e.preventDefault();
                    e.stopPropagation();
                    const id = deleteBtn.dataset.id;
                    Utils.log(`🗑️ Botón eliminar clickeado para gasto: ${id}`);
                    ExpenseManager.remove(id);
                    // Actualizar la lista de gastos para mostrar cambios visuales
                    ExpenseManager.renderList();
                    this.updateBudgetViews();
                    return;
                }
                
                // Event listener para editar gastos
                const expenseItem = e.target.closest('.expense-item');
                if (expenseItem) {
                    const id = expenseItem.dataset.expenseId;
                    ExpenseManager.editExpense(id);
                }
            });

            this.updateBudgetViews();
        },
        updateBudgetViews() {
            const summaryContainer = document.getElementById('budget-summary-container');
            const breakdownContainer = document.getElementById('budget-breakdown-container');
            const comparisonContainer = document.getElementById('budget-comparison-container');
            const hasActiveFilters = AppState.activeBudgetCategories.size > 0;
            
            const expensesToProcess = hasActiveFilters 
                ? Object.values(tripConfig.budgetData).flat().filter(item => AppState.activeBudgetCategories.has(item.category))
                : Object.values(tripConfig.budgetData).flat();
            
            const filteredTotal = Utils.calculateSubtotal(expensesToProcess);

            summaryContainer.innerHTML = `
                <div class="bg-blue-600 dark:bg-blue-500 text-white p-8 rounded-2xl shadow-2xl shadow-blue-500/30 text-center">
                    <p class="text-lg font-medium opacity-80">${hasActiveFilters ? 'Coste Total Filtrado' : 'Coste Total Estimado'}</p>
                    <p class="text-5xl font-black tracking-tight">${Utils.formatCurrency(filteredTotal, true)}</p>
                </div>`;
            
            const filteredData = { vuelos: [], nepal: [], butan: [] };
            Object.entries(tripConfig.budgetData).forEach(([key, items]) => {
                filteredData[key] = items.filter(item => !hasActiveFilters || AppState.activeBudgetCategories.has(item.category));
            });

            const titles = { vuelos: "Vuelos", nepal: "Tour Nepal", butan: "Tour Bután" };
            const breakdownHTML = Object.entries(filteredData).map(([key, items]) => {
                if (items.length === 0) return '';
                const subtotal = Utils.calculateSubtotal(items);
                return `
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                        <div class="flex justify-between items-center mb-4 border-b border-slate-200 dark:border-slate-700 pb-4">
                            <h4 class="text-lg font-bold">${titles[key]}</h4>
                            <span class="font-bold text-blue-600 dark:text-blue-400">${Utils.formatCurrency(subtotal)}</span>
                        </div>
                        <ul class="space-y-3">
                            ${items.map(item => `
                                <li>
                                    <div class="flex justify-between items-start">
                                        <div class="flex items-center gap-3">
                                            <span class="text-xl">${item.icon}</span>
                                            <div>
                                                <p class="font-medium text-sm">${item.concept}</p>
                                                <p class="text-xs text-slate-500">${item.category}</p>
                                            </div>
                                        </div>
                                        <p class="font-semibold text-sm whitespace-nowrap">${Utils.formatCurrency(item.cost || Utils.calculateSubtotal(item.subItems || []))}</p>
                                    </div>
                                    ${item.subItems ? `<ul class="mt-2 pl-9 space-y-2 text-xs text-slate-500 dark:text-slate-400">
                                        ${item.subItems.map(sub => `<li class="flex justify-between"><span>- ${sub.concept}</span><span>${Utils.formatCurrency(sub.cost)}</span></li>`).join('')}
                                    </ul>` : ''}
                                </li>`).join('')}
                        </ul>
                    </div>`;
            }).join('');

            breakdownContainer.innerHTML = breakdownHTML || `<p class="text-center text-slate-500 col-span-full">No hay gastos para la selección actual.</p>`;

            const allExpenses = Object.values(tripConfig.budgetData).flat();
            const allCategories = [...new Set(allExpenses.map(item => item.category))];
            const comparisonHTML = allCategories.map(category => {
                const budgeted = Utils.calculateSubtotal(allExpenses.filter(i => i.category === category));
                const spent = ExpenseManager.getCategoryTotal(category);
                const percentage = budgeted > 0 ? Math.min((spent / budgeted) * 100, 100) : 0;
                const isOverBudget = spent > budgeted;
                const icon = allExpenses.find(item => item.category === category)?.icon || '💰';

                return `
                    <div class="budget-tracking-card flex flex-col items-center justify-center gap-3 p-4 text-center bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 transition-all hover:scale-105">
                        <span class="text-3xl">${icon}</span>
                        <div class="text-center">
                            <p class="text-xs font-semibold text-slate-700 dark:text-slate-300">${category}</p>
                            <p class="text-lg font-bold ${isOverBudget ? 'text-red-600 dark:text-red-400' : 'text-blue-600 dark:text-blue-400'}">${Utils.formatCurrency(spent)}</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">de ${Utils.formatCurrency(budgeted)}</p>
                        </div>
                        <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2">
                            <div class="h-2 rounded-full ${isOverBudget ? 'bg-red-500' : 'bg-blue-600'}" style="width: ${percentage}%"></div>
                        </div>
                        ${isOverBudget ? `<p class="text-xs text-red-500 font-semibold">¡+${Utils.formatCurrency(spent - budgeted)}!</p>` : ''}
                    </div>
                `;
            }).join('');
            comparisonContainer.innerHTML = `<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">${comparisonHTML}</div>`;
            
            ExpenseManager.renderList();
        },
        
        /**
         * Actualiza el indicador visual del formulario
         * Muestra si está en modo creación o edición
         */
        updateFormIndicator() {
            const submitBtn = document.querySelector('#expense-form button[type="submit"]');
            const formTitle = document.querySelector('#expense-form h3');
            const currentEditId = submitBtn?.dataset.editId;
            
            if (currentEditId) {
                const expense = AppState.expenses.find(exp => exp.id === currentEditId);
                if (formTitle && expense) {
                    formTitle.textContent = `✏️ Editando: ${expense.concept}`;
                    formTitle.className = 'text-xl font-bold text-blue-600 dark:text-blue-400 mb-4';
                }
            } else {
                if (formTitle) {
                    formTitle.textContent = '➕ Añadir Nuevo Gasto';
                    formTitle.className = 'text-xl font-bold text-slate-900 dark:text-white mb-4';
                }
            }
        },

        renderWeather() {
            Utils.log('🌤️ Renderizando sección de clima');
            const container = document.getElementById('weather');
            const locationsHTML = tripConfig.weatherData.filter(w => w.dayTemp).map(w => `<div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 text-center"><p class="text-4xl mb-2">${w.icon}</p><p class="text-lg font-semibold">${w.location}</p><div class="mt-2"><p class="text-2xl font-bold text-blue-500">${w.dayTemp}</p><p class="text-slate-500 text-sm">Día / Noche: ${w.nightTemp}</p></div></div>`).join('');
            const generalInfo = tripConfig.weatherData.find(w => !w.dayTemp);
            const generalInfoHTML = generalInfo ? `<div class="md:col-span-3 bg-blue-50 dark:bg-slate-800/50 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 text-center flex items-center justify-center gap-4"><p class="text-4xl">${generalInfo.icon}</p><div><p class="text-lg font-semibold">${generalInfo.location}</p><p class="text-slate-600 dark:text-slate-300 mt-1">${generalInfo.description}</p></div></div>` : '';
            container.innerHTML = `${Utils.createSectionHeader('Clima Estimado (Octubre)')}<div class="grid grid-cols-1 md:grid-cols-3 gap-6">${locationsHTML}${generalInfoHTML}</div>`;
        },
        renderPackingList() {
            Utils.log('🎒 Renderizando lista de equipaje');
            const container = document.getElementById('packing-list');
            const saved = JSON.parse(localStorage.getItem('packingListV2')) || {};
            const listHTML = Object.entries(tripConfig.packingListData).map(([category, items]) => `<div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700"><h3 class="font-bold text-lg text-blue-600 dark:text-blue-400 mb-4">${category}</h3><ul class="space-y-3">${items.map((item, index) => { const id = `${category.replace(/\s+/g, '-')}-${index}`; return `<li class="flex items-center"><input type="checkbox" id="${id}" data-item-id="${id}" ${saved[id] ? 'checked' : ''} class="peer h-5 w-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600"><label for="${id}" class="ml-3 text-sm text-slate-700 dark:text-slate-300 transition-colors peer-checked:line-through peer-checked:text-slate-400 dark:peer-checked:text-slate-500">${item}</label></li>`; }).join('')}</ul></div>`).join('');
            container.innerHTML = `${Utils.createSectionHeader('Lista de Equipaje Esencial')}<div class="grid grid-cols-1 md:grid-cols-2 gap-6">${listHTML}</div>`;
            container.addEventListener('change', e => {
                if (e.target.matches('input[type="checkbox"]')) {
                    saved[e.target.dataset.itemId] = e.target.checked;
                    localStorage.setItem('packingListV2', JSON.stringify(saved));
                }
            });
        }
    };

/**
 * Gestor de gastos del viaje
 * Maneja la creación, edición, eliminación y persistencia de gastos
 */
const ExpenseManager = {
    /**
     * Guarda los gastos en localStorage
     * Persiste los datos entre sesiones del navegador
     */
        save() {
        AppState.saveAllData();
        },

    /**
     * Añade un nuevo gasto a la lista
     * @param {Object} expense - Objeto con concept, amount y category
     */
        add(expense) {
        Utils.log(`➕ Añadiendo nuevo gasto: ${expense.concept}`);
        AppState.expenses.push({ ...expense, id: Date.now().toString() });
            this.save();
        Utils.log(`✅ Gasto añadido exitosamente: ${expense.concept} - ${Utils.formatCurrency(expense.amount)}`);
        
        // Actualizar la lista de gastos para mostrar cambios visuales
        this.renderList();
        },

    /**
     * Elimina un gasto por su ID
     * @param {string} id - ID único del gasto a eliminar
     */
        remove(id) {
            Utils.log(`🗑️ Eliminando gasto con ID: ${id}`);
            const expense = AppState.expenses.find(exp => exp.id === id);
            
            if (!expense) {
                Utils.error(`❌ No se encontró gasto con ID: ${id} para eliminar`);
                return;
            }
            
            Utils.log(`🗑️ Eliminando gasto: ${expense.concept} - ${Utils.formatCurrency(expense.amount)}`);
            
            // Eliminar el gasto del array
            AppState.expenses = AppState.expenses.filter(exp => exp.id !== id);
            
            // Guardar en localStorage
            this.save();
            
            // Si se eliminó el gasto que se estaba editando, cancelar edición
            const submitBtn = document.querySelector('#expense-form button[type="submit"]');
            if (submitBtn && submitBtn.dataset.editId === id) {
                Utils.log(`🔄 Cancelando edición automáticamente tras eliminar gasto en edición`);
                this.cancelEdit();
            }
            
            Utils.log(`✅ Gasto eliminado exitosamente: ${expense.concept}`);
            
            // Actualizar la lista de gastos para mostrar cambios visuales
            this.renderList();
        },

    /**
     * Inicia o cancela la edición de un gasto (toggle)
     * @param {string} id - ID del gasto a editar
     */
    editExpense(id) {
        Utils.log(`🎯 editExpense llamado con ID: ${id}`);
        const submitBtn = document.querySelector('#expense-form button[type="submit"]');
        const currentEditId = submitBtn?.dataset.editId;
        Utils.log(`📝 Estado actual del formulario - editId: ${currentEditId || 'ninguno'}`);
        
        // Si ya estamos editando este mismo gasto, cancelar edición (toggle off)
        if (currentEditId === id) {
            Utils.log(`🔄 Ya estamos editando este gasto: ${id}. Cancelando edición (toggle off)`);
            this.cancelEdit();
            return;
        }
        
        // Buscar el gasto a editar
        const expense = AppState.expenses.find(exp => exp.id === id);
        if (!expense) {
            Utils.error(`❌ No se encontró gasto con ID: ${id} para editar`);
            return;
        }
        
        Utils.log(`✏️ Cargando gasto para editar: ${id} - ${expense.concept}`);
        
        const conceptInput = document.getElementById('expense-concept');
        const amountInput = document.getElementById('expense-amount');
        const categorySelect = document.getElementById('expense-category');
        const budgetLinkSelect = document.getElementById('expense-budget-link');
        
        // Llenar formulario con datos del gasto
        conceptInput.value = expense.concept;
        amountInput.value = expense.amount;
        categorySelect.value = expense.category;
        if (budgetLinkSelect && expense.budgetLink) {
            budgetLinkSelect.value = expense.budgetLink;
        }
        
        // Cambiar el botón a "Actualizar Gasto"
        submitBtn.textContent = 'Actualizar ';
        submitBtn.dataset.editId = id;
        

        
        // Hacer scroll al formulario
        document.getElementById('expense-form').scrollIntoView({ behavior: 'smooth' });
        
        Utils.log(`✅ Formulario preparado para editar: ${expense.concept}`);
        
        // Actualizar indicador visual del formulario
        if (window.UIRenderer && window.UIRenderer.updateFormIndicator) {
            window.UIRenderer.updateFormIndicator();
        }
        
        // Actualizar la lista para mostrar el estado visual
        this.renderList();
    },

    /**
     * Actualiza un gasto existente
     * @param {string} id - ID del gasto a actualizar
     * @param {Object} updatedExpense - Nuevos datos del gasto
     */
    update(id, updatedExpense) {
        Utils.log(`✏️ Actualizando gasto con ID: ${id}`);
        const index = AppState.expenses.findIndex(exp => exp.id === id);
        if (index !== -1) {
            AppState.expenses[index] = { ...AppState.expenses[index], ...updatedExpense };
            this.save();
            Utils.log(`✅ Gasto actualizado exitosamente: ${updatedExpense.concept}`);
            
            // Mantener el modo edición activo para permitir más cambios
            Utils.log(`🔄 Manteniendo modo edición activo para el gasto: ${updatedExpense.concept}`);
            
            // Actualizar la lista de gastos para mostrar cambios visuales
            this.renderList();
        } else {
            Utils.error(`❌ No se encontró gasto con ID: ${id} para actualizar`);
        }
    },

    /**
     * Cancela el modo de edición y restaura el formulario
     * Limpia todos los campos y restaura el botón original
     */
    cancelEdit() {
        Utils.log('🔄 Cancelando edición y restaurando formulario a modo creación');
        
        // Restaurar botón original
        const submitBtn = document.querySelector('#expense-form button[type="submit"]');
        if (submitBtn) {
            submitBtn.textContent = 'Añadir Gasto';
            delete submitBtn.dataset.editId;
        }
        

        
        // Limpiar formulario
        const form = document.getElementById('expense-form');
        if (form) {
            form.reset();
        }
        
        Utils.log('✅ Formulario restaurado a modo creación');
        
        // Actualizar indicador visual del formulario
        if (window.UIRenderer && window.UIRenderer.updateFormIndicator) {
            window.UIRenderer.updateFormIndicator();
        }
        
        // Actualizar la lista para quitar el resaltado
        this.renderList();
    },

    /**
     * Calcula el total de todos los gastos
     * @returns {number} Suma total de todos los gastos
     */
        getTotal() {
        return AppState.expenses.reduce((sum, exp) => sum + exp.amount, 0);
    },

    /**
     * Calcula el total de gastos por categoría
     * @param {string} category - Categoría a calcular
     * @returns {number} Suma total de gastos en esa categoría
     */
        getCategoryTotal(category) {
        return AppState.expenses.filter(exp => exp.category === category).reduce((sum, exp) => sum + exp.amount, 0);
    },

            /**
         * Encuentra un item del presupuesto por fase, categoría y concepto
         * @param {string} phase - Fase del viaje (vuelos, nepal, butan)
         * @param {string} category - Categoría del presupuesto
         * @param {string} concept - Concepto específico
         * @returns {Object|null} Item del presupuesto o null si no se encuentra
         */
        findBudgetItem(phase, category, concept) {
            if (!tripConfig.budgetData[phase]) return null;
            
            const categoryItems = tripConfig.budgetData[phase].filter(item => item.category === category);
            if (categoryItems.length === 0) return null;
            
            // Buscar en items principales
            let item = categoryItems.find(item => item.concept === concept);
            if (item) return item;
            
            // Buscar en subitems
            for (const categoryItem of categoryItems) {
                if (categoryItem.subItems) {
                    item = categoryItem.subItems.find(subItem => subItem.concept === concept);
                    if (item) return item;
                }
            }
            
            return null;
        },
        
        /**
         * Renderiza la lista de gastos en la interfaz
         * Muestra todos los gastos con opciones de editar y eliminar
         */
        renderList() {
            const listContainer = document.getElementById('expense-list');
            if (AppState.expenses.length === 0) {
                listContainer.innerHTML = `<p class="text-center text-sm text-slate-500 py-4">Aún no has añadido ningún gasto.</p>`;
                return;
            }
            
            // Obtener el ID del gasto que se está editando actualmente
            const submitBtn = document.querySelector('#expense-form button[type="submit"]');
            const currentEditId = submitBtn?.dataset.editId;
            
            Utils.log(`🔄 Renderizando lista de gastos. Gasto en edición: ${currentEditId || 'ninguno'}`);
            
            // Generar HTML para cada gasto con botones de acción
            listContainer.innerHTML = AppState.expenses.map(exp => {
            let budgetComparison = '';
            
            // Si el gasto está vinculado con el presupuesto, mostrar comparación
            if (exp.budgetLink) {
                const [phase, category, concept] = exp.budgetLink.split(':');
                const budgetItem = this.findBudgetItem(phase, category, concept);
                
                if (budgetItem) {
                    const budgetAmount = budgetItem.cost;
                    const difference = exp.amount - budgetAmount;
                    const isOverBudget = difference > 0;
                    const isUnderBudget = difference < 0;
                    
                    budgetComparison = `
                        <div class="text-xs text-slate-500 mt-1">
                            <span class="font-medium">Presupuesto:</span> ${Utils.formatCurrency(budgetAmount)}
                            ${isOverBudget ? `<span class="text-red-500 font-medium"> (+${Utils.formatCurrency(difference)})</span>` : ''}
                            ${isUnderBudget ? `<span class="text-green-500 font-medium"> (${Utils.formatCurrency(difference)})</span>` : ''}
                        </div>
                    `;
                }
            }
            
            const isCurrentlyEditing = currentEditId === exp.id;
            const editButtonText = isCurrentlyEditing ? '🔄' : '✏️';
            const editButtonTitle = isCurrentlyEditing ? 'Cancelar edición' : 'Editar';
            const editButtonClass = isCurrentlyEditing 
                ? 'edit-expense-btn text-blue-500 hover:text-blue-600 text-lg leading-none p-1 font-bold' 
                : 'edit-expense-btn text-slate-400 hover:text-blue-500 text-lg leading-none p-1';
            
            return `
                <div class="expense-item flex items-center justify-between p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700/50 cursor-pointer transition-all ${isCurrentlyEditing ? 'bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-500' : ''}" data-expense-id="${exp.id}">
                    <div class="flex-1">
                        <p class="text-sm font-medium ${isCurrentlyEditing ? 'text-blue-700 dark:text-blue-300' : ''}">${exp.concept} ${isCurrentlyEditing ? '✏️' : ''}</p>
                        <p class="text-xs text-slate-500">${exp.category}</p>
                        ${budgetComparison}
                    </div>
                    <div class="flex items-center gap-4">
                        <p class="font-semibold text-sm">${Utils.formatCurrency(exp.amount)}</p>
                        <div class="flex items-center gap-2">
                            <button data-id="${exp.id}" class="delete-expense-btn text-slate-400 hover:text-red-500 text-xl leading-none" title="Eliminar">&times;</button>
                    </div>
                    </div>
                </div>`;
        }).join('');
    }
};

// ===== INICIALIZACIÓN DE LA APLICACIÓN =====
/**
 * Clase principal de la aplicación
 * Coordina la inicialización de todos los managers y sistemas
 */
const App = {
    /**
     * Inicializa la aplicación completa
     * Configura todos los managers y sistemas en el orden correcto
     */
    async init() {
        Utils.log('🚀 Iniciando aplicación Himalaya Adventure');
        
        try {
            // Inicializar todos los managers en orden de dependencia
            ThemeManager.init();        // Tema (debe ir primero para UI)
            SidebarManager.init();      // Navegación lateral
            ParallaxManager.init();     // Efectos de scroll
            NavigationManager.init();   // Navegación entre secciones
            PDFExporter.init();         // Exportación de PDF
            UIRenderer.init();          // Renderizado de UI (debe ir último)
            
            // Configurar observadores de intersección para animaciones
            this.setupIntersectionObserver();
            
            // Actualizar subtítulos dinámicos
            setTimeout(() => {
                const totalDays = tripConfig.calendarData.getTotalDays();
                const sidebarSubtitle = document.getElementById('sidebar-subtitle');
                const heroSubtitle = document.getElementById('hero-subtitle');
                
                if (sidebarSubtitle) {
                    sidebarSubtitle.textContent = `Un recorrido de ${totalDays} días para descubrir Nepal y Bután.`;
                }
                if (heroSubtitle) {
                    heroSubtitle.textContent = `Un recorrido de ${totalDays} días para descubrir Nepal y Bután.`;
                }
                
                Utils.log(`Subtítulos actualizados con ${totalDays} días`);
            }, 500);
            
            // Inicializar todas las secciones como expandidas
            setTimeout(() => {
                Utils.initializeSections();
            }, 1000);
            
            // Fallback de seguridad: asegurar que todas las secciones sean visibles
            // Útil si hay problemas con el Intersection Observer
            setTimeout(() => {
                document.querySelectorAll('section').forEach(section => {
                    if (section.style.opacity === '0') {
                        Utils.log(`Fallback: haciendo visible sección ${section.id}`);
                        section.style.opacity = '1';
                        section.style.transform = 'translateY(0)';
                    }
                });
            }, 3000);
            
            Utils.log('✅ Aplicación iniciada correctamente');
        } catch (error) {
            Utils.error('Error al inicializar la aplicación:', error);
        }
    },

    /**
     * Configura el Intersection Observer para animaciones de entrada
     * Hace que las secciones aparezcan con animación al hacer scroll
     */
    setupIntersectionObserver() {
        Utils.log('Configurando Intersection Observer para animaciones');
        
        // Observer que detecta cuando las secciones entran en el viewport
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    // Hacer visible la sección con animación
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                    Utils.log(`Sección ${entry.target.id} ahora visible`);
                }
            });
        }, { threshold: 0.1 }); // Se activa cuando el 10% de la sección es visible

        // Configurar todas las secciones para animaciones
        const sections = document.querySelectorAll('section');
        Utils.log(`Encontradas ${sections.length} secciones para animar`);
        
        sections.forEach(section => {
            // Estado inicial: invisible y desplazada hacia abajo
            section.style.opacity = '0';
            section.style.transform = 'translateY(20px)';
            section.style.transition = 'all 0.6s ease-out';
            
            // Observar la sección para animaciones
            observer.observe(section);
            
            // Timeout de seguridad: forzar visibilidad si hay problemas con el observer
            setTimeout(() => {
                if (section.style.opacity === '0') {
                    Utils.log(`Forzando visibilidad de sección ${section.id}`);
                    section.style.opacity = '1';
                    section.style.transform = 'translateY(0)';
                }
            }, 2000); // 2 segundos de timeout
        });
    }
};
</script>

<!-- Bloque 3: Inicializador (main.js) -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    App.init();
    
    // Funcionalidad PWA
    setTimeout(() => {
        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => Utils.log('📱 Service Worker registrado'))
                .catch(err => Utils.error('❌ Error SW:', err));
        }
        
        // Prompt de instalación PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Mostrar prompt después de 5 segundos
            setTimeout(() => {
                const installDiv = document.createElement('div');
                installDiv.className = 'fixed bottom-4 right-4 bg-blue-600 text-white p-4 rounded-lg shadow-lg z-50 max-w-sm';
                installDiv.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">📱</span>
                        <div class="flex-1">
                            <p class="font-semibold text-sm">¡Instala la app!</p>
                            <p class="text-xs opacity-90">Úsala sin conexión</p>
                        </div>
                        <div class="flex flex-col gap-1">
                            <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove(); deferredPrompt.prompt()" class="bg-white text-blue-600 px-3 py-1 rounded text-xs font-medium">
                                Instalar
                            </button>
                            <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove()" class="text-white/70 text-xs">
                                Ahora no
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(installDiv);
                
                // Auto-remove después de 15 segundos
                setTimeout(() => {
                    if (document.body.contains(installDiv)) installDiv.remove();
                }, 15000);
            }, 5000);
        });
        
        // Auto-guardado mejorado
        setInterval(() => AppState.saveAllData(), 30000);
        window.addEventListener('beforeunload', () => AppState.saveAllData());
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') AppState.saveAllData();
        });
        
        Utils.log('📱 PWA configurada');
    }, 2000);
});
</script>

</body>
</html>
