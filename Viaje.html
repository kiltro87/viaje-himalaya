<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <title>Mi Aventura en el Himalaya</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Viaje NB">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json" crossorigin="use-credentials">
    <script>
        // Only load manifest on HTTP/HTTPS protocols to prevent CORS errors
        if (location.protocol === 'file:') {
            // Remove manifest link for local file usage
            document.querySelector('link[rel="manifest"]')?.remove();
        }
    </script>
    
    <!-- Favicon/Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%233b82f6'%3E%3Cpath d='M12 2L2 7v10c0 5.55 3.84 9.739 9 11 5.16-1.261 9-5.45 9-11V7l-10-5z'/%3E%3Cpath d='M12 6L6 9v6c0 3.33 2.31 5.85 6 6.6 3.69-.75 6-3.27 6-6.6V9l-6-3z' fill='white'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%233b82f6'%3E%3Cpath d='M12 2L2 7v10c0 5.55 3.84 9.739 9 11 5.16-1.261 9-5.45 9-11V7l-10-5z'/%3E%3Cpath d='M12 6L6 9v6c0 3.33 2.31 5.85 6 6.6 3.69-.75 6-3.27 6-6.6V9l-6-3z' fill='white'/%3E%3C/svg%3E">
    
    <!-- Tailwind CSS -->
    <!-- 
        DEVELOPMENT: Using CDN for quick development
        PRODUCTION: Install Tailwind CSS as a PostCSS plugin or use the Tailwind CLI
        See: https://tailwindcss.com/docs/installation
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
    
    <!-- LeafletJS for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>

    <!-- PDF Export & Chart Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>


    <!-- Custom Styles & Tailwind Config -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        .dark ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #64748b; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        /* Theme Toggle Button Styles */
        .theme-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(226, 232, 240, 0.8);
            border-radius: 0.75rem;
            padding: 0.75rem;
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
        }
        
        .dark .theme-toggle {
            background: rgba(30, 41, 59, 0.9);
            border-color: rgba(51, 65, 85, 0.8);
        }
        
        .theme-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .theme-toggle .icon {
            width: 1.5rem;
            height: 1.5rem;
            transition: all 0.2s ease;
        }
        
        /* Sidebar Styles */
        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 18rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(226, 232, 240, 0.8);
            z-index: 40;
            transition: transform 0.3s ease-in-out;
            overflow-y: auto;
        }
        
        .dark #sidebar {
            background: rgba(30, 41, 59, 0.95);
            border-right-color: rgba(51, 65, 85, 0.8);
        }
        
        #sidebar.is-hidden {
            transform: translateX(-100%);
        }
        
        #sidebar-toggle {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 50;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(226, 232, 240, 0.8);
            border-radius: 0.75rem;
            padding: 0.75rem;
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
        }
        
        .dark #sidebar-toggle {
            background: rgba(30, 41, 59, 0.9);
            border-color: rgba(51, 65, 85, 0.8);
        }
        
        #sidebar-toggle:hover {
            transform: scale(1.05);
        }
        
        /* Main content adjustment for sidebar */
        #main-content {
            margin-left: 0;
            transition: margin-left 0.3s ease-in-out;
        }
        
        @media (min-width: 1024px) {
            #main-content.lg\:ml-72 {
                margin-left: 18rem;
            }
        }
        
        /* Bottom Navigation Styles */
        #bottom-nav {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            border-top: 1px solid rgba(226, 232, 240, 0.8);
        }
        
        .dark #bottom-nav {
            background: rgba(30, 41, 59, 0.95);
            border-top: 1px solid rgba(51, 65, 85, 0.8);
        }
        
        .nav-item {
            transition: all 0.3s ease;
            border-radius: 1rem;
            position: relative;
        }
        
        .nav-item:hover {
            color: rgb(59 130 246) !important;
            background: rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
        }
        
        .dark .nav-item:hover {
            color: rgb(147 197 253) !important;
            background: rgba(59, 130, 246, 0.2);
        }
        
        .nav-item.active {
            color: rgb(59 130 246) !important;
            background: rgba(59, 130, 246, 0.15);
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }
        
        .dark .nav-item.active {
            color: rgb(147 197 253) !important;
            background: rgba(59, 130, 246, 0.25);
        }
        
        .nav-item.active .material-symbols-outlined {
            transform: scale(1.1);
            color: rgb(59 130 246) !important;
        }
        
        .dark .nav-item.active .material-symbols-outlined {
            color: rgb(147 197 253) !important;
        }
        
        /* Main content padding for bottom nav */
        main {
            padding-bottom: 120px;
        }
        
        .custom-div-icon { transition: transform 0.2s ease-in-out; }
        .custom-div-icon:hover { transform: scale(1.2); }

        /* Estilos para el modal del itinerario */
        #itinerary-modal.hidden { display: none; }
        .leaflet-popup-content-wrapper { border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .leaflet-popup-content { margin: 0; width: auto !important; }
        .leaflet-popup-close-button { top: 8px; right: 8px; color: #64748b; }
        .expense-paid { text-decoration: line-through; color: #9ca3af; }
        .expense-paid .editable-cost { color: #16a34a; text-decoration: none; font-weight: 600; }
        
        /* Estilos para secciones colapsables */
        .collapsible-section {
            overflow: visible;
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        
        /* Solo aplicar overflow hidden durante la animaci√≥n de colapso */
        .collapsible-section.collapsed {
            overflow: hidden;
        }
        
        /* Asegurar que las tarjetas tengan espacio suficiente para sus bordes */
        .bg-white.dark\\:bg-slate-800 {
            margin: 2px;
        }
        

        
        .collapsible-section.collapsed {
            max-height: 0 !important;
            opacity: 0 !important;
        }
        
        .collapsible-section.expanded {
            opacity: 1 !important;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    keyframes: {
                        'enter': {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        'modal-in': {
                            '0%': { transform: 'scale(0.95)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        }
                    },
                    animation: { 
                        'enter': 'enter 0.5s ease-out forwards',
                        'modal-in': 'modal-in 0.2s ease-out forwards',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 transition-colors duration-300">





        <!-- Bottom Navigation -->
    <nav id="bottom-nav" class="fixed bottom-4 left-1/2 -translate-x-1/2 w-[95%] max-w-sm h-20 bg-white/90 dark:bg-slate-800/90 backdrop-blur-xl border border-slate-200 dark:border-slate-700 z-40 grid grid-cols-5 rounded-3xl shadow-2xl shadow-slate-300/30 dark:shadow-black/30">
        <button id="nav-summary" class="nav-item flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 w-full h-full transition-all duration-200" data-view="summary">
            <span class="material-symbols-outlined text-2xl">dashboard</span>
            <span class="text-xs font-medium">Resumen</span>
        </button>
        <button id="nav-itinerary" class="nav-item flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 w-full h-full transition-all duration-200" data-view="itinerary">
            <span class="material-symbols-outlined text-2xl">list_alt</span>
            <span class="text-xs font-medium">Itinerario</span>
        </button>
        <button id="nav-today" class="nav-item flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 w-full h-full transition-all duration-200" data-view="today">
            <span class="material-symbols-outlined text-2xl">today</span>
            <span class="text-xs font-medium">Hoy</span>
        </button>
        <button id="nav-map" class="nav-item flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 w-full h-full transition-all duration-200" data-view="map">
            <span class="material-symbols-outlined text-2xl">map</span>
            <span class="text-xs font-medium">Mapa</span>
        </button>
        <button id="nav-tools" class="nav-item flex flex-col items-center justify-center gap-1 text-slate-500 dark:text-slate-400 w-full h-full transition-all duration-200" data-view="tools">
            <span class="material-symbols-outlined text-2xl">construction</span>
            <span class="text-xs font-medium">Herramientas</span>
        </button>
    </nav>

    <!-- Main Container -->
    <div class="relative min-h-screen">

        <!-- Main Content -->
        <main id="main-content" class="flex-1">

            <div class="w-full max-w-none lg:max-w-6xl xl:max-w-7xl mx-auto space-y-8 md:space-y-12 lg:space-y-16 p-3 sm:p-4 md:p-6 lg:p-8 xl:p-12">
                <!-- Panel "Hoy" Din√°mico -->
                <section id="today-panel" class="bg-white dark:bg-slate-800 rounded-2xl p-6 md:p-8 shadow-lg border border-slate-200 dark:border-slate-700">
                    <div class="flex items-center justify-between mb-8">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/20 rounded-2xl flex items-center justify-center">
                                <span class="material-symbols-outlined text-xl text-blue-600 dark:text-blue-400">today</span>
                            </div>
                            <div>
                                <h2 class="text-2xl md:text-3xl font-bold text-slate-900 dark:text-white mb-2">Hoy en tu viaje</h2>
                                <p class="text-slate-600 dark:text-slate-400 text-sm md:text-base flex items-center gap-2" id="today-date">
                                    <span class="material-symbols-outlined text-sm">calendar_month</span>
                                    Cargando fecha...
                                </p>
                            </div>
                        </div>
                        <div class="text-right bg-blue-50 dark:bg-blue-900/20 rounded-2xl p-4 border border-blue-200 dark:border-blue-800">
                            <div class="text-3xl md:text-4xl font-bold text-blue-600 dark:text-blue-400" id="today-day">--</div>
                            <div class="text-blue-600 dark:text-blue-400 text-sm">D√≠a del viaje</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-slate-50 dark:bg-slate-700 rounded-2xl p-5 border border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 transition-all duration-200">
                            <div class="flex items-center gap-3 mb-3">
                                <span class="material-symbols-outlined text-xl text-blue-600 dark:text-blue-400">location_on</span>
                                <h3 class="font-semibold text-slate-900 dark:text-white">Pr√≥ximo destino</h3>
                            </div>
                            <p class="text-slate-600 dark:text-slate-400 text-sm" id="next-destination">Cargando...</p>
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-700 rounded-2xl p-5 border border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 transition-all duration-200">
                            <div class="flex items-center gap-3 mb-3">
                                <span class="material-symbols-outlined text-xl text-green-600 dark:text-green-400">hotel</span>
                                <h3 class="font-semibold text-slate-900 dark:text-white">Alojamiento</h3>
                            </div>
                            <p class="text-slate-600 dark:text-slate-400 text-sm" id="today-accommodation">Cargando...</p>
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-700 rounded-2xl p-5 border border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 transition-all duration-200">
                            <div class="flex items-center gap-3 mb-3">
                                <span class="material-symbols-outlined text-xl text-orange-600 dark:text-orange-400">hiking</span>
                                <h3 class="font-semibold text-slate-900 dark:text-white">Actividad principal</h3>
                            </div>
                            <p class="text-slate-600 dark:text-slate-400 text-sm" id="today-activity">Cargando...</p>
                        </div>
                        <div class="bg-slate-50 dark:bg-slate-700 rounded-2xl p-5 border border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 transition-all duration-200">
                            <div class="flex items-center gap-3 mb-3">
                                <span class="material-symbols-outlined text-xl text-sky-600 dark:text-sky-400">partly_cloudy_day</span>
                                <h3 class="font-semibold text-slate-900 dark:text-white">Clima</h3>
                            </div>
                            <p class="text-slate-600 dark:text-slate-400 text-sm" id="today-weather">Cargando...</p>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap gap-3 justify-center">
                        <button onclick="switchToView('itinerary')" class="bg-blue-50 dark:bg-blue-900/20 hover:bg-blue-100 dark:hover:bg-blue-800/30 border border-blue-200 dark:border-blue-800 rounded-xl px-6 py-3 text-sm font-medium transition-all duration-200 hover:shadow-md">
                            <span class="material-symbols-outlined text-sm mr-2 text-blue-600 dark:text-blue-400">list_alt</span>
                            <span class="text-blue-700 dark:text-blue-300">Ver itinerario completo</span>
            </button>
                        <button onclick="switchToView('map')" class="bg-green-50 dark:bg-green-900/20 hover:bg-green-100 dark:hover:bg-green-800/30 border border-green-200 dark:border-green-800 rounded-xl px-6 py-3 text-sm font-medium transition-all duration-200 hover:shadow-md">
                            <span class="material-symbols-outlined text-sm mr-2 text-green-600 dark:text-green-400">map</span>
                            <span class="text-green-700 dark:text-green-300">Abrir mapa</span>
                        </button>
                        <button onclick="switchToView('tools')" class="bg-purple-50 dark:bg-purple-900/20 hover:bg-purple-100 dark:hover:bg-purple-800/30 border border-purple-200 dark:border-purple-800 rounded-xl px-6 py-3 text-sm font-medium transition-all duration-200 hover:shadow-md">
                            <span class="material-symbols-outlined text-sm mr-2 text-purple-600 dark:text-purple-400">build</span>
                            <span class="text-purple-700 dark:text-purple-300">Herramientas de viaje</span>
                        </button>
                    </div>
                </section>
                
                <header class="relative h-96 rounded-3xl overflow-hidden shadow-2xl shadow-slate-900/20 border border-slate-200 dark:border-slate-700">
                    <div id="parallax-bg" class="absolute inset-0 bg-cover bg-center transition-transform duration-300 ease-out" style="background-image: url('https://www.lasociedadgeografica.com/blog/uploads/2019/10/bhutan-peaceful-tours-nido-del-tigre.jpg'); transform: scale(1.1);"></div>
                    <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-black/20"></div>
                    
                    <!-- Floating elements -->
                    <div class="absolute top-6 right-6 flex gap-3">
                        <div class="bg-white/20 backdrop-blur-sm rounded-full p-3 shadow-lg">
                            <span class="material-symbols-outlined text-white text-lg">flight_takeoff</span>
                        </div>
                        <div class="bg-white/20 backdrop-blur-sm rounded-full p-3 shadow-lg">
                            <span class="material-symbols-outlined text-white text-lg">landscape</span>
                        </div>
                    </div>
                    
                    <div class="relative h-full flex flex-col justify-end p-8 md:p-12 text-white">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center shadow-lg">
                                <span class="material-symbols-outlined text-white text-xl">hiking</span>
                            </div>
                            <div class="bg-white/20 backdrop-blur-sm rounded-full px-4 py-2">
                                <span class="text-sm font-medium" id="trip-dates">Cargando fechas...</span>
                            </div>
                        </div>
                        <h1 class="text-4xl md:text-6xl font-black leading-tight mb-3">Mi Aventura en el Himalaya</h1>
                        <p class="text-lg md:text-xl max-w-2xl opacity-90" id="hero-subtitle">Un recorrido de 18 d√≠as para descubrir Nepal y But√°n.</p>
                        
                        <div class="flex items-center gap-4 mt-6">
                            <div class="flex items-center gap-2 bg-white/10 backdrop-blur-sm rounded-full px-3 py-1">
                                <span class="material-symbols-outlined text-sm">location_on</span>
                                <span class="text-sm">2 pa√≠ses</span>
                            </div>
                            <div class="flex items-center gap-2 bg-white/10 backdrop-blur-sm rounded-full px-3 py-1">
                                <span class="material-symbols-outlined text-sm">schedule</span>
                                <span class="text-sm">18 d√≠as</span>
                            </div>
                        </div>
                    </div>
                </header>
                
                <!-- Sections will be injected here -->
                <!-- Trip Summary Section -->
                <section id="summary" class="space-y-6 md:space-y-8" data-nav="Resumen del Viaje" data-icon="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></section>
                

                <section id="flights" class="space-y-6 md:space-y-8" data-nav="Vuelos" data-icon="flight">
                    <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 border border-slate-200 dark:border-slate-700 shadow-lg">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="material-symbols-outlined text-2xl text-blue-600 dark:text-blue-400">flight</span>
                            <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Informaci√≥n de Vuelos</h2>
                        </div>
                        <div id="flights-content" class="space-y-4">
                            <!-- El contenido se renderizar√° din√°micamente -->
                        </div>
                    </div>
                </section>
                <section id="map-section" class="space-y-6 md:space-y-8" data-nav="Mapa" data-icon="map">
                    <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 border border-slate-200 dark:border-slate-700 shadow-lg">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="material-symbols-outlined text-2xl text-green-600 dark:text-green-400">map</span>
                            <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Mapa del Viaje</h2>
                        </div>
                        <div id="map-content" class="space-y-4">
                            <!-- El contenido se renderizar√° din√°micamente -->
                        </div>
                    </div>
                </section>
                <section id="itinerary" class="space-y-6 md:space-y-8" data-nav="Itinerario" data-icon="list_alt">
                    <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 border border-slate-200 dark:border-slate-700 shadow-lg">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="material-symbols-outlined text-2xl text-purple-600 dark:text-purple-400">list_alt</span>
                            <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Itinerario Completo</h2>
                        </div>
                        <div id="itinerary-content" class="space-y-4">
                            <!-- El contenido se renderizar√° din√°micamente -->
                        </div>
                    </div>
                </section>
                <section id="budget" class="space-y-6 md:space-y-8" data-nav="Presupuesto" data-icon="account_balance_wallet">
                    <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 border border-slate-200 dark:border-slate-700 shadow-lg">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="material-symbols-outlined text-2xl text-orange-600 dark:text-orange-400">account_balance_wallet</span>
                            <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Presupuesto y Gastos</h2>
                        </div>
                        <div id="budget-content" class="space-y-4">
                            <!-- El contenido se renderizar√° din√°micamente -->
                        </div>
                    </div>
                </section>

                <section id="packing-list" class="space-y-6 md:space-y-8" data-nav="Equipaje" data-icon="luggage">
                    <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 border border-slate-200 dark:border-slate-700 shadow-lg">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="material-symbols-outlined text-2xl text-teal-600 dark:text-teal-400">luggage</span>
                            <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Lista de Equipaje</h2>
                        </div>
                        <div id="packing-content" class="space-y-4">
                            <!-- El contenido se renderizar√° din√°micamente -->
                        </div>
                    </div>
                </section>
                <section id="tour-packages" class="space-y-6 md:space-y-8" data-nav="Paquetes de Viaje" data-icon="travel_explore">
                    <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 border border-slate-200 dark:border-slate-700 shadow-lg">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="material-symbols-outlined text-2xl text-pink-600 dark:text-pink-400">travel_explore</span>
                            <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Paquetes de Viaje</h2>
                        </div>
                        <div id="tour-content" class="space-y-4">
                            <!-- El contenido se renderizar√° din√°micamente -->
                        </div>
                    </div>
                </section>
                
                <!-- Informaci√≥n Adicional al final -->
                <section id="overview" class="space-y-6 md:space-y-8" data-nav="Informaci√≥n Adicional" data-icon="info">
                    <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 border border-slate-200 dark:border-slate-700 shadow-lg">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="material-symbols-outlined text-2xl text-slate-600 dark:text-slate-400">info</span>
                            <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Informaci√≥n Adicional</h2>
                        </div>
                        <div id="overview-content" class="space-y-4">
                            <!-- El contenido se renderizar√° din√°micamente -->
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>
    
    <!-- Modal para Itinerario -->
    <div id="itinerary-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div id="itinerary-modal-content" class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-4xl max-h-[95vh] overflow-y-auto animate-modal-in relative">
            <!-- Content will be injected by JS -->
        </div>
    </div>

    <!-- Modal para Exportar PDF -->
    <div id="pdf-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-8 max-w-sm w-full animate-modal-in">
            <h3 class="text-xl font-bold mb-4">Personalizar PDF</h3>
            <p class="text-sm text-slate-500 mb-6">Selecciona las secciones que quieres incluir en tu documento.</p>
            <div id="pdf-options" class="space-y-3 mb-6"></div>
            <div class="flex gap-3">
                <button id="pdf-cancel" class="w-full p-2 rounded-lg bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600">Cancelar</button>
                <button id="pdf-confirm" class="w-full p-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Crear PDF</button>
            </div>
        </div>
    </div>


<!-- Bloque 1: Datos del Viaje (trip-data.js) -->
<script>
const tripConfig = {
    flightsData: [
                    { type: 'Internacional', title: 'Vuelo de Ida', airline: 'Qatar Airways', segments: [ { from: 'MAD', fromDateTime: '9 de Octubre 22:45', to: 'DOH', toDateTime: '10 de Octubre 06:30', layover: 'Tr√°nsito de 2h 55m en Doha (DOH)' }, { from: 'DOH', fromDateTime: '10 de Octubre 09:25', to: 'KTM', toDateTime: '10 de Octubre 16:45' } ] },
                    { type: 'Regional', title: 'Katmand√∫ ‚Üí Paro', airline: 'Druk Air', segments: [{ from: 'KTM', fromDateTime: '20 de Octubre 09:10', to: 'PBH', toDateTime: '20 de Octubre 10:30' }] },
                    { type: 'Regional', title: 'Paro ‚Üí Katmand√∫', airline: 'Bhutan Airlines', segments: [{ from: 'PBH', fromDateTime: '25 de Octubre 07:05', to: 'KTM', toDateTime: '25 de Octubre 08:00' }] },
        { type: 'Internacional', title: 'Vuelo de Vuelta', airline: 'Qatar Airways', segments: [ { from: 'KTM', fromDateTime: '26 de Octubre 09:35', to: 'DOH', toDateTime: '26 de Octubre 12:25', layover: 'Tr√°nsito de 2h 55m en Doha (DOH)' }, { from: 'DOH', fromDateTime: '26 de Octubre 15:20', to: 'MAD', toDateTime: '26 de Octubre 20:55' } ] }
    ],
    budgetData: {
        vuelos: [{category: 'Transporte',concept: 'Vuelos Principales',icon: '‚úàÔ∏è',subItems: [ { concept: 'Madrid ‚Üî Katmand√∫ (Qatar)', cost: 270.00 }, { concept: 'Katmand√∫ ‚Üí Paro (Drukair)', cost: 227.76 }, { concept: 'Paro ‚Üí Katmand√∫ (Bhutan Airlines)', cost: 196.21 } ]}],
        nepal: [ { category: 'Tour', concept: 'Itinerario "Nepal 360"', cost: 1100.00, icon: 'üó∫Ô∏è' }, { category: 'Transporte', concept: 'Transporte Local (Katmand√∫)', icon: 'üöï', subItems: [ { concept: 'Taxis Aeropuerto (4 viajes)', cost: 28.00 }, { concept: 'Taxis Ciudad (4 viajes)', cost: 12.00 }, { concept: 'Autobuses (2 viajes)', cost: 1.00 } ]}, { category: 'Comida y Bebida', concept: 'Comidas en Nepal', cost: 187.00, icon: 'üçõ' }, { category: 'Entradas y Visados', concept: 'Visados y Entradas', icon: 'üèõÔ∏è',subItems: [ { concept: 'Visado de Nepal (30 d√≠as)', cost: 50.00 }, { concept: 'Plaza Durbar, Katmand√∫', cost: 7.00 }, { concept: 'Swayambhunath (Templo de los Monos)', cost: 1.50 }, { concept: 'Pashupatinath', cost: 7.00 }, { concept: 'Estupa de Boudhanath', cost: 3.00 } ]}, { category: 'Varios', concept: 'Gastos Varios y Propinas', icon: 'üõçÔ∏è',subItems: [ { concept: 'Propinas', cost: 55.00 }, { concept: 'Fondo Com√∫n Estimado', cost: 50.00 }, { concept: 'Parapente en Pokhara (Opcional)', cost: 80.00, dayId: 'day-6' }, { concept: 'Comunicaciones (SIM)', cost: 4.00 }, { concept: 'Souvenirs', cost: 22.50 }, { concept: 'Lavander√≠a', cost: 5.00 } ]}, { category: 'Contingencia', concept: 'Fondo para Imprevistos (Nepal)', cost: 149.20, icon: 'üõ°Ô∏è' } ],
        butan: [{ category: 'Tour', concept: 'Itinerario "Best of Bhutan"', cost: 1602.00, icon: 'üó∫Ô∏è' },{ category: 'Entradas y Visados', concept: 'Entradas a Monumentos', icon: 'üèõÔ∏è',subItems: [{ concept: 'Monasterio Taktsang (Nido del Tigre)', cost: 22.00, dayId: 'day-15' },{ concept: 'Tashichho Dzong', cost: 11.00 },{ concept: 'Punakha Dzong', cost: 11.00 },{ concept: 'Memorial Chorten', cost: 11.00 },{ concept: 'Buddha Dordenma', cost: 11.00 },{ concept: 'Rinpung Dzong', cost: 11.00 }]},{ category: 'Comida y Bebida', concept: 'Bebidas', cost: 45.00, icon: 'ü•§' },{ category: 'Varios', concept: 'Gastos Varios y Propinas', icon: 'üõçÔ∏è',subItems: [{ concept: 'Propinas Gu√≠a y Conductor', cost: 90.00 },{ concept: 'Comunicaciones (SIM)', cost: 4.00 },{ concept: 'Souvenirs', cost: 22.50 }]},{ category: 'Contingencia', concept: 'Fondo para Imprevistos (But√°n)', cost: 176.35, icon: 'üõ°Ô∏è' }]
    },
    itineraryData: [
        { id: 'day-1', phase: 'nepal', title: 'Salida desde Madrid', description: "El viaje comienza con el vuelo nocturno desde Madrid-Barajas (MAD) con destino a Katmand√∫.", image: "https://images.unsplash.com/photo-1436491865332-7a61a109cc05?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2074&q=80", icon: '‚úàÔ∏è', planA: "Embarque en el vuelo nocturno de Qatar Airways. Acom√≥date para el primer trayecto largo hasta Doha. Cena y desayuno a bordo.", planB: "Aseg√∫rate de haber hecho el check-in online para elegir un buen asiento.", consejo: "Usa un coj√≠n de viaje y antifaz. Dormir en el primer vuelo es clave para combatir el jet lag.", bocado: "Cena ligera antes de embarcar. En el avi√≥n, bebe mucha agua." },
        { id: 'day-2', phase: 'nepal', title: 'Llegada a Katmand√∫', description: "Llegada al aeropuerto, tr√°mites de visado y traslado al hotel en Thamel para un primer contacto con la ciudad.", image: "https://www.conmochila.com/wp-content/uploads/2019/12/thamel-kathmandu-01.jpg", coords: [27.7172, 85.3240], icon: 'üõ¨', planA: "Llegada a KTM. Pasa por inmigraci√≥n para obtener el visado on-arrival. Recoge tu equipaje y busca al representante del tour o toma un taxi prepago al hotel en Thamel. Check-in y tiempo para refrescarse.", planB: "Si llegas con energ√≠a, da un primer paseo por las ca√≥ticas y fascinantes calles de Thamel para ubicarte. Para un respiro, visita el cercano Jard√≠n de los Sue√±os.", consejo: "Ten a mano 50 USD en efectivo para el visado de 30 d√≠as. El proceso en el aeropuerto es sencillo pero puede haber cola. Un taxi a Thamel cuesta entre 400-800 NPR.", bocado: "Tu primer Dal Bhat. ¬°El plato nacional! Pide uno en un restaurante local en Thamel." },
        { id: 'day-3', phase: 'nepal', title: 'Plaza Durbar y Encuentro WeRoad', description: "Ma√±ana libre para explorar el coraz√≥n hist√≥rico de Katmand√∫, la Plaza Durbar, antes de unirte al grupo de WeRoad por la tarde para la cena de bienvenida.", image: "https://images.unsplash.com/photo-1544551763-46a013bb70d5?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80", coords: [27.7048, 85.3074], icon: 'üèõÔ∏è', planA: "Aprovecha la ma√±ana para visitar la Plaza Durbar de Katmand√∫, Patrimonio de la Humanidad. Explora el Palacio Real de Hanuman Dhoka y busca a la diosa viviente en el Kumari Chowk. Por la tarde, check-in en el Hotel Manang o similar para el encuentro con el grupo WeRoad y la cena de bienvenida.", planB: "Pi√©rdete por los mercados de Asan Tole e Indra Chowk, cerca de la Plaza Durbar, para una inmersi√≥n total en la vida local antes de la tranquilidad del tour.", consejo: "La entrada a la Plaza Durbar cuesta 1000 NPR y te permite acceder a varios templos y al museo del palacio. Guarda la entrada, te la pueden pedir.", bocado: "Prueba un 'Lassi' en las tiendas especializadas cerca de Indra Chowk. Es una bebida de yogur refrescante, perfecta para una pausa." },
        { id: 'day-4', phase: 'nepal', title: 'Rafting en el Trisuli y Llegada a Pokhara', description: "Viaje por carretera hacia Pokhara con una parada para una emocionante sesi√≥n de rafting en el r√≠o Trisuli. Tarde en el tranquilo barrio tibetano.", image: "https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80", coords: [28.2096, 83.9856], icon: 'üö£', planA: "Salida temprano por carretera hacia Pokhara (aprox. 6 horas). Parada para una sesi√≥n de rafting en el r√≠o Trisuli. Llegada a Pokhara y check-in en el Hotel White Pearl o similar. Por la tarde, visita al barrio tibetano, con sus casas de colores, su templo y tiendas de artesan√≠a. Atardecer paseando por Lakeside.", planB: "Al llegar a Pokhara, alquila una barca en el lago Phewa y rema hasta el templo Tal Barahi, situado en una isla en medio del lago. Es una experiencia muy serena.", consejo: "Para el rafting, no lleves nada de valor que no se pueda mojar. Te dar√°n bolsas estancas para lo imprescindible. Lleva un cambio de ropa.", bocado: "Cena en un restaurante en la orilla del lago (Lakeside) en Pokhara. Prueba un Thukpa, una sopa de fideos de origen tibetano, muy reconfortante." },
        { id: 'day-5', phase: 'nepal', title: 'Trekking a Ghandruk (1.940m)', description: "Comienzo del trekking. Viaje en jeep y caminata de 5-6h (8 km) a trav√©s de selva y pueblos hasta el asentamiento Gurung de Ghandruk.", image: "https://himalayan-masters.com/wp-content/uploads/2024/08/Gurung-Cottage-Ghandruk.webp", coords: [28.375, 83.81], icon: 'üèîÔ∏è', planA: "Traslado en jeep hasta Landruk (aprox. 4h). Inicio de la caminata desde Jhinu Danda. La ruta pasa por Saulibazaar (parada para almorzar) y atraviesa senderos selv√°ticos y peque√±os pueblos. Llegada a Ghandruk por la tarde. Visita al museo local para entender la cultura Gurung. Noche en una pensi√≥n local.", planB: "Charla con los locales en los pueblos que atravieses. Su hospitalidad es legendaria y te permitir√° conocer de cerca su modo de vida.", consejo: "La segunda parte de la ruta tiene muchas escaleras. Camina a tu propio ritmo ('bistari, bistari'). No es una carrera. Disfruta del paisaje.", bocado: "Prueba el t√© de jengibre, lim√≥n y miel en uno de los lodges. Es reconfortante y se dice que ayuda con la altitud." },
        { id: 'day-6', phase: 'nepal', title: 'Trekking a Chhomrong (2.170m)', description: "Segunda jornada de trekking (6-7h, 8 km) hasta Chhomrong, la puerta de entrada al Santuario del Annapurna, con vistas espectaculares.", image: "https://media.istockphoto.com/id/1493335414/es/foto/hermosa-estupa-de-budismo-tibetano-en-el-pueblo-de-chhomrong-con-el-monte-annapurna-al-sur-en.jpg?s=612x612&w=0&k=20&c=A5-ydGKKdxpFmvEYeaNQeZvYtMIX59ue3a3yl_oE3H8=", coords: [28.415, 83.82], icon: 'üèîÔ∏è', planA: "Desayuno con vistas. La ruta de hoy incluye un ascenso a Kimrung Danda para almorzar, seguido de un descenso hasta Chhomrong. Este pueblo es el √∫ltimo antes del Campo Base del Annapurna. Disfruta del atardecer sobre el Annapurna Sur y el Machhapuchhre. Noche en pensi√≥n local.", planB: "Busca la 'German Bakery' de Chhomrong. Encontrar un pastel de chocolate o un apple crumble en medio de la monta√±a no tiene precio.", consejo: "Las vistas del Annapurna Sur y Machhapuchhre desde Chhomrong al atardecer son espectaculares. Ten la c√°mara preparada.", bocado: "Recarga energ√≠as con un plato de 'garlic soup' (sopa de ajo). Es un cl√°sico del trekking para combatir el mal de altura y entrar en calor." },
        { id: 'day-7', phase: 'nepal', title: 'Aguas Termales y Regreso a Pokhara', description: "Caminata corta de descenso (2-3h) para un ba√±o en aguas termales en Jhimodanda y regreso en jeep a Pokhara.", image: "https://cdn.getyourguide.com/img/tour/4d032f9b41e3de55b58794f65eafe292beea2718366b16bab7fb83cfa48b9144.jpg/68.jpg", coords: [28.2096, 83.9856], icon: '‚ô®Ô∏è', planA: "√öltima etapa del trekking. Descenso hasta Jhimodanda. Tiempo para relajarse en las piscinas de aguas termales. Almuerzo y traslado en jeep de vuelta a Pokhara (pasando por Nayapul). Tarde libre para descansar o actividades opcionales.", planB: "Si te sientes con adrenalina, la tarde en Pokhara es ideal para hacer parapente, una de las actividades estrella de la ciudad, con vistas incre√≠bles del lago y las monta√±as.", consejo: "Lleva ba√±ador para las aguas termales. Es la mejor recompensa para los m√∫sculos despu√©s del trekking.", bocado: "Celebra el fin del trekking con una pizza en Pokhara. Hay pizzer√≠as sorprendentemente buenas como la de Roadhouse Cafe." },
        { id: 'day-8', phase: 'nepal', title: 'Parque Nacional de Chitwan', description: "Viaje a la selva de Chitwan. Por la tarde, safari en jeep en busca de rinocerontes y otra fauna salvaje.", image: "https://dynamic-media-cdn.tripadvisor.com/media/photo-o/16/ee/68/e7/chitwan-jungle-safari.jpg?w=1200&h=900&s=1", coords: [27.5291, 84.4220], icon: 'üêò', planA: "Salida por carretera hacia el sur, a la regi√≥n de Terai. Llegada al Parque Nacional de Chitwan. Por la tarde, primer safari en jeep por la jungla para avistar fauna, especialmente rinocerontes de un cuerno. Cena en el lodge junto al r√≠o Rapti.", planB: "Paseo al atardecer por la orilla del r√≠o Rapti. Es muy relajante y se ven muchos p√°jaros y locales ba√±ando a sus elefantes.", consejo: "Usa ropa de colores neutros (verde, beige) para el safari y no te olvides del repelente de mosquitos. Mant√©n silencio para no asustar a los animales.", bocado: "Prueba un curry de pescado fresco en alg√∫n restaurante cerca del r√≠o, es una especialidad de la zona." },
        { id: 'day-9', phase: 'nepal', title: 'Chitwan y Regreso a Katmand√∫', description: "Actividad matutina en Chitwan (paseo en canoa o visita a un pueblo Tharu) y largo viaje de vuelta a Katmand√∫.", image: "https://media.tacdn.com/media/attractions-splice-spp-674x446/07/9a/f2/ec.jpg", coords: [27.7172, 85.3240], icon: 'üöô', planA: "Actividad matutina: paseo en canoa por el r√≠o Rapti para observar aves y cocodrilos gaviales. Desayuno y visita a un pueblo de la etnia Tharu para conocer su cultura √∫nica. Comienzo del viaje de regreso por carretera a Katmand√∫ (aprox. 6 horas).", planB: "El paseo en canoa por el r√≠o Rapti es muy recomendable al amanecer. La niebla matutina sobre el r√≠o crea una atm√≥sfera m√°gica.", consejo: "El viaje de vuelta puede ser largo y pesado. Ten a mano un libro o m√∫sica para el trayecto. Compra algunos snacks locales para el camino.", bocado: "Para cenar en Katmand√∫, busca un restaurante que sirva 'Chatamari', a menudo llamada la 'pizza nepal√≠', una fina crepe de arroz con toppings." },
        { id: 'day-10', phase: 'nepal', title: 'Katmand√∫: Cocina y Despedida', description: "D√≠a para explorar Katmand√∫ de forma independiente, seguido de una clase de cocina nepal√≠ y la cena de despedida del grupo.", image: "https://almamochilera.com/images/blog/abhishek-sanwa-limbu-lr559dcst70-unsplash-compressor.jpg", coords: [27.7172, 85.3240], icon: 'üßë‚Äçüç≥', planA: "Ma√±ana libre para explorar Thamel, visitar el Jard√≠n de los Sue√±os o hacer compras. Por la tarde, participaci√≥n en una clase de cocina para aprender a preparar platos como los momos. Cena de despedida del grupo para compartir las experiencias.", planB: "Visita el mercado de Asan Tole, a un corto paseo de Thamel. Es el mercado m√°s antiguo y bullicioso de la ciudad, una experiencia sensorial aut√©ntica.", consejo: "En la clase de cocina, no tengas miedo de pringarte las manos. Hacer la masa de los momos es muy divertido y una habilidad que te llevar√°s a casa.", bocado: "¬°Los momos que t√∫ mismo has preparado! Sin duda, la mejor cena de despedida." },
        { id: 'day-11', phase: 'nepal', title: 'Estupas Sagradas de Katmand√∫', description: "Ma√±ana de despedida del grupo y tarde libre para explorar dos de los lugares m√°s sagrados del budismo en el valle: Swayambhunath y Boudhanath.", image: "https://pasaportenomada.es/wp-content/uploads/2024/08/que-ver-en-katmandu-boudanath.webp", coords: [27.7147, 85.3445], icon: '‚ò∏Ô∏è', planA: "Desayuno y despedida del grupo WeRoad. Tarde libre. Toma un taxi a Swayambhunath (Templo de los Monos), sube sus 365 escalones y disfruta de las vistas panor√°micas de la ciudad. Por la tarde-noche, visita la gran estupa de Boudhanath.", planB: "Ve a la estupa de Boudhanath al atardecer. La atm√≥sfera con los monjes y peregrinos dando vueltas (kora) mientras encienden l√°mparas de mantequilla es m√°gica.", consejo: "Para visitar estos dos lugares, negocia un precio con un taxista para que te lleve a ambos y te espere. Ahorrar√°s tiempo y dinero.", bocado: "Cena en una de las terrazas de los restaurantes que rodean la estupa de Boudhanath, con vistas a la c√∫pula iluminada." },
        { id: 'day-12', phase: 'butan', title: 'Llegada a But√°n y Capital Thimphu', description: "Vuelo panor√°mico a Paro y traslado a la capital, Thimphu. Visita al Museo Nacional, al Buda Dordenma y al centro de tejido.", image: "https://upload.wikimedia.org/wikipedia/commons/4/4e/Buddha_Dordenma.jpg", coords: [27.4728, 89.6390], icon: '‚úàÔ∏è', planA: "Traslado al aeropuerto para el espectacular vuelo a Paro. A la llegada, encuentro con el gu√≠a local. Visita al Museo Nacional (Ta Dzong) para una introducci√≥n a la historia de But√°n. Traslado a Thimphu. Visita a la estatua del Buda Dordenma y al Weaving Center. Tarde libre para un primer paseo por la capital.", planB: "Pide a tu gu√≠a parar en el mirador del r√≠o Chuzom, donde se unen los r√≠os de Paro y Thimphu, marcados por tres estupas de diferentes estilos.", consejo: "¬°Pide asiento de ventanilla en el lado izquierdo en el vuelo a Paro! Si el d√≠a est√° claro, ver√°s el Everest.", bocado: "Tu primera comida en But√°n seguramente incluir√° 'Ema Datshi' (chiles y queso). ¬°Pide que no pique mucho al principio!" },
        { id: 'day-13', phase: 'butan', title: 'Arte y Cultura en Thimphu', description: "Caminata al Monasterio de Tango y visita a los centros culturales de Thimphu: el Instituto Zorig Chusum, la Biblioteca Nacional y el Museo Postal.", image: "https://dynamic-media-cdn.tripadvisor.com/media/photo-o/11/3e/05/86/tashichho-dzong-it-was.jpg?w=900&h=500&s=1", coords: [27.578, 89.636], icon: 'üé®', planA: "Por la ma√±ana, caminata de 2.5h (ida y vuelta) al Monasterio de Tango. Almuerzo tradicional en el Folk Heritage Restaurant. Por la tarde, visita al Instituto Nacional Zorig Chusum (escuela de las 13 artes), la Biblioteca Nacional, el Authentic Craft Bazaar y el Museo Postal.", planB: "Visita la Reserva de Takines para ver el curioso animal nacional de But√°n y el Tashichho Dzong (Fortaleza de la Gloriosa Religi√≥n), sede del gobierno.", consejo: "En el Museo Postal puedes imprimir un sello con tu propia foto. ¬°El mejor y m√°s original souvenir!", bocado: "Prueba los 'momos' butaneses. Son similares a los nepal√≠es pero a menudo m√°s picantes y con rellenos diferentes." },
        { id: 'day-14', phase: 'butan', title: 'Hacia Punakha v√≠a Dochula Pass', description: "Viaje a Punakha a trav√©s del paso Dochula (3.150m). Visita al 'Templo de la Fertilidad' y al majestuoso Punakha Dzong.", image: "https://www.authenticindiatours.com/app/uploads/2022/04/Monument-with-108-chorten-Dochula-Pass-Bhutan-min-1400x550-c-default.jpg", coords: [27.5843, 89.8631], icon: 'üèØ', planA: "Salida hacia Punakha. Parada en el paso de Dochula para admirar las 108 estupas y las vistas del Himalaya. Descenso al valle y caminata hasta el Chimi Lhakhang, el 'Templo de la Fertilidad'. Por la tarde, visita al Punakha Dzong, situado en la confluencia de los r√≠os Phochu y Mochu.", planB: "Cruza el puente colgante cerca del Punakha Dzong, uno de los m√°s largos de But√°n. ¬°Las vistas y la sensaci√≥n son geniales!", consejo: "En el paso Dochula, si el d√≠a est√° despejado, la vista de la cordillera del Himalaya es sobrecogedora. T√≥mate tu tiempo y abr√≠gate.", bocado: "El arroz rojo es una especialidad de But√°n. Lo servir√°n en casi todas las comidas, es nutritivo y tiene un sabor particular, a nuez." },
        { id: 'day-15', phase: 'butan', title: 'Valle de Punakha y Regreso a Paro', description: "Caminata matutina al Khamsum Yuelley Namgyel Chorten y regreso por carretera a Paro, con una posible caminata adicional en ruta.", image: "https://dynamic-media-cdn.tripadvisor.com/media/photo-o/17/1c/1e/22/khamsum-yulley-namgyal.jpg?w=1200&h=-1&s=1", coords: [27.618, 89.861], icon: 'üö∂‚Äç‚ôÇÔ∏è', planA: "Caminata matutina de 2.5h a trav√©s de campos de arroz hasta el Khamsum Yuelley Namgyel Chorten. Disfruta de las vistas del valle. Viaje de regreso a Paro, con almuerzo en el Dochula Cafe. Por la tarde, caminata opcional de 1h al monasterio Tashigang Gonpa desde el paso.", planB: "Pide a tu gu√≠a que te cuente la historia del 'Divino Loco', Drukpa Kunley, asociada al Templo de la Fertilidad. Es muy curiosa y fundamental para entender parte de la cultura butanesa.", consejo: "La caminata al Chorten es suave y muy fotog√©nica, atravesando campos de arroz y un puente colgante. Un paseo muy agradable.", bocado: "Prueba el 'Suja', el t√© de mantequilla butan√©s. Es una bebida de sabor fuerte y salado, una experiencia cultural en s√≠ misma." },
        { id: 'day-16', phase: 'butan', title: 'Trekking al Nido del Tigre', description: "D√≠a dedicado al trekking al ic√≥nico Monasterio de Taktsang, el 'Nido del Tigre', y cena de despedida en una granja local.", image: "https://www.earthtrekkers.com/wp-content/uploads/2017/02/Tigers-Nest-Bhutan.jpg.webp", coords: [27.4915, 89.3632], icon: 'üêÖ', planA: "D√≠a cumbre en But√°n. Desayuno temprano y trekking al Monasterio de Taktsang (4-5h ida y vuelta). Visita al monasterio. Descenso y almuerzo. Tarde libre. Cena de despedida en una granja local con opci√≥n de ba√±o de piedras calientes.", planB: "Si te quedan fuerzas, visita el Kyichu Lhakhang por la tarde, uno de los templos m√°s antiguos y sagrados de But√°n, para una experiencia m√°s tranquila y espiritual.", consejo: "Empieza a caminar antes de las 8 am para evitar multitudes y el calor. El camino es empinado, usa bastones si lo necesitas. Viste con decoro (mangas y pantalones largos).", bocado: "La comida en la cafeter√≠a a mitad de camino del Nido del Tigre tiene las mejores vistas del mundo. Para la cena, prueba el 'Phaksha Paa' (cerdo con chiles)." },
        { id: 'day-17', phase: 'farewell', title: 'Joyas de Patan y Despedida', description: "Llegada a Katmand√∫ por la ma√±ana y tarde libre para explorar la ciudad de Patan, conocida por su exquisita Plaza Durbar y su Templo Dorado.", image: "https://upload.wikimedia.org/wikipedia/commons/4/48/Patan-Palastplatz-14-Tauben-2013-gje.jpg", coords: [27.6736, 85.3250], icon: 'üèõÔ∏è', planA: "Llegada al aeropuerto de Katmand√∫ a las 9am y traslado al hotel. Por la tarde, visita la Plaza Durbar de Patan, a menudo considerada la m√°s bella del valle. No te pierdas el incre√≠ble Museo de Patan y el cercano Templo Dorado.", planB: "En Patan, pi√©rdete por los patios interiores (bahals) que rodean la plaza. Descubrir√°s peque√±os santuarios, talleres de artesanos y una vida local muy tranquila.", consejo: "En el vuelo de Paro a Katmand√∫, pide ventanilla en el lado derecho para volver a ver el Himalaya.", bocado: "Disfruta de una √∫ltima cena nepal√≠ en un buen restaurante de Patan o Thamel. Prueba la cocina Newari, como la 'choyla' o el 'yomari'." },
        { id: 'day-18', phase: 'farewell', title: 'Vuelo de Vuelta a Casa', description: "Desayuno y traslado al aeropuerto para el vuelo de regreso, lleno de recuerdos del Himalaya.", image: "https://media.istockphoto.com/id/1465916031/es/foto/el-camino-al-avi%C3%B3n.jpg?s=612x612&w=0&k=20&c=h7qjRLIKPBelNG5e3PP6fje3D9pOxvYDHN1hoQLZHms=", coords: [27.6966, 85.3533], icon: 'üè†', planA: "Desayuno en el hotel. Dependiendo de la hora del vuelo, tiempo para un √∫ltimo paseo por Thamel. Traslado al Aeropuerto Internacional Tribhuvan para el vuelo de regreso a casa.", planB: "Si tienes tiempo, compra t√© nepal√≠ de buena calidad en alguna tienda especializada. Es un gran recuerdo y regalo.", consejo: "Llega al aeropuerto con bastante antelaci√≥n. El proceso de facturaci√≥n y seguridad en Katmand√∫ puede ser lento.", bocado: "Un √∫ltimo caf√© nepal√≠ en el aeropuerto mientras esperas el embarque." }
    ],
    weatherData: [
        { location: 'Katmand√∫', dayTemp: '22-25¬∞C', nightTemp: '5-10¬∞C', icon: '‚òÄÔ∏è' }, 
        { location: 'Pokhara', dayTemp: '22-25¬∞C', nightTemp: '5-10¬∞C', icon: '‚òÄÔ∏è' },
        { location: 'Chitwan', dayTemp: '25-30¬∞C', nightTemp: '15-20¬∞C', icon: 'ü•µ' }, 
        { location: 'Thimphu', dayTemp: '15-22¬∞C', nightTemp: '0-7¬∞C', icon: 'üèîÔ∏è' },
        { location: 'Paro', dayTemp: '15-22¬∞C', nightTemp: '0-7¬∞C', icon: 'üèîÔ∏è' }, 
        { location: 'Punakha', dayTemp: '18-25¬∞C', nightTemp: '10-15¬∞C', icon: 'üèûÔ∏è' },
        { location: 'Clima General', description: 'Octubre es ideal: d√≠as soleados y secos, noches frescas.', icon: 'üå°Ô∏è' }
    ],
    packingListData: {
        'üëï Ropa': ['6-7 Camisetas/Capas base', '2 Camisas de manga larga', '1 Forro polar', '1 Chaqueta impermeable/cortavientos', '2 Pantalones de trekking', '1 Pantal√≥n c√≥modo (ciudad)', '8-10 Pares de ropa interior', '5 Pares de calcetines de trekking', '3 Pares de calcetines casuales'],
        'üëü Calzado': ['Botas de trekking (ya usadas)', 'Zapatillas c√≥modas', 'Sandalias o chanclas (para hotel/ducha)'],
        'üéí Equipo': ['Mochila principal', 'Mochila de d√≠a (20-30L)', 'Botella de agua reutilizable', 'Gafas de sol y sombrero/gorra', 'Protector solar (SPF 50+)', 'Linterna frontal', 'Power Bank', 'Adaptador universal'],
        'üìÑ Documentos y Salud': ['Pasaporte y visados', 'Billetes de avi√≥n (digital/impreso)', 'Fotocopias y fotos carnet', 'Botiqu√≠n personal (analg√©sicos, tiritas, antidiarreico)', 'Repelente de mosquitos (para Chitwan)']
    },
    
    // Datos para el calendario interactivo
    calendarData: {
        // Generar fases din√°micamente basadas en los datos del itinerario
        get phases() {
            const phaseGroups = {};
            tripConfig.itineraryData.forEach(day => {
                const dayNumber = parseInt(day.id.replace('day-', ''));
                if (!phaseGroups[day.phase]) {
                    phaseGroups[day.phase] = [];
                }
                phaseGroups[day.phase].push(dayNumber);
            });
            
            const phaseColors = {
                'nepal': 'from-green-500 to-emerald-600',
                'butan': 'from-amber-500 to-orange-600',
                'farewell': 'from-sky-500 to-blue-600'
            };
            
            return Object.entries(phaseGroups).map(([phase, days]) => ({
                name: phase === 'nepal' ? 'Nepal' : phase === 'butan' ? 'But√°n' : 'Despedida',
                color: phaseColors[phase] || 'from-gray-500 to-slate-600',
                days: days.sort((a, b) => a - b)
            }));
        },
        
        // Generar d√≠as especiales din√°micamente basados en los vuelos
        get specialDays() {
            const special = [];
            
            // Colores gen√©ricos por tipo de vuelo
            const flightTypeColors = {
                'Internacional': 'from-red-500 to-pink-600',
                'Regional': 'from-purple-500 to-indigo-600',
                'Local': 'from-blue-500 to-cyan-600'
            };
            
            // Mapear d√≠as espec√≠ficos de vuelos manualmente bas√°ndose en la informaci√≥n del itinerario
            const flightDays = [
                { day: 1, type: 'Internacional', from: 'MAD', to: 'KTM', label: 'MAD ‚Üí KTM' },
                { day: 12, type: 'Regional', from: 'KTM', to: 'PBH', label: 'KTM ‚Üí PBH' },
                { day: 17, type: 'Regional', from: 'PBH', to: 'KTM', label: 'PBH ‚Üí KTM' },
                { day: 18, type: 'Internacional', from: 'KTM', to: 'MAD', label: 'KTM ‚Üí MAD' }
            ];
            
            flightDays.forEach(flight => {
                // Determinar icono basado en el tipo de vuelo
                const icon = flight.type === 'Internacional' ? '‚úàÔ∏è' : 
                            flight.type === 'Regional' ? 'üõ©Ô∏è' : 'üöÅ';
                
                special.push({
                    day: flight.day,
                    type: 'flight',
                    icon: icon,
                    label: flight.label,
                    color: flightTypeColors[flight.type] || 'from-gray-500 to-slate-600',
                    flightType: flight.type,
                    origin: flight.from,
                    destination: flight.to
                });
            });
            
            // Ordenar por d√≠a del viaje
            return special.sort((a, b) => a.day - b.day);
        },
        
        /**
         * Parsea la fecha de un vuelo (ej: "2025-10-09" + "22:45")
         * @param {string} dateStr - Fecha en formato ISO "2025-10-09"
         * @param {string} timeStr - Hora en formato "22:45"
         * @returns {Date} Objeto Date del vuelo
         */
        parseFlightDate(dateStr, timeStr) {
            try {
                const [hours, minutes] = timeStr.split(':');
                const flightDate = new Date(dateStr + 'T' + timeStr + ':00');
                
                return flightDate;
            } catch (error) {
                Utils.error('Error parseando fecha de vuelo:', error);
                return null;
            }
        },
        
        /**
         * Obtiene el √≠ndice del mes (0-11) a partir del nombre abreviado
         * @param {string} monthStr - Nombre del mes (ej: "Oct")
         * @returns {number} √çndice del mes (0-11)
         */
        getMonthIndex(monthStr) {
            const months = {
                'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
                'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
            };
            return months[monthStr] || 0;
        },
        
        /**
         * Calcula el d√≠a del viaje (1-18) bas√°ndose en la fecha del vuelo
         * @param {Date} flightDate - Fecha del vuelo
         * @returns {number|null} D√≠a del viaje (1-18) o null si est√° fuera del rango
         */
        calculateTripDay(flightDate) {
            if (!flightDate || !Utils.TRIP_START_DATE) return null;
            
            const timeDiff = flightDate.getTime() - Utils.TRIP_START_DATE.getTime();
            const dayDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            
            // El d√≠a 1 es el d√≠a de salida (9 Oct 2025), as√≠ que ajustamos
            const tripDay = dayDiff + 1;
            
            // Verificar que est√© en el rango v√°lido (1-18)
            if (tripDay >= 1 && tripDay <= 18) {
                return tripDay;
            }
            
            return null;
        },
        
        // Funciones para calcular din√°micamente
        getTotalDays() {
            return this.phases.reduce((total, phase) => total + phase.days.length, 0);
        },
        
        getTotalCountries() {
            return this.phases.length-1;
        },
        
        getDaysByPhase(phaseName) {
            const phase = this.phases.find(p => p.name.toLowerCase() === phaseName.toLowerCase());
            return phase ? phase.days.length : 0;
        }
    },
    
    // Lugares cercanos y relacionados por d√≠a
    placesByDay: {
        'day-1': [
            { name: 'Aeropuerto de Madrid-Barajas (MAD)', coords: [40.4936, -3.5668], icon: '‚úàÔ∏è', description: 'Punto de partida del viaje' }
        ],
        'day-2': [
            { name: 'Aeropuerto Internacional Tribhuvan (KTM)', coords: [27.6966, 85.3533], icon: 'üõ¨', description: 'Punto de llegada a Nepal' },
            { name: 'Thamel', coords: [27.7172, 85.3138], icon: 'üõçÔ∏è', description: 'Barrio tur√≠stico y centro neur√°lgico' },
            { name: 'Jard√≠n de los Sue√±os', coords: [27.7172, 85.3150], icon: 'üå≥', description: 'Oasis de paz de estilo neocl√°sico' }
        ],
        'day-3': [
            { name: 'Plaza Durbar de Katmand√∫', coords: [27.7048, 85.3074], icon: 'üèõÔ∏è', description: 'Coraz√≥n hist√≥rico y Patrimonio UNESCO' },
            { name: 'Kumari Chowk', coords: [27.7045, 85.3065], icon: 'üôè', description: 'Residencia de la diosa viviente' },
            { name: 'Asan Tole', coords: [27.708, 85.311], icon: 'üå∂Ô∏è', description: 'Mercado local aut√©ntico y bullicioso' },
            { name: 'Hotel Manang (o similar)', coords: [27.7172, 85.3138], icon: 'üè®', description: 'Punto de encuentro WeRoad' }
        ],
        'day-4': [
            { name: 'R√≠o Trisuli', coords: [27.87, 84.76], icon: 'üö£', description: 'Rafting de aguas bravas' },
            { name: 'Pokhara', coords: [28.2096, 83.9856], icon: 'üèûÔ∏è', description: 'Ciudad a orillas del lago Phewa' },
            { name: 'Barrio Tibetano (Pokhara)', coords: [28.216, 83.96], icon: 'üèòÔ∏è', description: 'Asentamiento con templo y artesan√≠a' },
            { name: 'Lago Phewa', coords: [28.2096, 83.9856], icon: '‚õµ', description: 'Vistas al Annapurna y Templo Tal Barahi' }
        ],
        'day-5': [
            { name: 'Ghandruk', coords: [28.375, 83.81], icon: 'üèîÔ∏è', description: 'Pueblo Gurung a 1.940m' },
            { name: 'Museo Gurung (Ghandruk)', coords: [28.375, 83.81], icon: 'üèõÔ∏è', description: 'Cultura e historia local' }
        ],
        'day-6': [
            { name: 'Chhomrong', coords: [28.415, 83.82], icon: 'üèîÔ∏è', description: 'Puerta del Santuario del Annapurna (2.170m)' },
            { name: 'Annapurna Sur (vista)', coords: [28.52, 83.81], icon: '‚õ∞Ô∏è', description: 'Pico de 7.219m' },
            { name: 'Machhapuchhre (vista)', coords: [28.49, 83.94], icon: '‚õ∞Ô∏è', description: 'Monta√±a sagrada \'Cola de Pez\' (6.993m)' }
        ],
        'day-7': [
            { name: 'Aguas Termales de Jhimodanda', coords: [28.33, 83.80], icon: '‚ô®Ô∏è', description: 'Piscinas naturales para relajaci√≥n muscular' },
            { name: 'Pokhara', coords: [28.2096, 83.9856], icon: 'üèûÔ∏è', description: 'Regreso a la ciudad base del trekking' }
        ],
        'day-8': [
            { name: 'Parque Nacional de Chitwan', coords: [27.5291, 84.4220], icon: 'üêò', description: 'Safari en busca de rinocerontes' },
            { name: 'R√≠o Rapti', coords: [27.57, 84.49], icon: 'üåä', description: 'Paseos al atardecer y canoas' }
        ],
        'day-9': [
            { name: 'Pueblo Tharu (Chitwan)', coords: [27.57, 84.49], icon: 'üèòÔ∏è', description: 'Cultura ind√≠gena de la regi√≥n de Terai' },
            { name: 'Katmand√∫', coords: [27.7172, 85.3240], icon: 'üèôÔ∏è', description: 'Regreso a la capital' }
        ],
        'day-10': [
            { name: 'Thamel', coords: [27.7172, 85.3138], icon: 'üõçÔ∏è', description: 'Compras, exploraci√≥n y clase de cocina' },
            { name: 'Jard√≠n de los Sue√±os', coords: [27.7172, 85.3150], icon: 'üå≥', description: 'Oasis de paz (opcional)' }
        ],
        'day-11': [
            { name: 'Swayambhunath Stupa (Templo de los Monos)', coords: [27.7147, 85.2903], icon: 'üêí', description: 'Estupa sagrada con vistas panor√°micas' },
            { name: 'Boudhanath Stupa', coords: [27.7215, 85.3615], icon: '‚ò∏Ô∏è', description: 'La estupa m√°s grande de Nepal' }
        ],
        'day-12': [
            { name: 'Aeropuerto Internacional de Paro (PBH)', coords: [27.4032, 89.4246], icon: '‚úàÔ∏è', description: 'Llegada a But√°n' },
            { name: 'Museo Nacional de But√°n', coords: [27.4287, 89.4265], icon: 'üèõÔ∏è', description: 'Historia y cultura en la atalaya Ta Dzong' },
            { name: 'Buda Dordenma', coords: [27.443, 89.637], icon: 'üôè', description: 'Estatua gigante con vistas a Thimphu' }
        ],
        'day-13': [
            { name: 'Monasterio de Tango', coords: [27.578, 89.636], icon: 'üèØ', description: 'Caminata espiritual' },
            { name: 'Instituto Nacional Zorig Chusum', coords: [27.48, 89.63], icon: 'üé®', description: 'Escuela de las 13 artes de But√°n' },
            { name: 'Museo Postal de But√°n', coords: [27.47, 89.63], icon: 'üìÆ', description: 'Crea tu propio sello postal' },
            { name: 'Tashichho Dzong', coords: [27.4897, 89.6350], icon: 'üèõÔ∏è', description: 'Sede del gobierno y cuerpo mon√°stico' }
        ],
        'day-14': [
            { name: 'Paso Dochula', coords: [27.492, 89.744], icon: 'üèîÔ∏è', description: '108 estupas y vistas del Himalaya' },
            { name: 'Chimi Lhakhang', coords: [27.57, 89.83], icon: '‚ù§Ô∏è', description: 'Templo de la Fertilidad' },
            { name: 'Punakha Dzong', coords: [27.5843, 89.8631], icon: 'üèØ', description: 'Palacio de la Gran Felicidad' },
            { name: 'Puente Colgante de Punakha', coords: [27.58, 89.86], icon: 'üåâ', description: 'Uno de los m√°s largos de But√°n' }
        ],
        'day-15': [
            { name: 'Khamsum Yuelley Namgyel Chorten', coords: [27.618, 89.861], icon: 'üèØ', description: 'Chorten sagrado con vistas al valle' }
        ],
        'day-16': [
            { name: 'Monasterio de Taktsang (Nido del Tigre)', coords: [27.4915, 89.3632], icon: 'üêÖ', description: 'El icono sagrado de But√°n' },
            { name: 'Kyichu Lhakhang', coords: [27.4411, 89.3764], icon: 'üèõÔ∏è', description: 'Uno de los templos m√°s antiguos de But√°n' }
        ],
        'day-17': [
            { name: 'Plaza Durbar de Patan', coords: [27.6736, 85.3250], icon: 'üèõÔ∏è', description: 'Patrimonio UNESCO, la \'Ciudad de la Belleza\'' },
            { name: 'Museo de Patan', coords: [27.6736, 85.3250], icon: 'üè∫', description: 'Considerado uno de los mejores de Asia' },
            { name: 'Templo Dorado (Hiranya Varna Mahavihar)', coords: [27.675, 85.323], icon: '‚ú®', description: 'Monasterio budista del siglo XII' }
        ],
        'day-18': [
            { name: 'Aeropuerto Internacional Tribhuvan (KTM)', coords: [27.6966, 85.3533], icon: '‚úàÔ∏è', description: 'Punto de partida final' }
        ]
    }
};
</script>

<!-- Bloque 2: L√≥gica de la Aplicaci√≥n (Refactorizada) -->
<script>
// ===== CONFIGURACI√ìN Y ESTADO GLOBAL =====
const AppState = {
        activeBudgetCategories: new Set(),
        isScrolling: false,
        map: null,
        expenses: JSON.parse(localStorage.getItem('tripExpensesV1')) || [],
        realCosts: JSON.parse(localStorage.getItem('tripRealCostsV1')) || {},
        modalMaps: new Map(),
        
        // Sistema de persistencia mejorado
        saveAllData() {
            try {
                localStorage.setItem('tripExpensesV1', JSON.stringify(this.expenses));
                localStorage.setItem('tripRealCostsV1', JSON.stringify(this.realCosts));
                // Los packed items se guardan autom√°ticamente en packingListV2 por el event listener
                // No necesitamos guardarlos aqu√≠ ya que se gestionan directamente en renderPackingList
                localStorage.setItem('tripThemeV1', ThemeManager.isDarkMode() ? 'dark' : 'light');
                localStorage.setItem('tripLastAccessV1', new Date().toISOString());
                Utils.log('üíæ Todos los datos guardados en localStorage');
            } catch (error) {
                Utils.error('‚ùå Error al guardar datos:', error);
            }
        },
        
        loadAllData() {
            try {
                this.expenses = JSON.parse(localStorage.getItem('tripExpensesV1')) || [];
                this.realCosts = JSON.parse(localStorage.getItem('tripRealCostsV1')) || {};
                
                // Restaurar tema
                const savedTheme = localStorage.getItem('tripThemeV1');
                if (savedTheme === 'dark') {
                    ThemeManager.enableDarkMode();
                } else if (savedTheme === 'light') {
                    ThemeManager.enableLightMode();
                }
                
                // Restaurar items empacados
                const packedItems = JSON.parse(localStorage.getItem('tripPackedItemsV1') || '[]');
                packedItems.forEach(item => ThemeManager.addPackedItem(item));
                
                const lastAccess = localStorage.getItem('tripLastAccessV1');
                if (lastAccess) {
                    Utils.log(`üì± Datos restaurados. √öltimo acceso: ${new Date(lastAccess).toLocaleString()}`);
                }
            } catch (error) {
                Utils.error('‚ùå Error al cargar datos:', error);
            }
        }
};

// ===== UTILIDADES =====
/**
 * Utilidades compartidas para toda la aplicaci√≥n
 * Proporciona funciones comunes de formateo, c√°lculo y logging
 */
const Utils = {
    /**
     * Fecha de salida del viaje (9 de octubre)
     * Se usa como base para calcular todas las fechas del itinerario
     */
    TRIP_START_DATE: new Date('2025-10-09'),

    /**
     * Calcula la fecha para un d√≠a espec√≠fico del viaje
     * @param {number} dayNumber - N√∫mero del d√≠a (0-17)
     * @returns {Date} Fecha calculada
     */
    getTripDate: (dayNumber) => {
        const date = new Date(Utils.TRIP_START_DATE);
        date.setDate(date.getDate() + dayNumber);
        return date;
    },

    /**
     * Formatea una fecha en formato corto (ej: "9 Oct")
     * @param {Date} date - Fecha a formatear
     * @returns {string} Fecha formateada
     */
    formatShortDate: (date) => {
        const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
        return `${date.getDate()} ${months[date.getMonth()]}`;
    },

    /**
     * Formatea un importe como moneda EUR
     * @param {number} amount - Importe a formatear
     * @param {boolean} round - Si redondear a n√∫meros enteros
     * @returns {string} Importe formateado (ej: "1.234,56 ‚Ç¨")
     */
    formatCurrency: (amount, round = false) => {
        const value = round ? Math.round(amount) : amount;
        return new Intl.NumberFormat('es-ES', { 
            style: 'currency', 
            currency: 'EUR', 
            minimumFractionDigits: 0, 
            maximumFractionDigits: round ? 0 : 2 
        }).format(value);
    },

    /**
     * Calcula el subtotal de una lista de items, considerando costos reales
     * @param {Array} items - Lista de items con costos
     * @returns {number} Subtotal calculado
     */
    calculateSubtotal: (items) => items.reduce((sum, item) => {
        const itemId = `${item.category}-${item.concept}`;
        if (item.subItems) {
            // Si tiene sub-items, sumar cada uno con su costo real
            return sum + item.subItems.reduce((subSum, subItem) => {
                const subItemId = `${item.category}-${item.concept}-${subItem.concept}`;
                return subSum + (AppState.realCosts[subItemId] || subItem.cost);
            }, 0);
        }
        // Si no tiene sub-items, usar el costo real o el estimado
        return sum + (AppState.realCosts[itemId] || item.cost);
    }, 0),

    /**
     * Crea el HTML del encabezado de una secci√≥n
     * @param {string} title - T√≠tulo de la secci√≥n
     * @returns {string} HTML del encabezado
     */
            createSectionHeader: (title, sectionId = null) => {
            const headerId = sectionId || title.toLowerCase().replace(/\s+/g, '-');
            return `
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-bold text-slate-900 dark:text-white">${title}</h2>
                    <button 
                        onclick="Utils.toggleSection('${headerId}')" 
                        class="p-2 rounded-lg bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors"
                        title="Colapsar/Expandir secci√≥n"
                    >
                        <svg class="w-5 h-5 transform transition-transform" id="icon-${headerId}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                </div>
                <div id="content-${headerId}" class="collapsible-section expanded transition-all duration-300" style="overflow: visible;">
            `;
        },
        
        /**
         * Alterna el estado colapsado/expandido de una secci√≥n
         * @param {string} sectionId - ID de la secci√≥n a alternar
         */
        toggleSection(sectionId) {
            const content = document.getElementById(`content-${sectionId}`);
            const icon = document.getElementById(`icon-${sectionId}`);
            
            if (content && icon) {
                // Verificar si est√° colapsado usando una clase CSS
                const isCollapsed = content.classList.contains('collapsed');
                
                if (isCollapsed) {
                    // Expandir
                    content.classList.remove('collapsed');
                    content.classList.add('expanded');
                    // Establecer maxHeight al scrollHeight para la animaci√≥n
                    content.style.maxHeight = content.scrollHeight + 'px';
                    icon.style.transform = 'rotate(0deg)';
                    
                    // Despu√©s de la animaci√≥n, quitar el maxHeight para permitir crecimiento din√°mico
                    setTimeout(() => {
                        if (content.classList.contains('expanded')) {
                            content.style.maxHeight = 'none';
                        }
                    }, 300);
                } else {
                    // Colapsar
                    // Primero establecer el maxHeight actual
                    content.style.maxHeight = content.scrollHeight + 'px';
                    
                    // Forzar un reflow
                    content.offsetHeight;
                    
                    // Luego colapsar
                    content.classList.remove('expanded');
                    content.classList.add('collapsed');
                    content.style.maxHeight = '0px';
                    icon.style.transform = 'rotate(180deg)';
                }
            }
        },
        
        /**
         * Cierra (colapsa) una secci√≥n espec√≠fica
         * @param {string} sectionId - ID de la secci√≥n a cerrar
         */
        closeSection(sectionId) {
            const content = document.getElementById(`content-${sectionId}`);
            const icon = document.getElementById(`icon-${sectionId}`);
            
            if (content && icon) {
                content.classList.remove('expanded');
                content.classList.add('collapsed');
                icon.style.transform = 'rotate(180deg)';
            }
        },
        
        /**
         * Inicializa todas las secciones como expandidas
         */
        initializeSections() {
            // Buscar todos los contenedores de contenido de secciones
            const sectionContents = document.querySelectorAll('[id^="content-"]');
            
            sectionContents.forEach(content => {
                // Asegurar que est√© expandido por defecto
                content.classList.remove('collapsed');
                content.classList.add('expanded');
                
                // Obtener el icono correspondiente
                const sectionId = content.id.replace('content-', '');
                const icon = document.getElementById(`icon-${sectionId}`);
                if (icon) {
                    icon.style.transform = 'rotate(0deg)';
                }
            });
        },

    /**
     * Implementa debounce para optimizar llamadas frecuentes
     * @param {Function} func - Funci√≥n a ejecutar
     * @param {number} wait - Tiempo de espera en ms
     * @returns {Function} Funci√≥n con debounce aplicado
     */
    debounce: (func, wait) => {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    },

    /**
     * Log de informaci√≥n con prefijo de la aplicaci√≥n
     * @param {string} message - Mensaje a mostrar
     * @param {*} data - Datos adicionales opcionales
     */
    log: (message, data = null) => {
        console.log(`üèîÔ∏è [Himalaya App] ${message}`, data || '');
    },

    /**
     * Log de errores con prefijo de la aplicaci√≥n
     * @param {string} message - Mensaje de error
     * @param {Error} error - Objeto de error opcional
     */
    error: (message, error = null) => {
        console.error(`‚ùå [Himalaya App] ${message}`, error || '');
    }
};

// ===== GESTORES DE UI =====
/**
 * Gestor del sistema de temas (claro/oscuro)
 * Maneja la alternancia entre modos y persiste la preferencia del usuario
 */
const ThemeManager = {
    /**
     * Inicializa el gestor de temas
     * Configura el tema inicial basado en localStorage o preferencias del sistema
     */
        init() {
        Utils.log('Inicializando Theme Manager');
            this.toggleBtn = document.getElementById('theme-toggle');
            this.lightIcon = document.getElementById('theme-toggle-light-icon');
            this.darkIcon = document.getElementById('theme-toggle-dark-icon');
            this.themeText = document.getElementById('theme-text');
        
        // Configurar tema inicial: priorizar localStorage, luego preferencias del sistema
        if (localStorage.getItem('color-theme') === 'dark' || 
            (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
        
            this.updateUI();
            this.toggleBtn.addEventListener('click', () => this.toggle());
        },

    /**
     * Alterna entre tema claro y oscuro
     * Actualiza localStorage y la interfaz de usuario
     */
        toggle() {
            document.documentElement.classList.toggle('dark');
        const isDark = document.documentElement.classList.contains('dark');
        localStorage.setItem('color-theme', isDark ? 'dark' : 'light');
            this.updateUI();
        Utils.log(`Tema cambiado a: ${isDark ? 'oscuro' : 'claro'}`);
        },

    /**
     * Actualiza la interfaz seg√∫n el tema activo
     * Muestra/oculta iconos y actualiza el texto del bot√≥n
     */
        updateUI() {
            const isDark = document.documentElement.classList.contains('dark');
            this.lightIcon.classList.toggle('hidden', isDark);
            this.darkIcon.classList.toggle('hidden', !isDark);
            this.themeText.textContent = isDark ? 'Modo Claro' : 'Modo Oscuro';
        }
    };

/**
 * Gestor de la barra lateral de navegaci√≥n
 * Maneja la apertura/cierre, responsive design y auto-ocultaci√≥n en m√≥viles
 */
const SidebarManager = {
    /**
     * Inicializa el gestor de sidebar
     * Configura event listeners y estado inicial seg√∫n el tama√±o de pantalla
     */
        init() {
        Utils.log('Inicializando Sidebar Manager');
            this.sidebar = document.getElementById('sidebar');
            this.mainContent = document.getElementById('main-content');
            this.toggleBtn = document.getElementById('sidebar-toggle');
            this.openIcon = document.getElementById('menu-open-icon');
            this.closeIcon = document.getElementById('menu-close-icon');
        
            this.toggleBtn.addEventListener('click', () => this.toggle());
        
        // Auto-ocultar en m√≥viles cuando se hace clic fuera del sidebar
        document.addEventListener('click', (e) => this.handleOutsideClick(e));
        
        // Configurar estado inicial seg√∫n el tama√±o de pantalla
        if (window.innerWidth < 1024) {
            this.sidebar.classList.add('is-hidden');
        } else {
            this.mainContent.classList.add('lg:ml-72');
        }
        
            this.updateUI();
        
        // Escuchar cambios de tama√±o de ventana con debounce
        window.addEventListener('resize', Utils.debounce(() => {
            this.handleResize();
        }, 250));
    },

    /**
     * Maneja clics fuera del sidebar en dispositivos m√≥viles
     * @param {Event} e - Evento de clic
     */
    handleOutsideClick(e) {
        // Solo en dispositivos m√≥viles (pantalla < 1024px)
        if (window.innerWidth >= 1024) return;
        
        // Si el sidebar est√° visible y el clic no es en el sidebar ni en el bot√≥n de toggle
        if (!this.sidebar.classList.contains('is-hidden') && 
            !this.sidebar.contains(e.target) && 
            !this.toggleBtn.contains(e.target)) {
            this.hide();
        }
    },

    /**
     * Oculta el sidebar program√°ticamente
     * √ötil para auto-ocultaci√≥n en m√≥viles
     */
    hide() {
        if (!this.sidebar.classList.contains('is-hidden')) {
            this.sidebar.classList.add('is-hidden');
            this.updateUI();
            Utils.log('Sidebar ocultado autom√°ticamente');
        }
    },

    /**
     * Alterna la visibilidad del sidebar
     * Ajusta el margen del contenido principal en desktop
     */
        toggle() {
            const isHidden = this.sidebar.classList.toggle('is-hidden');
            this.updateUI();
        if (window.innerWidth >= 1024) {
            this.mainContent.classList.toggle('lg:ml-72', !isHidden);
        }
        Utils.log(`Sidebar ${isHidden ? 'ocultado' : 'mostrado'}`);
    },

    /**
     * Maneja cambios de tama√±o de ventana
     * Ajusta el layout seg√∫n el breakpoint de pantalla
     */
    handleResize() {
        if (window.innerWidth >= 1024 && !this.sidebar.classList.contains('is-hidden')) {
            this.mainContent.classList.add('lg:ml-72');
        } else if (window.innerWidth < 1024) {
            this.mainContent.classList.remove('lg:ml-72');
        }
    },

    /**
     * Actualiza la interfaz del sidebar
     * Muestra/oculta iconos seg√∫n el estado actual
     */
        updateUI() {
            const isHidden = this.sidebar.classList.contains('is-hidden');
            this.openIcon.classList.toggle('hidden', !isHidden);
            this.closeIcon.classList.toggle('hidden', isHidden);
        }
    };

const ParallaxManager = {
        init() {
        Utils.log('Inicializando Parallax Manager');
            this.bg = document.getElementById('parallax-bg');
            window.addEventListener('scroll', () => {
            if (!AppState.isScrolling) {
                    window.requestAnimationFrame(() => {
                        this.update();
                    AppState.isScrolling = false;
                    });
                AppState.isScrolling = true;
                }
            }, { passive: true });
        },

        update() {
            const scrolled = window.scrollY;
            const scale = 1.1 - (scrolled * 0.0001);
        if (this.bg) {
            this.bg.style.transform = `translate3d(0, ${scrolled * 0.3}px, 0) scale(${Math.max(1, scale)})`;
        }
        }
    };

const NavigationManager = {
        init() {
        Utils.log('Inicializando Navigation Manager');
            this.navLinksContainer = document.getElementById('nav-links');
            if (!this.navLinksContainer) {
                Utils.log('Navigation links container no encontrado, saltando Navigation Manager');
                return;
            }
            this.sections = document.querySelectorAll('main section[data-nav]');
            this.render();
            this.observeSections();
        },

        render() {
            if (!this.navLinksContainer) return;
            
            try {
                this.navLinksContainer.innerHTML = Array.from(this.sections).map(section => `
                    <li>
                        <a href="#${section.id}" data-nav-link="${section.id}" class="flex items-center gap-3 px-3 py-2 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 font-medium transition-colors">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="${section.dataset.icon}"></path></svg>
                            <span>${section.dataset.nav}</span>
                        </a>
                    </li>`).join('');
            } catch (error) {
                Utils.error('Error al renderizar navegaci√≥n:', error);
            }
        },

        observeSections() {
            if (!this.navLinksContainer) return;
            
            try {
                const observer = new IntersectionObserver(entries => {
                    entries.forEach(entry => {
                        const id = entry.target.getAttribute('id');
                        const navLink = this.navLinksContainer.querySelector(`[data-nav-link="${id}"]`);
                        if (entry.isIntersecting && navLink) {
                            this.navLinksContainer.querySelectorAll('a').forEach(l => l.classList.remove('bg-blue-100', 'dark:bg-blue-900/50', 'text-blue-600', 'dark:text-blue-400'));
                            navLink.classList.add('bg-blue-100', 'dark:bg-blue-900/50', 'text-blue-600', 'dark:text-blue-400');
                        }
                    });
                }, { rootMargin: '-40% 0px -60% 0px' });
                this.sections.forEach(section => observer.observe(section));
            } catch (error) {
                Utils.error('Error al observar secciones:', error);
            }
        }
    };

const PDFExporter = {
        init() {
        Utils.log('Inicializando PDF Exporter');
            this.btn = document.getElementById('export-pdf-btn');
            this.modal = document.getElementById('pdf-modal');
            this.optionsContainer = document.getElementById('pdf-options');
            
            // Only initialize if all required elements exist
            if (!this.btn || !this.modal || !this.optionsContainer) {
                Utils.log('Elementos de PDF no encontrados, saltando PDF Exporter');
                return;
            }
        
            this.btn.addEventListener('click', () => this.showModal());
            document.getElementById('pdf-cancel')?.addEventListener('click', () => this.hideModal());
            document.getElementById('pdf-confirm')?.addEventListener('click', () => this.export());
        },

        showModal() {
            if (!this.optionsContainer || !this.modal) return;
            
            try {
                this.optionsContainer.innerHTML = Array.from(document.querySelectorAll('main section[data-nav]')).map(section => `
                    <label class="flex items-center gap-3 p-3 rounded-lg bg-slate-100 dark:bg-slate-700">
                        <input type="checkbox" name="pdf-section" value="${section.id}" checked class="h-5 w-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                        <span>${section.dataset.nav}</span>
                    </label>`).join('');
            
                this.modal.classList.remove('hidden');
                this.modal.classList.add('flex');
                Utils.log('Modal de PDF mostrado');
            } catch (error) {
                Utils.error('Error al mostrar modal de PDF:', error);
            }
        },

        hideModal() {
            if (!this.modal) return;
            
            try {
                this.modal.classList.add('hidden');
                this.modal.classList.remove('flex');
                Utils.log('Modal de PDF ocultado');
            } catch (error) {
                Utils.error('Error al ocultar modal de PDF:', error);
            }
        },

        async export() {
        Utils.log('Iniciando exportaci√≥n a PDF');
            alert('La exportaci√≥n personalizada a PDF es una funcionalidad avanzada. ¬°Gracias por probar!');
            this.hideModal();
        }
    };

/**
 * Renderizador principal de la interfaz de usuario
 * Coordina la creaci√≥n y actualizaci√≥n de todas las secciones de la aplicaci√≥n
 */
const UIRenderer = {
        /**
         * Inicializa el renderizador de UI
         * Renderiza todas las secciones en el orden correcto
         */
        init() {
            Utils.log('Inicializando UI Renderer');
            this.renderSummary();
            this.renderOverview();
            this.renderFlights();
            this.renderMap();
            this.renderItinerary();
            this.renderBudget();
            this.renderWeather();
            this.renderPackingList();
            this.renderTourPackages();
            Utils.log('Todas las secciones renderizadas');
        },
        renderSummary() {
            const container = document.getElementById('summary');
            if (!container) {
                Utils.error('Container summary no encontrado');
                return;
            }
            
            try {
                const grandTotal = Utils.calculateSubtotal(Object.values(tripConfig.budgetData).flat());
                // Calcular estad√≠sticas din√°micamente
                const totalDays = tripConfig.calendarData.getTotalDays();
                const totalCountries = tripConfig.calendarData.getTotalCountries();
                const costPerDay = grandTotal / totalDays;
                
                const stats = [
                    { value: totalDays.toString(), label: 'D√≠as de Viaje' },
                    { value: totalCountries.toString(), label: 'Pa√≠ses Incre√≠bles' },
                    { value: Utils.formatCurrency(grandTotal, true), label: 'Presupuesto Total' },
                    { value: `~${Utils.formatCurrency(costPerDay, true)}`, label: 'Coste por D√≠a' }
                ];
                // Calcular estilos del viaje din√°micamente bas√°ndose en las actividades
                const tripStyles = this.calculateTripStyles();
               
                const statsHTML = stats.map((stat, index) => {
                    const icons = ['schedule', 'public', 'account_balance_wallet', 'payments'];
                    const colors = ['from-blue-500 to-blue-600', 'from-green-500 to-green-600', 'from-orange-500 to-orange-600', 'from-purple-500 to-purple-600'];
                    return `<div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 text-center hover:shadow-xl transition-all duration-300">
                        <div class="w-12 h-12 bg-gradient-to-br ${colors[index]} rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <span class="material-symbols-outlined text-white text-xl">${icons[index]}</span>
                        </div>
                        <p class="text-3xl font-bold text-slate-900 dark:text-white break-words">${stat.value}</p>
                        <p class="text-sm font-medium text-slate-600 dark:text-slate-400 mt-2">${stat.label}</p>
                    </div>`;
                }).join('');
                const stylesHTML = tripStyles.map(style => `<div class="text-center flex-1 min-w-0"><div class="relative w-full aspect-square max-w-32 mx-auto"><svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100"><circle class="text-slate-200 dark:text-slate-700" stroke-width="8" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" /><circle class="${style.color}" stroke-width="8" stroke-dasharray="283" stroke-dashoffset="${283 - (283 * style.percentage) / 100}" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" /></svg><span class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-2xl sm:text-3xl lg:text-4xl">${style.emoji}</span></div><p class="font-semibold mt-2 sm:mt-3 text-sm sm:text-base lg:text-lg">${style.title}</p></div>`).join('');
                

                
                container.innerHTML = `<div class="space-y-12"><div class="grid grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">${statsHTML}</div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div><h3 class="text-xl font-bold text-slate-900 dark:text-white mb-6">Estilo del Viaje</h3><div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700"><div class="flex justify-between gap-2 sm:gap-4 lg:gap-8">${stylesHTML}</div></div></div><div><h3 class="text-xl font-bold text-slate-900 dark:text-white mb-6">Calendario del Viaje</h3><div id="summary-calendar" class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700"></div></div></div>`;
                
                // Renderizar el calendario en el contenedor del resumen
                setTimeout(() => {
                    const summaryCalendar = document.getElementById('summary-calendar');
                    if (summaryCalendar) {
                        this.renderCalendar(summaryCalendar);
                    }
                }, 100);
                
                // Actualizar las fechas del viaje
                this.updateTripDates();
            } catch (error) {
                Utils.error('Error al renderizar summary:', error);
                container.innerHTML = `<div class="bg-red-100 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 text-red-700 dark:text-red-400">
                    <h3 class="font-semibold">Error al cargar el resumen del viaje</h3>
                    <p class="text-sm">${error.message}</p>
                </div>`;
            }
        },
        updateTodayInfo() {
            try {
                // Obtener el d√≠a actual del viaje
                const today = new Date();
                const tripStartDate = this.getTripStartDate(); // Fecha calculada din√°micamente
                const dayDiff = Math.floor((today - tripStartDate) / (1000 * 60 * 60 * 24));
                
                // Actualizar las fechas del viaje en el header
                this.updateTripDates();
                
                if (dayDiff >= 0 && dayDiff < tripConfig.itineraryData.length) {
                    const currentDayData = tripConfig.itineraryData[dayDiff];
                    
                    // Actualizar elementos del panel de hoy
                    const todayDate = document.getElementById('today-date');
                    const todayDay = document.getElementById('today-day');
                    const nextDestination = document.getElementById('next-destination');
                    const todayAccommodation = document.getElementById('today-accommodation');
                    const todayActivity = document.getElementById('today-activity');
                    const todayWeather = document.getElementById('today-weather');
                    
                    if (todayDate) todayDate.textContent = Utils.formatShortDate(today);
                    if (todayDay) todayDay.textContent = `D√≠a ${dayDiff + 1}`;
                    if (nextDestination) nextDestination.textContent = currentDayData.title;
                    if (todayAccommodation) todayAccommodation.textContent = currentDayData.accommodation || 'Por definir';
                    if (todayActivity) todayActivity.textContent = currentDayData.planA || 'Actividades del d√≠a';
                    
                    // Mostrar clima del d√≠a actual
                    if (todayWeather) {
                        const weatherInfo = tripConfig.weatherData.find(w => w.dayTemp && w.location === currentDayData.location);
                        if (weatherInfo) {
                            todayWeather.innerHTML = `
                                <div class="flex items-center gap-2">
                                    <span class="text-2xl">${weatherInfo.icon}</span>
                                    <div>
                                        <p class="text-sm font-semibold">${weatherInfo.dayTemp}¬∞C / ${weatherInfo.nightTemp}¬∞C</p>
                                        <p class="text-xs opacity-80">${weatherInfo.description}</p>
                                    </div>
                                </div>
                            `;
                        } else {
                            todayWeather.innerHTML = '<span class="text-sm opacity-80">Clima no disponible</span>';
                        }
                    }
                    
                    // Expandir el panel para mostrar m√°s informaci√≥n
                    const todayPanel = document.getElementById('today-panel');
                    if (todayPanel) {
                        const expandedContent = `
                            <div class="mt-6 space-y-4">
                                <div class="bg-white/20 rounded-lg p-4">
                                    <h4 class="font-semibold mb-2">üìã Plan A - Actividades Principales</h4>
                                    <p class="text-sm">${currentDayData.planA || 'No hay actividades programadas'}</p>
                                </div>
                                
                                <div class="bg-white/20 rounded-lg p-4">
                                    <h4 class="font-semibold mb-2">‚òï Plan B - Tiempo Libre</h4>
                                    <p class="text-sm">${currentDayData.planB || 'Tiempo libre para explorar'}</p>
                                </div>
                                
                                <div class="bg-white/20 rounded-lg p-4">
                                    <h4 class="font-semibold mb-2">üí° Consejo del D√≠a</h4>
                                    <p class="text-sm">${currentDayData.consejo || 'Disfruta cada momento de tu aventura'}</p>
                                </div>
                                
                                <div class="bg-white/20 rounded-lg p-4">
                                    <h4 class="font-semibold mb-2">üòã Bocado del D√≠a</h4>
                                    <p class="text-sm">${currentDayData.bocado || 'Prueba la gastronom√≠a local'}</p>
                                </div>
                                
                                ${currentDayData.coords ? `
                                <div class="bg-white/20 rounded-lg p-4">
                                    <button onclick="switchToView('map')" class="text-xs bg-white/20 hover:bg-white/30 px-3 py-1 rounded-full transition-colors">
                                        Ver en mapa
                                    </button>
                                </div>
                                ` : ''}
                            </div>
                        `;
                        
                        // Buscar si ya existe contenido expandido
                        const existingExpanded = todayPanel.querySelector('.expanded-content');
                        if (!existingExpanded) {
                            const expandedDiv = document.createElement('div');
                            expandedDiv.className = 'expanded-content';
                            expandedDiv.innerHTML = expandedContent;
                            todayPanel.appendChild(expandedDiv);
                        }
                    }
                    
                    Utils.log(`‚úÖ Informaci√≥n del d√≠a ${dayDiff + 1} actualizada`);
                } else {
                    Utils.log('üìÖ Fuera del per√≠odo del viaje');
                }
            } catch (error) {
                Utils.error('Error al actualizar informaci√≥n del d√≠a:', error);
            }
        },
        renderOverview() {
            const container = document.getElementById('overview');
            if (!container) {
                Utils.error('Container overview no encontrado');
                return;
            }
            
            try {
                const grandTotal = Utils.calculateSubtotal(Object.values(tripConfig.budgetData).flat());
                // Calcular estad√≠sticas din√°micamente
                const totalDays = tripConfig.calendarData.getTotalDays();
                const totalCountries = tripConfig.calendarData.getTotalCountries();
                const costPerDay = grandTotal / totalDays;
                
                const stats = [
                    { value: totalDays.toString(), label: 'D√≠as de Viaje' },
                    { value: totalCountries.toString(), label: 'Pa√≠ses Incre√≠bles' },
                    { value: Utils.formatCurrency(grandTotal, true), label: 'Presupuesto Total' },
                    { value: `~${Utils.formatCurrency(costPerDay, true)}`, label: 'Coste por D√≠a' }
                ];
                // Calcular estilos del viaje din√°micamente bas√°ndose en las actividades
                const tripStyles = this.calculateTripStyles();
               
                const statsHTML = stats.map((stat, index) => {
                    const icons = ['schedule', 'public', 'account_balance_wallet', 'payments'];
                    const colors = ['from-blue-500 to-blue-600', 'from-green-500 to-green-600', 'from-orange-500 to-orange-600', 'from-purple-500 to-purple-600'];
                    return `<div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 text-center hover:shadow-xl transition-all duration-300">
                        <div class="w-12 h-12 bg-gradient-to-br ${colors[index]} rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <span class="material-symbols-outlined text-white text-xl">${icons[index]}</span>
                        </div>
                        <p class="text-3xl font-bold text-slate-900 dark:text-white break-words">${stat.value}</p>
                        <p class="text-sm font-medium text-slate-600 dark:text-slate-400 mt-2">${stat.label}</p>
                    </div>`;
                }).join('');
                const stylesHTML = tripStyles.map(style => `<div class="text-center flex-1 min-w-0"><div class="relative w-full aspect-square max-w-32 mx-auto"><svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100"><circle class="text-slate-200 dark:text-slate-700" stroke-width="8" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" /><circle class="${style.color}" stroke-width="8" stroke-dasharray="283" stroke-dashoffset="${283 - (283 * style.percentage) / 100}" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" /></svg><span class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-2xl sm:text-3xl lg:text-4xl">${style.emoji}</span></div><p class="font-semibold mt-2 sm:mt-3 text-sm sm:text-base lg:text-lg">${style.title}</p></div>`).join('');
                // Contenido simplificado para la secci√≥n de overview
                const additionalInfo = `
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                        <h4 class="font-bold text-lg text-slate-900 dark:text-white mb-4">Informaci√≥n Adicional</h4>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-slate-600 dark:text-slate-400">Documentaci√≥n:</span>
                                <span class="font-semibold">Pasaporte + Visa</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-slate-600 dark:text-slate-400">Moneda Principal:</span>
                                <span class="font-semibold">NPR (Nepal) / BTN (But√°n)</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-slate-600 dark:text-slate-400">Idiomas:</span>
                                <span class="font-semibold">Nepal√≠, Dzongkha, Ingl√©s</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-slate-600 dark:text-slate-400">Zona Horaria:</span>
                                <span class="font-semibold">UTC+6 (But√°n), UTC+5:45 (Nepal)</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                        <h4 class="font-bold text-lg text-slate-900 dark:text-white mb-4">Consejos de Viaje</h4>
                        <ul class="space-y-2 text-slate-600 dark:text-slate-400">
                            <li class="flex items-start gap-2"><span class="text-blue-500">‚Ä¢</span> Llevar ropa de abrigo para las monta√±as</li>
                            <li class="flex items-start gap-2"><span class="text-blue-500">‚Ä¢</span> Preparar medicamentos para el mal de altura</li>
                            <li class="flex items-start gap-2"><span class="text-blue-500">‚Ä¢</span> Respetar las costumbres locales en templos</li>
                            <li class="flex items-start gap-2"><span class="text-blue-500">‚Ä¢</span> Llevar efectivo para compras locales</li>
                        </ul>
                    </div>
                `;
                
                container.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">${additionalInfo}</div>`;
                
                // No calendar needed in overview anymore
            } catch (error) {
                Utils.error('Error al renderizar overview:', error);
                container.innerHTML = `<div class="bg-red-100 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 text-red-700 dark:text-red-400">
                    <h3 class="font-semibold">Error al cargar la informaci√≥n adicional</h3>
                    <p class="text-sm">${error.message}</p>
                </div>`;
            }
        },
        
        /**
         * Genera las fases del itinerario din√°micamente bas√°ndose en los datos reales
         * @returns {Array} Array de fases con t√≠tulo y phase
         */
        generateItineraryPhases() {
            // Mapear fases a nombres y emojis
            const phaseMapping = {
                'nepal': { name: 'üá≥üáµ Aventura en Nepal', emoji: 'üá≥üáµ' },
                'butan': { name: 'üáßüáπ El Reino del Drag√≥n', emoji: 'üáßüáπ' },
                'farewell': { name: '‚úàÔ∏è Despedida del Himalaya', emoji: '‚úàÔ∏è' }
            };
            
            // Agrupar d√≠as por fase y generar fases ordenadas
            const phaseGroups = tripConfig.itineraryData.reduce((groups, day) => {
                if (!groups[day.phase]) groups[day.phase] = [];
                groups[day.phase].push(day);
                return groups;
            }, {});
            
            return Object.entries(phaseGroups)
                .map(([phaseKey, days], index) => {
                    const phaseInfo = phaseMapping[phaseKey] || { name: phaseKey, emoji: 'üåç' };
                    const sortedDays = days.sort((a, b) => 
                        parseInt(a.id.replace('day-', '')) - parseInt(b.id.replace('day-', ''))
                    );
                    
                    return {
                        title: `Parte ${index + 1}: ${phaseInfo.name}`,
                        phase: phaseKey,
                        days: sortedDays,
                        emoji: phaseInfo.emoji
                    };
                })
                .sort((a, b) => 
                    parseInt(a.days[0].id.replace('day-', '')) - parseInt(b.days[0].id.replace('day-', ''))
                );
        },
        
        /**
         * Calcula los estilos del viaje din√°micamente bas√°ndose en las actividades del itinerario
         * @returns {Array} Array de estilos con t√≠tulo, porcentaje, color y emoji
         */
        calculateTripStyles() {
            // Definir categor√≠as de actividades y sus pesos
            const activityCategories = {
                'naturaleza': { keywords: ['trekking', 'rafting', 'parque', 'monta√±a', 'selva', 'r√≠o', 'lago'], emoji: 'üå≤', color: 'text-green-500' },
                'cultura': { keywords: ['templo', 'monasterio', 'museo', 'plaza', 'durbar', 'dzong', 'estupa'], emoji: 'üèõÔ∏è', color: 'text-amber-500' },
                'ciudad': { keywords: ['thamel', 'pokhara', 'thimphu', 'paro', 'katmand√∫', 'mercado', 'restaurante'], emoji: 'üèôÔ∏è', color: 'text-red-500' },
                'aventura': { keywords: ['parapente', 'rafting', 'trekking', 'safari'], emoji: 'üèîÔ∏è', color: 'text-purple-500' },
                'relax': { keywords: ['aguas termales', 'spa', 'descanso', 'tarde libre'], emoji: 'üèñÔ∏è', color: 'text-sky-500' }
            };
            
            // Contar actividades por categor√≠a
            const categoryCounts = {};
            const totalDays = tripConfig.itineraryData.length;
            
            // Inicializar contadores
            Object.keys(activityCategories).forEach(category => {
                categoryCounts[category] = 0;
            });
            
            // Analizar cada d√≠a del itinerario
            tripConfig.itineraryData.forEach(day => {
                const dayText = `${day.title} ${day.description} ${day.planA} ${day.planB}`.toLowerCase();
                
                Object.entries(activityCategories).forEach(([category, config]) => {
                    if (config.keywords.some(keyword => dayText.includes(keyword))) {
                        categoryCounts[category]++;
                    }
                });
            });
            
            // Calcular porcentajes y generar estilos
            return Object.entries(categoryCounts)
                .filter(([_, count]) => count > 0)
                .map(([category, count]) => {
                    const config = activityCategories[category];
                    return {
                        title: this.capitalizeFirst(category),
                        percentage: Math.round((count / totalDays) * 100),
                        color: config.color,
                        emoji: config.emoji
                    };
                })
                .sort((a, b) => b.percentage - a.percentage);
        },
        
        /**
         * Capitaliza la primera letra de una cadena
         * @param {string} str - Cadena a capitalizar
         * @returns {string} Cadena con primera letra may√∫scula
         */
        capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        },
        
        renderTourPackages() {
            const container = document.getElementById('tour-packages');
            if (!container) {
                Utils.error('Container tour-packages no encontrado');
                return;
            }
            
            try {
                container.innerHTML = `
                    <div class="grid md:grid-cols-2 gap-6">
                        <a href="https://www.weroad.es/viajes/nepal-360" target="_blank" 
                           class="block bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 hover:border-blue-500 dark:hover:border-blue-400 transition-all duration-300">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="material-symbols-outlined text-2xl text-blue-600 dark:text-blue-400">travel_explore</span>
                                <div>
                                    <h3 class="font-bold text-lg text-blue-600 dark:text-blue-400">Nepal 360¬∞</h3>
                                    <p class="text-sm text-slate-500 dark:text-slate-400">por WeRoad</p>
                                </div>
                            </div>
                            <div class="text-sm text-slate-600 dark:text-slate-400 space-y-1">
                                <p>‚Ä¢ 11 d√≠as de aventura</p>
                                <p>‚Ä¢ Katmand√∫, Pokhara, Chitwan</p>
                                <p>‚Ä¢ Trekking, Rafting, Safari</p>
                            </div>
                        </a>
                        
                        <a href="https://www.bhutan-acorn.com/tour/6-days-best-of-bhutan-tour" target="_blank" 
                           class="block bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 hover:border-green-500 dark:hover:border-green-400 transition-all duration-300">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="material-symbols-outlined text-2xl text-green-600 dark:text-green-400">landscape</span>
                                <div>
                                    <h3 class="font-bold text-lg text-green-600 dark:text-green-400">Best of Bhutan Tour</h3>
                                    <p class="text-sm text-slate-500 dark:text-slate-400">por Bhutan Acorn Tours</p>
                                </div>
                            </div>
                            <div class="text-sm text-slate-600 dark:text-slate-400 space-y-1">
                                <p>‚Ä¢ 6 d√≠as m√°gicos</p>
                                <p>‚Ä¢ Thimphu, Paro, Punakha</p>
                                <p>‚Ä¢ Monasterios, Dzongs, Trekking</p>
                            </div>
                        </a>
                    </div>
                `;
            } catch (error) {
                Utils.error('Error al renderizar tour-packages:', error);
                container.innerHTML = `<div class="bg-red-100 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 text-red-700 dark:text-red-400">
                    <h3 class="font-semibold">Error al cargar los paquetes de viaje</h3>
                    <p class="text-sm">${error.message}</p>
                </div>`;
            }
        },
        renderFlights() {
            const container = document.getElementById('flights');
            if (!container) {
                Utils.error('Container flights no encontrado');
                return;
            }
            
            try {
                // Buscar el contenedor espec√≠fico dentro de la secci√≥n
                const flightsContent = document.getElementById('flights-content') || container;
                
                const flightSegmentHTML = (segment) => `
                    <div class="flex items-center gap-4 p-4 bg-slate-50 dark:bg-slate-700/30 rounded-2xl">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center">
                            <span class="material-symbols-outlined text-white">flight</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-bold text-lg">${segment.from}</p>
                                    <p class="text-sm text-slate-500">${segment.fromDateTime}</p>
                                </div>
                                <div class="flex items-center gap-2 text-slate-400">
                                    <div class="w-8 border-t border-dashed"></div>
                                    <span class="material-symbols-outlined">flight_takeoff</span>
                                    <div class="w-8 border-t border-dashed"></div>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-lg">${segment.to}</p>
                                    <p class="text-sm text-slate-500">${segment.toDateTime}</p>
                                </div>
                            </div>
                        </div>
                    </div>`;
                
                const flightCardHTML = (flight) => `
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-2xl border border-slate-200 dark:border-slate-700 hover:shadow-3xl transition-all duration-200">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center">
                                <span class="material-symbols-outlined text-white text-lg">flight</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg text-slate-900 dark:text-white">${flight.title}</h3>
                                <p class="text-sm text-slate-500 dark:text-slate-400">${flight.airline}</p>
                            </div>
                        </div>
                        <div class="space-y-4">
                            ${flight.segments.map((segment, index) => `
                                ${index > 0 && flight.segments[index-1].layover ? 
                                    `<div class="text-center py-2">
                                        <div class="inline-flex items-center gap-2 bg-orange-100 dark:bg-orange-900/20 text-orange-600 dark:text-orange-400 px-3 py-1 rounded-full text-sm">
                                            <span class="material-symbols-outlined text-xs">schedule</span>
                                            ${flight.segments[index-1].layover}
                                        </div>
                                    </div>` : ''}
                                ${flightSegmentHTML(segment)}
                            `).join('')}
                        </div>
                    </div>`;
                
                const internationalFlights = tripConfig.flightsData.filter(f => f.type === 'Internacional');
                const regionalFlights = tripConfig.flightsData.filter(f => f.type === 'Regional');
                
                flightsContent.innerHTML = `
                    <div class="space-y-8">
                        ${flightCardHTML(internationalFlights[0])}
                        <div class="grid md:grid-cols-2 gap-6">
                            ${regionalFlights.map(flightCardHTML).join('')}
                        </div>
                        ${flightCardHTML(internationalFlights[1])}
                    </div>`;
            } catch (error) {
                Utils.error('Error al renderizar flights:', error);
                container.innerHTML = `<div class="bg-red-100 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 text-red-700 dark:text-red-400">
                    <h3 class="font-semibold">Error al cargar los vuelos</h3>
                    <p class="text-sm">${error.message}</p>
                </div>`;
            }
        },
        renderMap() {
            Utils.log('üó∫Ô∏è Renderizando mapa principal');
            const container = document.getElementById('map-section');
            if (!container) {
                Utils.error('Container map-section no encontrado');
                return;
            }
            
            try {
                // Buscar el contenedor espec√≠fico dentro de la secci√≥n
                const mapContent = document.getElementById('map-content') || container;
                
                mapContent.innerHTML = `
                    <div id="map" class="w-full h-screen rounded-2xl overflow-hidden shadow-lg"></div>
                `;
                setTimeout(() => {
                    try {
                        AppState.map = L.map('map', { closePopupOnClick: false }).setView([28.3949, 84.1240], 7);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap &copy; CARTO' }).addTo(AppState.map);
                    const latlngs = tripConfig.itineraryData.reduce((acc, day) => {
                        if (day.coords) {
                            const dayNumber = parseInt(day.id.replace('day-', ''));
                            const tripDate = Utils.getTripDate(dayNumber - 1);
                            const popupContent = `<div class="w-48"><img src="${day.image || 'https://placehold.co/400x200/4f46e5/ffffff?text=Himalaya'}" class="w-full h-24 object-cover rounded-t-lg" alt="${day.title}"><div class="p-2"><b class="text-blue-600">${day.title}</b><p class="text-xs">D√≠a ${dayNumber} - ${Utils.formatShortDate(tripDate)}</p><p class="text-xs text-slate-600 mt-1">${day.description.substring(0, 80)}...</p><a href="#${day.id}" class="text-blue-500 text-xs font-semibold mt-1 block">Ver detalles ‚Üí</a></div></div>`;
                            const marker = L.marker(day.coords, { icon: L.divIcon({ className: 'custom-div-icon', html: `<div class="w-8 h-8 bg-white dark:bg-slate-800 rounded-full flex items-center justify-center text-lg shadow-md border-2 border-blue-500">${day.icon}</div>`, iconSize: [30, 42], iconAnchor: [15, 42] })                         }).addTo(AppState.map).bindPopup(popupContent, { offset: L.point(0, -20), autoClose: false, closeButton: true });
                            
                            let hoverTimeout;
                            marker.on('mouseover', function () { clearTimeout(hoverTimeout); this.openPopup(); });
                            marker.on('mouseout', function () { hoverTimeout = setTimeout(() => this.closePopup(), 2000); });
                            marker.on('click', () => { 
                                clearTimeout(hoverTimeout); 
                                // Switch to itinerary view first, then scroll to the day
                                switchToView('itinerary');
                                setTimeout(() => {
                                    document.getElementById(day.id)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }, 300);
                            });

                            acc.push(day.coords);
                        }
                        return acc;
                    }, []);
                    const polyline = L.polyline(latlngs, {color: '#2563eb', weight: 3}).addTo(AppState.map);
                    L.polylineDecorator(polyline, { patterns: [{ offset: 25, repeat: 100, symbol: L.Symbol.arrowHead({ pixelSize: 12, pathOptions: { fillOpacity: 1, weight: 0, color: '#2563eb' }}) }]}).addTo(AppState.map);
                    if (polyline.getBounds().isValid()) AppState.map.fitBounds(polyline.getBounds().pad(0.2));
                    
                    Utils.log('‚úÖ Mapa principal creado exitosamente');
                    
                    // Event listener para cerrar el mapa
                    const closeMapBtn = document.getElementById('close-map');
                    if (closeMapBtn) {
                        closeMapBtn.addEventListener('click', () => {
                            switchToView('summary');
                        });
                    }
                } catch (error) {
                    Utils.error('Error al crear mapa principal:', error);
                }
                }, 100);
            } catch (error) {
                Utils.error('Error al renderizar map:', error);
                container.innerHTML = `<div class="bg-red-100 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 text-red-700 dark:text-red-400">
                    <h3 class="font-semibold">Error al cargar el mapa</h3>
                    <p class="text-sm">${error.message}</p>
                </div>`;
            }
        },
        renderItinerary() {
            Utils.log('Renderizando secci√≥n de itinerario');
            const container = document.getElementById('itinerary');
            if (!container) {
                Utils.error('Contenedor de itinerario no encontrado');
                return;
            }
            
            // Buscar el contenedor espec√≠fico dentro de la secci√≥n
            const itineraryContent = document.getElementById('itinerary-content') || container;
            
            // Generar fases din√°micamente basadas en los datos reales del itinerario
            const phases = this.generateItineraryPhases();
            const timelineHTML = phases.map(p => `
                <div class="mb-16">
                    <div class="flex items-center gap-4 mb-8">
                        <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-violet-600 rounded-2xl flex items-center justify-center">
                            <span class="material-symbols-outlined text-white text-xl">location_on</span>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">${p.title}</h3>
                    </div>
                    ${tripConfig.itineraryData.filter(day => day.phase === p.phase).map((day, index) => {
                        // Funci√≥n para obtener el icono espec√≠fico seg√∫n la actividad
                        const getActivityIcon = (day) => {
                            const title = day.title.toLowerCase();
                            const description = day.description.toLowerCase();
                            
                            if (title.includes('vuelo') || title.includes('llegada') || title.includes('salida')) return 'flight';
                            if (title.includes('trekking') || title.includes('caminata') || description.includes('trekking')) return 'hiking';
                            if (title.includes('rafting') || description.includes('rafting')) return 'kayaking';
                            if (title.includes('safari') || description.includes('safari') || title.includes('chitwan')) return 'pets';
                            if (title.includes('cocina') || description.includes('cocina') || description.includes('momos')) return 'restaurant';
                            if (title.includes('templo') || title.includes('monasterio') || title.includes('dzong') || title.includes('estupa')) return 'temple_buddhist';
                            if (title.includes('plaza') || title.includes('durbar') || description.includes('palacio')) return 'account_balance';
                            if (title.includes('aguas termales') || description.includes('aguas termales')) return 'hot_tub';
                            if (title.includes('patan') || title.includes('katmand√∫') || description.includes('ciudad')) return 'location_city';
                            if (title.includes('nido del tigre') || title.includes('taktsang')) return 'temple_buddhist';
                            return 'place';
                        };
                        
                        return `
                        <div class="timeline-item grid grid-cols-[auto,1fr] gap-x-6" id="${day.id}" data-coords="${day.coords ? day.coords.join(',') : ''}">
                            <div class="flex flex-col items-center">
                                <div class="w-14 h-14 bg-gradient-to-br from-purple-500 to-violet-600 rounded-full flex items-center justify-center shadow-lg ring-4 ring-purple-100 dark:ring-purple-900/20 z-10">
                                    <span class="material-symbols-outlined text-white text-xl">${getActivityIcon(day)}</span>
                                </div>
                                ${index < tripConfig.itineraryData.filter(d => d.phase === p.phase).length - 1 ? '<div class="w-0.5 h-full bg-gradient-to-b from-purple-300 to-violet-300 dark:from-purple-600 dark:to-violet-600"></div>' : ''}
                            </div>
                            <div class="pb-12 opacity-0 -translate-y-4" style="animation-delay: ${index * 100}ms;">
                                <div data-day-id="${day.id}" class="itinerary-card bg-white dark:bg-slate-800 rounded-3xl shadow-lg border border-slate-200 dark:border-slate-700 cursor-pointer transition-all duration-200 hover:shadow-xl overflow-hidden" onclick="UIRenderer.showItineraryModal(${JSON.stringify(day).replace(/"/g, '&quot;')})">
                                    ${day.image ? `
                                        <div class="relative h-48 md:h-56">
                                            <img loading="lazy" src="${day.image}" alt="${day.title}" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/1920x1080/4f46e5/ffffff?text=Imagen';">
                                            <div class="absolute top-4 left-4 bg-black/60 backdrop-blur-sm rounded-full px-3 py-1">
                                                <p class="text-white text-sm font-semibold">${(() => {
                                                    const dayNumber = parseInt(day.id.replace('day-', ''));
                                                    return `D√≠a ${dayNumber}`;
                                                })()}</p>
                                            </div>
                                        </div>
                                        <div class="p-6">
                                            <h4 class="font-bold text-xl text-slate-900 dark:text-white mb-2">${day.title}</h4>
                                            <p class="text-slate-600 dark:text-slate-400 text-sm leading-relaxed mb-4">${day.description}</p>
                                            <div class="flex items-center gap-2 text-blue-600 dark:text-blue-400">
                                                <span class="material-symbols-outlined text-sm">touch_app</span>
                                                <span class="text-xs font-medium">Toca para ver detalles</span>
                                            </div>
                                        </div>
                                    ` : `
                                        <div class="p-6">
                                            <div class="flex items-center gap-3 mb-4">
                                                <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center">
                                                    <span class="material-symbols-outlined text-white text-sm">calendar_today</span>
                                                </div>
                                                <p class="text-sm font-semibold text-blue-600 dark:text-blue-400">${(() => {
                                                    const dayNumber = parseInt(day.id.replace('day-', ''));
                                                    const tripDate = Utils.getTripDate(dayNumber - 1);
                                                    return `D√≠a ${dayNumber} ‚Ä¢ ${Utils.formatShortDate(tripDate)}`;
                                                })()}</p>
                                            </div>
                                            <h4 class="font-bold text-xl text-slate-900 dark:text-white mb-3">${day.title}</h4>
                                            <p class="text-slate-600 dark:text-slate-400 text-sm leading-relaxed mb-4">${day.description}</p>
                                            <div class="flex items-center gap-2 text-blue-600 dark:text-blue-400">
                                                <span class="material-symbols-outlined text-sm">touch_app</span>
                                                <span class="text-xs font-medium">Toca para ver detalles</span>
                                            </div>
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>`;
                    }).join('')}
                </div>`).join('');
            itineraryContent.innerHTML = `<div class="relative">${timelineHTML}</div>`;
            
            const observer = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.querySelector(':scope > div:last-child').classList.add('animate-enter');
                        const coords = entry.target.dataset.coords;
                        if (coords && AppState.map) {
                            const [lat, lng] = coords.split(',');
                            AppState.map.flyTo([lat, lng], 12, { duration: 1.5, easeLinearity: 0.5 });
                        }
                    }
                });
            }, { threshold: 0.6 });
            document.querySelectorAll('.timeline-item').forEach(item => observer.observe(item));
            
            document.querySelectorAll('.itinerary-card').forEach(card => card.addEventListener('click', (e) => {
                this.showItineraryModal(e.currentTarget.dataset.dayId);
            }));
            
            Utils.log('Secci√≥n de itinerario renderizada correctamente');
        },

        /**
         * Renderiza el calendario interactivo del viaje
         * Muestra todos los d√≠as con colores por fase y navegaci√≥n al itinerario
         */
        renderCalendar(targetContainer = null) {
            Utils.log('üìÖ Renderizando calendario del viaje');
            // Buscar el contenedor del calendario
            let container = targetContainer || document.getElementById('calendar');
            
            // Si no hay contenedor espec√≠fico, crear la secci√≥n del calendario
            if (!container) {
                const itinerarySection = document.getElementById('itinerary');
                if (itinerarySection) {
                    const calendarSection = document.createElement('section');
                    calendarSection.id = 'calendar';
                    calendarSection.className = 'mb-16';
                    calendarSection.setAttribute('data-nav', 'Calendario');
                    calendarSection.setAttribute('data-icon', 'M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z');
                    
                    // Insertar antes del itinerario
                    itinerarySection.parentNode.insertBefore(calendarSection, itinerarySection);
                    container = calendarSection;
                    
                    // Forzar la actualizaci√≥n de la navegaci√≥n despu√©s de crear la secci√≥n
                    setTimeout(() => {
                        if (window.NavigationManager && window.NavigationManager.render) {
                            window.NavigationManager.render();
                        }
                    }, 100);
                } else {
                    Utils.error('No se pudo encontrar la secci√≥n de itinerario para crear el calendario');
                    return;
                }
            }
            
            const calendarHTML = `
                <div>
                    <h3 class="text-lg font-semibold text-slate-700 dark:text-slate-300 mb-4">Octubre 2025</h3>
                    <div class="grid grid-cols-7 gap-2 mb-8">
                        ${(() => {
                            // Usar variables regionales del dispositivo
                            const locale = navigator.language || 'es-ES';
                            const weekdays = [];
                            for (let i = 0; i < 7; i++) {
                                const date = new Date(2024, 0, i + 1); // Enero 2024
                                weekdays.push(date.toLocaleDateString(locale, { weekday: 'short' }));
                            }
                            return weekdays.map(day => 
                                `<div class="text-center text-sm font-semibold text-slate-500 dark:text-slate-400 py-2">${day}</div>`
                            ).join('');
                        })()}
                        
                        ${(() => {
                            // Generar d√≠as del calendario para octubre de 2025
                            const startDate = new Date(2025, 9, 9); // 9 de octubre de 2025
                            const daysInMonth = new Date(2025, 10, 0).getDate(); // D√≠as en octubre
                            
                            // Calcular cu√°ntos d√≠as vac√≠os hay desde el 1 de octubre hasta el 9 de octubre
                            // El 1 de octubre de 2025 es mi√©rcoles (3), el 9 es jueves (4)
                            const firstDayOfMonth = new Date(2025, 9, 1).getDay(); // D√≠a de la semana del 1 de octubre
                            const daysToSkip = firstDayOfMonth; // D√≠as vac√≠os antes del 1 de octubre
                            
                            let calendarDays = '';
                            
                            // D√≠as vac√≠os antes del 1 de octubre
                            for (let i = 0; i < daysToSkip; i++) {
                                calendarDays += '<div class="h-16"></div>';
                            }
                            
                            // D√≠as del mes
                            for (let day = 1; day <= daysInMonth; day++) {
                                const currentDate = new Date(2025, 9, day); // Octubre es mes 9 (0-indexed)
                                const tripDay = Math.floor((currentDate - startDate) / (1000 * 60 * 60 * 24));
                                
                                if (tripDay >= 0 && tripDay <= 17) { // 18 d√≠as del viaje (0-17 = 18 d√≠as)
                                    // Es un d√≠a del viaje
                                    const actualDayId = tripDay + 1; // Convertir de 0-17 a 1-18
                                    const dayData = tripConfig.itineraryData.find(d => d.id === `day-${actualDayId}`);
                                    const phases = tripConfig.calendarData.phases;
                                    const specialDays = tripConfig.calendarData.specialDays;
                                    const phase = phases.find(p => p.days.includes(actualDayId));
                                    const specialDay = specialDays.find(s => s.day === actualDayId);
                                    
                                    let dayClass = 'h-16 border border-slate-200 dark:border-slate-700 rounded-lg p-2 cursor-pointer hover:shadow-md transition-all';
                                    let dayContent = '';
                                    
                                    if (specialDay) {
                                        // D√≠a especial con gradiente
                                        dayClass += ` bg-gradient-to-br ${specialDay.color} text-white`;
                                        dayContent = `
                                            <div class="text-center h-full flex flex-col items-center justify-center">
                                                <div class="text-lg">${specialDay.icon}</div>
                                                <div class="text-xs font-semibold">${specialDay.label}</div>
                                            </div>
                                        `;
                                    } else if (phase) {
                                        // D√≠a normal con color de fase
                                        dayClass += ` bg-gradient-to-br ${phase.color} text-white`;
                                        dayContent = `
                                            <div class="text-center h-full flex flex-col items-center justify-center">
                                                <div class="text-lg">${dayData?.icon || 'üìÖ'}</div>
                                                <div class="text-xs font-semibold">D√≠a ${actualDayId}</div>
                                            </div>
                                        `;
                                    }
                                    
                                    calendarDays += `<div class="${dayClass}" data-day="${tripDay}" onclick="document.getElementById('day-${actualDayId}')?.scrollIntoView({behavior: 'smooth', block: 'center'})">${dayContent}</div>`;
                                } else {
                                    // D√≠a normal del mes
                                    calendarDays += `<div class="h-16 border border-slate-200 dark:border-slate-700 rounded-lg p-2 text-center text-slate-400 dark:text-slate-600 flex items-center justify-center">${day}</div>`;
                                }
                            }
                            
                            return calendarDays;
                        })()}
                    </div>
                    
                    <!-- Leyenda del calendario -->
                    <div class="flex flex-wrap gap-4 text-sm">
                        ${tripConfig.calendarData.phases.map(phase => `
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-gradient-to-r ${phase.color} rounded"></div>
                                <span class="text-slate-700 dark:text-slate-300">${phase.name}</span>
                            </div>
                        `).join('')}
                        ${(() => {
                            // Generar leyenda de vuelos din√°micamente bas√°ndose en los tipos √∫nicos
                            const uniqueFlightTypes = [...new Set(tripConfig.calendarData.specialDays.map(day => day.flightType))];
                            return uniqueFlightTypes.map(flightType => {
                                const color = flightType === 'Internacional' ? 'from-red-500 to-pink-600' :
                                             flightType === 'Regional' ? 'from-purple-500 to-indigo-600' :
                                             'from-blue-500 to-cyan-600';
                                const label = flightType === 'Internacional' ? 'Vuelos Internacionales' :
                                            flightType === 'Regional' ? 'Vuelos Regionales' :
                                            'Vuelos Locales';
                                return `
                                    <div class="flex items-center gap-2">
                                        <div class="w-4 h-4 bg-gradient-to-r ${color} rounded"></div>
                                        <span class="text-slate-700 dark:text-slate-300">${label}</span>
                                    </div>
                                `;
                            }).join('');
                        })()}
                    </div>
                </div>
            `;
            
            container.innerHTML = calendarHTML;
            Utils.log('Calendario renderizado correctamente');
        },
        showItineraryModal(dayId) {
            const day = tripConfig.itineraryData.find(d => d.id === dayId);
            if (!day) return;
            
            const modal = document.getElementById('itinerary-modal');
            const modalContent = document.getElementById('itinerary-modal-content');
            const detailItem = (icon, title, content) => content ? `<div class="flex items-start gap-4"><span class="text-2xl pt-1">${icon}</span><div><h5 class="font-semibold text-slate-800 dark:text-slate-200">${title}</h5><p class="text-sm text-slate-600 dark:text-slate-400">${content}</p></div></div>` : '';
            
            // Limpiar event listeners anteriores
            const oldCloseBtn = document.getElementById('close-modal-btn');
            if (oldCloseBtn) {
                oldCloseBtn.replaceWith(oldCloseBtn.cloneNode(true));
            }
            
            modalContent.innerHTML = `
                <!-- Bot√≥n de cierre principal -->
                <button id="close-modal-btn" class="absolute top-4 right-4 z-20 p-3 sm:p-2 rounded-full bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-600 dark:text-slate-400 transition-colors shadow-lg">
                    <svg class="w-6 h-6 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
                
                <img src="${day.image || 'https://placehold.co/800x400/4f46e5/ffffff?text=Himalaya'}" alt="${day.title}" class="w-full h-60 object-cover rounded-t-2xl">
                <div class="p-6">
                    <p class="text-sm font-semibold text-blue-600 dark:text-blue-400">${(() => {
                        const dayNumber = parseInt(day.id.replace('day-', ''));
                        const tripDate = Utils.getTripDate(dayNumber - 1); // Restar 1 porque getTripDate espera 0-17
                        return `D√≠a ${dayNumber} &bull; ${Utils.formatShortDate(tripDate)}`;
                    })()}</p>
                    <h3 class="text-3xl font-bold text-slate-900 dark:text-white mt-1">${day.title}</h3>
                    <div class="mt-6 space-y-4 border-t border-slate-200 dark:border-slate-700 pt-6">
                        ${detailItem('üó∫Ô∏è', 'Itinerario', day.planA)}
                        ${detailItem('‚òï', 'Tiempo Libre', day.planB)}
                        ${detailItem('üí°', 'Consejo del D√≠a', day.consejo)}
                        ${detailItem('üòã', 'Bocado del D√≠a', day.bocado)}
                    </div>
                    ${day.coords ? `
                        <div class="mt-8 border-t border-slate-200 dark:border-slate-700 pt-6">

                            <div id="modal-map-${dayId}" class="h-64 rounded-xl overflow-hidden border border-slate-200 dark:border-slate-700 flex items-center justify-center">
                                <div class="text-center">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
                                    <p class="text-sm text-slate-500">Cargando mapa...</p>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Bot√≥n de cierre adicional para m√≥viles -->
                    <div class="mt-8 pt-6 border-t border-slate-200 dark:border-slate-700">
                        <button id="mobile-close-btn" class="w-full p-3 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 rounded-xl font-semibold transition-colors sm:hidden">
                            Cerrar
                        </button>
                    </div>
                </div>`;
            
            // Mostrar modal
            modal.classList.remove('hidden');
            
            // Event listeners
            modal.addEventListener('click', (e) => {
                if (e.target === modal) this.hideItineraryModal();
            });
            
            // Bot√≥n de cierre principal
            const closeBtn = document.getElementById('close-modal-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    this.hideItineraryModal();
                });
            }
            
            // Bot√≥n de cierre m√≥vil
            const mobileCloseBtn = document.getElementById('mobile-close-btn');
            if (mobileCloseBtn) {
                mobileCloseBtn.addEventListener('click', () => {
                    this.hideItineraryModal();
                });
            }
            
            // Crear mapa del modal si hay coordenadas
            if (day.coords) {
                setTimeout(() => {
                    this.createModalMap(dayId, day.coords, day.title);
                }, 500);
            }
        },
        hideItineraryModal() {
            document.getElementById('itinerary-modal').classList.add('hidden');
        },
        createModalMap(dayId, coords, title) {
            Utils.log(`üó∫Ô∏è Creando mapa del modal para: ${dayId}`);
            
            const mapContainer = document.getElementById(`modal-map-${dayId}`);
            if (!mapContainer) {
                Utils.error(`Contenedor del mapa no encontrado: modal-map-${dayId}`);
                return;
            }
            
            try {
                // Limpiar el contenedor
                mapContainer.innerHTML = '';
                
                // Crear el mapa
                const map = L.map(`modal-map-${dayId}`, { 
                    closePopupOnClick: false,
                    zoomControl: false,
                    attributionControl: false
                }).setView(coords, 12);
                
                // A√±adir capa de tiles
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { 
                    attribution: '&copy; OpenStreetMap &copy; CARTO' 
                }).addTo(map);
                
                // Marcador principal del d√≠a
                L.marker(coords, { 
                    icon: L.divIcon({ 
                        className: 'custom-div-icon', 
                        html: `<div class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm shadow-lg border-2 border-white">üìç</div>`, 
                        iconSize: [32, 32], 
                        iconAnchor: [16, 32] 
                    }) 
                }).addTo(map).bindPopup(`<b>${title}</b>`, { closeButton: false });
                
                // A√±adir marcadores de lugares cercanos o relacionados
                const nearbyPlaces = this.getNearbyPlaces(coords, dayId);
                nearbyPlaces.forEach(place => {
                    L.marker(place.coords, { 
                        icon: L.divIcon({ 
                            className: 'custom-div-icon', 
                            html: `<div class="w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center text-xs shadow-md border border-white">${place.icon}</div>`, 
                            iconSize: [24, 24], 
                            iconAnchor: [12, 24] 
                        }) 
                    }).addTo(map).bindPopup(`<b>${place.name}</b><br><small>${place.description}</small>`, { closeButton: false });
                });
                
                // Ajustar vista para mostrar todos los marcadores
                if (nearbyPlaces.length > 0) {
                    const allCoords = [coords, ...nearbyPlaces.map(p => p.coords)];
                    const bounds = L.latLngBounds(allCoords);
                    map.fitBounds(bounds, { padding: [20, 20] });
                }
                
                // Forzar redibujado del mapa
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
                
                Utils.log(`‚úÖ Mapa del modal ${dayId} creado exitosamente`);
            } catch (error) {
                Utils.error(`Error al crear mapa del modal ${dayId}:`, error);
                mapContainer.innerHTML = '<div class="h-full flex items-center justify-center text-slate-500">Error al cargar el mapa</div>';
            }
        },
        /**
         * Obtiene los lugares cercanos y relacionados para un d√≠a espec√≠fico del viaje
         * @param {Array} coords - Coordenadas del lugar principal del d√≠a
         * @param {string} dayId - ID del d√≠a (ej: 'day-0', 'day-1')
         * @returns {Array} Lista de lugares cercanos con coordenadas, iconos y descripciones
         */
        getNearbyPlaces(coords, dayId) {
            // Los lugares ahora est√°n centralizados en tripConfig.placesByDay
            return tripConfig.placesByDay[dayId] || [];
        },
        
        /**
         * Genera las opciones para vincular gastos con el presupuesto
         * @param {string} selectedCategory - Categor√≠a seleccionada para filtrar opciones
         * @returns {string} HTML con las opciones del select
         */
        generateBudgetLinkOptions(selectedCategory = '') {
            const options = [];
            
            // Si no hay categor√≠a seleccionada, mostrar todas las opciones
            if (!selectedCategory) {
                Object.entries(tripConfig.budgetData).forEach(([phase, items]) => {
                    items.forEach(item => {
                        if (item.subItems) {
                            // Si tiene subitems, crear opciones para cada uno
                            item.subItems.forEach(subItem => {
                                options.push(`<option value="${phase}:${item.category}:${subItem.concept}">${subItem.concept} (${Utils.formatCurrency(subItem.cost)})</option>`);
                            });
                        } else {
                            // Si no tiene subitems, crear opci√≥n para el item principal
                            options.push(`<option value="${phase}:${item.category}:${item.concept}">${item.concept} (${Utils.formatCurrency(item.cost)})</option>`);
                        }
                    });
                });
            } else {
                // Filtrar solo por la categor√≠a seleccionada
                Object.entries(tripConfig.budgetData).forEach(([phase, items]) => {
                    items.forEach(item => {
                        if (item.category === selectedCategory) {
                            if (item.subItems) {
                                // Si tiene subitems, crear opciones para cada uno
                                item.subItems.forEach(subItem => {
                                    options.push(`<option value="${phase}:${item.category}:${subItem.concept}">${subItem.concept} (${Utils.formatCurrency(subItem.cost)})</option>`);
                                });
                            } else {
                                // Si no tiene subitems, crear opci√≥n para el item principal
                                options.push(`<option value="${phase}:${item.category}:${item.concept}">${item.concept} (${Utils.formatCurrency(item.cost)})</option>`);
                            }
                        }
                    });
                });
            }
            
            return options.join('');
        },
        
        renderBudget() {
            Utils.log('üí∞ Renderizando secci√≥n de presupuesto');
            const container = document.getElementById('budget');
            const allExpenses = Object.values(tripConfig.budgetData).flat();
            const allCategories = [...new Set(allExpenses.map(item => item.category))];
            const categoryOptionsHTML = allCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            
            const categoryFiltersHTML = allCategories.map(cat => {
                const icon = this.getCategoryIcon(cat);
                const color = this.getCategoryColor(cat);
                return `
                    <button data-category="${cat}" class="budget-filter-btn flex flex-col items-center justify-center gap-2 p-3 text-center bg-white dark:bg-slate-800 rounded-2xl shadow-lg ring-1 ring-slate-900/5 dark:ring-white/10 transition-all transform hover:scale-105">
                        <div class="w-8 h-8 ${color} rounded-lg flex items-center justify-center">
                            <span class="material-symbols-outlined text-white text-sm">${icon}</span>
                        </div>
                        <span class="text-xs font-semibold">${cat}</span>
                    </button>`;
            }).join('');

            // Buscar el contenedor espec√≠fico dentro de la secci√≥n
            const budgetContent = document.getElementById('budget-content') || container;
            
            budgetContent.innerHTML = `
                <!-- Resumen General -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 text-center">
                        <div class="flex items-center justify-center gap-2 mb-2">
                            <span class="material-symbols-outlined text-xl text-blue-600 dark:text-blue-400">account_balance_wallet</span>
                            <h4 class="font-semibold text-sm text-slate-700 dark:text-slate-300">Presupuesto Total</h4>
                        </div>
                        <p class="text-2xl font-bold text-slate-900 dark:text-white">${Utils.formatCurrency(Utils.calculateSubtotal(allExpenses), true)}</p>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 text-center">
                        <div class="flex items-center justify-center gap-2 mb-2">
                            <span class="material-symbols-outlined text-xl text-green-600 dark:text-green-400">receipt_long</span>
                            <h4 class="font-semibold text-sm text-slate-700 dark:text-slate-300">Gastos Registrados</h4>
                        </div>
                        <p class="text-2xl font-bold text-slate-900 dark:text-white">${AppState.expenses.length}</p>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 text-center">
                        <div class="flex items-center justify-center gap-2 mb-2">
                            <span class="material-symbols-outlined text-xl text-orange-600 dark:text-orange-400">payments</span>
                            <h4 class="font-semibold text-sm text-slate-700 dark:text-slate-300">Total Gastado</h4>
                        </div>
                        <p class="text-2xl font-bold text-slate-900 dark:text-white">${Utils.formatCurrency(AppState.expenses.reduce((sum, exp) => sum + (exp.amount || 0), 0), true)}</p>
                    </div>
                </div>
                
                <!-- Filtros de Categor√≠a -->
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 mb-6">
                    <div class="flex items-center gap-3 mb-6">
                        <span class="material-symbols-outlined text-xl text-slate-600 dark:text-slate-400">filter_list</span>
                        <h4 class="font-semibold text-lg text-slate-900 dark:text-white">Filtrar por Categor√≠a</h4>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4" id="budget-category-filters">
                        ${allCategories.map(cat => {
                            const icon = this.getCategoryIcon(cat);
                            const color = this.getCategoryColor(cat);
                            return `<button data-category="${cat}" class="budget-filter-btn group flex flex-col items-center justify-center gap-3 p-4 text-center bg-white dark:bg-slate-700 rounded-xl border-2 border-slate-200 dark:border-slate-600 hover:border-blue-300 dark:hover:border-blue-500 transition-all duration-200 hover:shadow-md">
                                <div class="w-10 h-10 ${color} rounded-lg flex items-center justify-center">
                                    <span class="material-symbols-outlined text-white text-lg">${icon}</span>
                                </div>
                                <span class="text-xs font-medium text-slate-700 dark:text-slate-300 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">${cat}</span>
                            </button>`;
                        }).join('')}
                    </div>
                </div>
                
                <!-- Contenido Din√°mico -->
                <div id="budget-content" class="space-y-6">
                    <!-- Aqu√≠ se mostrar√° el contenido seg√∫n la categor√≠a seleccionada -->
                    <div class="text-center text-slate-500 dark:text-slate-400 py-8">
                        <p class="text-lg">Selecciona una categor√≠a para ver detalles</p>
                    </div>
                </div>
                
                <!-- Formulario de Gasto -->
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 mt-8">
                    <div class="flex items-center gap-3 mb-6">
                        <span class="material-symbols-outlined text-2xl text-blue-600 dark:text-blue-400">add_circle</span>
                        <h4 class="font-bold text-xl text-slate-900 dark:text-white">A√±adir Nuevo Gasto</h4>
                    </div>
                    <form id="expense-form" class="space-y-6">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="relative">
                                <label for="expense-concept" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Concepto</label>
                                <div class="relative">
                                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-lg">description</span>
                                    <input type="text" id="expense-concept" required 
                                           class="w-full pl-10 pr-4 py-3 rounded-xl bg-slate-50 dark:bg-slate-700 border-2 border-transparent focus:border-blue-500 focus:bg-white dark:focus:bg-slate-600 transition-all duration-200 text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-slate-500"
                                           placeholder="Ej: Comida en restaurante">
                                </div>
                            </div>
                            
                            <div class="relative">
                                <label for="expense-amount" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Cantidad (‚Ç¨)</label>
                                <div class="relative">
                                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-lg">euro</span>
                                    <input type="number" id="expense-amount" step="0.01" required 
                                           class="w-full pl-10 pr-4 py-3 rounded-xl bg-slate-50 dark:bg-slate-700 border-2 border-transparent focus:border-blue-500 focus:bg-white dark:focus:bg-slate-600 transition-all duration-200 text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-slate-500"
                                           placeholder="0.00">
                                </div>
                            </div>
                            
                            <div class="relative">
                                <label for="expense-category" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Categor√≠a</label>
                                <div class="relative">
                                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-lg">category</span>
                                    <select id="expense-category" required 
                                            class="w-full pl-10 pr-4 py-3 rounded-xl bg-slate-50 dark:bg-slate-700 border-2 border-transparent focus:border-blue-500 focus:bg-white dark:focus:bg-slate-600 transition-all duration-200 text-slate-900 dark:text-white appearance-none cursor-pointer">
                                        <option value="">Seleccionar categor√≠a</option>
                                        ${categoryOptionsHTML}
                                    </select>
                                    <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-lg pointer-events-none">expand_more</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end">
                            <button type="submit" 
                                    class="inline-flex items-center gap-2 px-8 py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-200">
                                <span class="material-symbols-outlined">add</span>
                                A√±adir Gasto
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Lista de Gastos -->
                <div id="expense-list" class="mt-6 space-y-2"></div>`;

            document.getElementById('budget-category-filters').addEventListener('click', (e) => {
                const btn = e.target.closest('.budget-filter-btn');
                if (!btn) return;
                
                const category = btn.dataset.category;
                
                // Toggle selecci√≥n visual
                btn.classList.toggle('ring-2');
                btn.classList.toggle('ring-blue-500');
                btn.classList.toggle('dark:ring-blue-400');
                btn.classList.toggle('bg-blue-100');
                btn.classList.toggle('dark:bg-blue-800');

                // Mostrar contenido de las categor√≠as seleccionadas sin perder el foco
                setTimeout(() => this.showCategoryContent(), 100);
            });

            // Event listener para actualizar opciones de presupuesto cuando cambie la categor√≠a
            document.getElementById('expense-category').addEventListener('change', (e) => {
                const selectedCategory = e.target.value;
                const budgetLinkSelect = document.getElementById('expense-budget-link');
                const currentValue = budgetLinkSelect.value;
                
                // Actualizar opciones
                budgetLinkSelect.innerHTML = `<option value="">Sin vincular</option>${this.generateBudgetLinkOptions(selectedCategory)}`;
                
                // Mantener el valor seleccionado si sigue siendo v√°lido
                if (currentValue && budgetLinkSelect.querySelector(`option[value="${currentValue}"]`)) {
                    budgetLinkSelect.value = currentValue;
                }
            });

            document.getElementById('expense-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const concept = document.getElementById('expense-concept').value;
                const amount = parseFloat(document.getElementById('expense-amount').value);
                const category = document.getElementById('expense-category').value;
                
                if (concept && amount > 0 && category) {
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const editId = submitBtn.dataset.editId;
                    
                    if (editId) {
                        // Actualizar gasto existente
                        ExpenseManager.update(editId, { concept, amount, category });
                        // Cancelar modo edici√≥n despu√©s de actualizar
                        this.cancelEditMode();
                        Utils.log(`‚úÖ Gasto actualizado exitosamente`);
                    } else {
                        // A√±adir nuevo gasto
                        ExpenseManager.add({ concept, amount, category });
                    }
                    e.target.reset();
                    this.renderExpenseList();
                    this.showCategoryContent(); // Actualizar vista de categor√≠as
                }
            });



            // Event listener para eliminar gastos (prioridad alta)
            document.getElementById('expense-list').addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-expense-btn');
                if (deleteBtn) {
                    e.preventDefault();
                    e.stopPropagation();
                    const id = deleteBtn.dataset.id;
                    Utils.log(`üóëÔ∏è Bot√≥n eliminar clickeado para gasto: ${id}`);
                    ExpenseManager.remove(id);
                    // Actualizar la lista de gastos para mostrar cambios visuales
                    ExpenseManager.renderList();
                    return;
                }
                
                // Event listener para editar gastos
                const expenseItem = e.target.closest('.expense-item');
                if (expenseItem) {
                    const id = expenseItem.dataset.expenseId;
                    ExpenseManager.editExpense(id);
                }
            });

            this.renderExpenseList();
        },
        
        getTripStartDate() {
            // Buscar el primer vuelo en el itinerario para determinar la fecha de inicio
            const firstFlight = tripConfig.itineraryData.find(day => 
                day.title.toLowerCase().includes('vuelo') || 
                day.title.toLowerCase().includes('salida') ||
                day.title.toLowerCase().includes('embarque')
            );
            
            if (firstFlight) {
                // Si encontramos un vuelo, usar esa fecha
                const dayNumber = parseInt(firstFlight.id.replace('day-', ''));
                return Utils.getTripDate(dayNumber - 1);
            }
            
            // Fallback: usar fecha actual + 1 d√≠a
            const today = new Date();
            today.setDate(today.getDate() + 1);
            return today;
        },
        
        updateTripDates() {
            const tripDatesElement = document.getElementById('trip-dates');
            if (!tripDatesElement) return;
            
            try {
                const startDate = this.getTripStartDate();
                const totalDays = tripConfig.itineraryData.length;
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + totalDays - 1);
                
                const startFormatted = startDate.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
                const endFormatted = endDate.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
                
                tripDatesElement.textContent = `${startFormatted} - ${endFormatted}`;
            } catch (error) {
                tripDatesElement.textContent = 'Fechas no disponibles';
            }
        },
        
        showItineraryModal(day) {
            const detailCard = (icon, title, content) => content ? `<div class="bg-slate-100 dark:bg-slate-800 p-4 rounded-xl"><h4 class="font-semibold text-md flex items-center gap-2"><span class="material-symbols-outlined text-blue-600 dark:text-blue-400">${icon}</span> ${title}</h4><p class="text-sm text-slate-600 dark:text-slate-400 mt-2 pl-10">${content}</p></div>` : '';

            const modalHTML = `
                <div id="itinerary-modal-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div class="bg-white dark:bg-slate-900 rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto animate-modal-in relative">
                        <button id="close-modal-btn" class="absolute top-4 right-4 z-20 p-2 rounded-full bg-white/50 dark:bg-slate-800/50 hover:bg-white/80 dark:hover:bg-slate-700 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                        <img src="${day.image}" alt="${day.title}" class="w-full h-60 object-cover rounded-t-2xl" onerror="this.onerror=null;this.src='https://placehold.co/800x400/4f46e5/ffffff?text=Himalaya';">
                        <div class="p-6 space-y-4">
                            <p class="text-sm font-semibold text-blue-600 dark:text-blue-400">D√çA ${day.id.replace('day-','')}</p>
                            <h3 class="text-3xl font-bold text-slate-900 dark:text-white flex items-center gap-2"><span class="material-symbols-outlined text-4xl text-orange-500">${day.icon}</span> ${day.title}</h3>
                            <div id="modal-map" class="h-64 rounded-xl overflow-hidden border dark:border-slate-700"></div>
                            ${detailCard('map', 'Itinerario', day.planA)}
                            ${detailCard('coffee', 'Tiempo Libre', day.planB)}
                            ${detailCard('lightbulb', 'Consejo del D√≠a', day.consejo)}
                            ${detailCard('restaurant', 'Bocado del D√≠a', day.bocado)}
                        </div>
                    </div>
                </div>
            `;
            
            // Crear contenedor del modal si no existe
            let modalContainer = document.getElementById('itinerary-modal-container');
            if (!modalContainer) {
                modalContainer = document.createElement('div');
                modalContainer.id = 'itinerary-modal-container';
                document.body.appendChild(modalContainer);
            }
            
            modalContainer.innerHTML = modalHTML;
            
            setTimeout(() => this.initModalMap(day), 100);

            document.getElementById('itinerary-modal-overlay').addEventListener('click', (e) => {
                if (e.target.id === 'itinerary-modal-overlay') modalContainer.innerHTML = '';
            });
            document.getElementById('close-modal-btn').addEventListener('click', () => {
                modalContainer.innerHTML = '';
            });
        },
        
        initModalMap(day) {
            try {
                const mapContainer = document.getElementById('modal-map');
                if (!mapContainer) throw new Error("Map container #modal-map not found.");

                const places = this.getNearbyPlaces(day.coords, day.id);
                const center = day.coords || (places.length > 0 ? places[0].coords : [28.3949, 84.1240]);
                
                const map = L.map('modal-map').setView(center, 12);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
                
                const markers = [];
                places.forEach(place => {
                    const marker = L.marker(place.coords, { icon: L.divIcon({ className: 'custom-div-icon', html: `<div class="w-8 h-8 bg-white dark:bg-slate-800 rounded-full flex items-center justify-center text-lg shadow-md"><span class="material-symbols-outlined">${place.icon}</span></div>` }) })
                        .addTo(map)
                        .bindPopup(`<b>${place.name}</b><br>${place.description}`);
                    markers.push(marker);
                });

                if (markers.length > 1) {
                    const group = new L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.3));
                }
            } catch(e) {
                console.error("Error al crear el mapa del modal:", e);
                const mapContainer = document.getElementById('modal-map');
                if (mapContainer) {
                     mapContainer.innerHTML = `<div class="p-4 text-center text-red-500">Error al cargar el mapa.</div>`;
                }
            }
        },
        
        cancelEditMode() {
            const submitBtn = document.querySelector('#expense-form button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = '<span class="material-symbols-outlined">add</span>A√±adir Gasto';
                delete submitBtn.dataset.editId;
            }
            
            // Limpiar formulario
            document.getElementById('expense-form').reset();
        },
        
        editExpense(id) {
            const expense = AppState.expenses.find(exp => exp.id === id);
            if (!expense) return;
            
            // Llenar formulario con datos del gasto
            document.getElementById('expense-concept').value = expense.concept;
            document.getElementById('expense-amount').value = expense.amount;
            document.getElementById('expense-category').value = expense.category;
            
            // Cambiar bot√≥n a modo edici√≥n
            const submitBtn = document.querySelector('#expense-form button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = '<span class="material-symbols-outlined">edit</span>Actualizar Gasto';
                submitBtn.dataset.editId = id;
            }
            
            // Scroll al formulario
            document.getElementById('expense-form').scrollIntoView({ behavior: 'smooth', block: 'center' });
        },
        
        showCategoryContent() {
            const contentContainer = document.getElementById('budget-content');
            if (!contentContainer) return;
            
            try {
                // Obtener todas las categor√≠as seleccionadas
                const selectedCategories = Array.from(document.querySelectorAll('.budget-filter-btn.ring-2')).map(btn => btn.dataset.category);
                
                if (selectedCategories.length === 0) {
                    contentContainer.innerHTML = `
                        <div class="text-center text-slate-500 dark:text-slate-400 py-8">
                            <p class="text-lg">Selecciona una categor√≠a para ver detalles</p>
                        </div>
                    `;
                    return;
                }
                
                // Obtener datos de todas las categor√≠as seleccionadas
                const allCategoryItems = Object.values(tripConfig.budgetData).flat().filter(item => selectedCategories.includes(item.category));
                const allCategoryExpenses = AppState.expenses.filter(exp => selectedCategories.includes(exp.category));
                
                const budgetTotal = allCategoryItems.reduce((sum, item) => {
                    if (item.cost) return sum + item.cost;
                    if (item.subItems) return sum + item.subItems.reduce((subSum, subItem) => subSum + (subItem.cost || 0), 0);
                    return sum;
                }, 0);
                const expensesTotal = allCategoryExpenses.reduce((sum, exp) => sum + (exp.amount || 0), 0);
                const remaining = budgetTotal - expensesTotal;
                
                const contentHTML = `
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                        <h4 class="font-bold text-lg text-slate-900 dark:text-white mb-4">
                            ${selectedCategories.length === 1 ? selectedCategories[0] : `M√∫ltiples Categor√≠as (${selectedCategories.join(', ')})`}
                        </h4>
                        
                        <!-- Resumen de la categor√≠a -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="text-center p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                <p class="text-sm text-slate-600 dark:text-slate-400">Presupuesto</p>
                                <p class="text-xl font-bold text-blue-600 dark:text-blue-400">${Utils.formatCurrency(budgetTotal, true)}</p>
                            </div>
                            <div class="text-center p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                <p class="text-sm text-slate-600 dark:text-slate-400">Gastado</p>
                                <p class="text-xl font-bold text-green-600 dark:text-green-400">${Utils.formatCurrency(expensesTotal, true)}</p>
                            </div>
                            <div class="text-center p-3 ${remaining >= 0 ? 'bg-orange-50 dark:bg-orange-900/20' : 'bg-red-50 dark:bg-red-900/20'} rounded-lg">
                                <p class="text-sm text-slate-600 dark:text-slate-400">Restante</p>
                                <p class="text-xl font-bold ${remaining >= 0 ? 'text-orange-600 dark:text-orange-400' : 'text-red-600 dark:text-red-400'}">${Utils.formatCurrency(remaining, true)}</p>
                            </div>
                        </div>
                        
                        <!-- Lista de items del presupuesto -->
                        <div class="mb-6">
                            <h5 class="font-semibold text-slate-700 dark:text-slate-300 mb-3">Items del Presupuesto</h5>
                            <div class="space-y-4">
                                ${selectedCategories.map(cat => {
                                    const catItems = allCategoryItems.filter(item => item.category === cat);
                                    if (catItems.length === 0) return '';
                                    
                                    return `
                                        <div class="border-l-4 border-blue-500 pl-4">
                                            <h6 class="font-medium text-blue-600 dark:text-blue-400 mb-2">${cat}</h6>
                                            <div class="space-y-2">
                                                ${catItems.map(item => `
                                                    <div class="flex justify-between items-center p-2 bg-slate-50 dark:bg-slate-700/50 rounded">
                                                        <span class="text-sm">${item.concept}</span>
                                                        <span class="font-semibold">${Utils.formatCurrency(item.cost || (item.subItems ? item.subItems.reduce((sum, sub) => sum + (sub.cost || 0), 0) : 0), true)}</span>
                                                    </div>
                                                    ${item.subItems ? item.subItems.map(subItem => `
                                                        <div class="flex justify-between items-center p-2 ml-4 bg-slate-100 dark:bg-slate-600/50 rounded text-sm">
                                                            <span class="text-xs">‚Ä¢ ${subItem.concept}</span>
                                                            <span class="font-medium">${Utils.formatCurrency(subItem.cost, true)}</span>
                                                        </div>
                                                    `).join('') : ''}
                                                `).join('')}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        <!-- Lista de gastos registrados -->
                        ${allCategoryExpenses.length > 0 ? `
                        <div>
                            <h5 class="font-semibold text-slate-700 dark:text-slate-300 mb-3">Gastos Registrados</h5>
                            <div class="space-y-4">
                                ${selectedCategories.map(cat => {
                                    const catExpenses = allCategoryExpenses.filter(exp => exp.category === cat);
                                    if (catExpenses.length === 0) return '';
                                    
                                    return `
                                        <div class="border-l-4 border-green-500 pl-4">
                                            <h6 class="font-medium text-green-600 dark:text-green-400 mb-2">${cat}</h6>
                                            <div class="space-y-2">
                                                ${catExpenses.map(exp => `
                                                    <div class="flex justify-between items-center p-2 bg-green-50 dark:bg-green-900/20 rounded">
                                                        <span class="text-sm">${exp.concept}</span>
                                                        <span class="font-semibold text-green-600 dark:text-green-400">${Utils.formatCurrency(exp.amount, true)}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        ` : '<p class="text-sm text-slate-500 dark:text-slate-400 text-center py-4">No hay gastos registrados en las categor√≠as seleccionadas</p>'}
                    </div>
                `;
                
                contentContainer.innerHTML = contentHTML;
                
            } catch (error) {
                Utils.error('Error al mostrar contenido de categor√≠a:', error);
                contentContainer.innerHTML = '<div class="text-center text-red-500 py-4">Error al cargar la informaci√≥n</div>';
            }
        },
        
        getCategoryIcon(category) {
            const iconMap = {
                'Transporte': 'directions_car',
                'Tour': 'map',
                'Comida y Bebida': 'restaurant',
                'Entradas y Visados': 'account_balance',
                'Varios': 'shopping_bag',
                'Contingencia': 'security'
            };
            return iconMap[category] || 'category';
        },
        
        getCategoryColor(category) {
            const colorMap = {
                'Transporte': 'bg-blue-500',
                'Tour': 'bg-green-500',
                'Comida y Bebida': 'bg-orange-500',
                'Entradas y Visados': 'bg-purple-500',
                'Varios': 'bg-pink-500',
                'Contingencia': 'bg-red-500'
            };
            return colorMap[category] || 'bg-slate-500';
        },
        
        renderExpenseList() {
            const container = document.getElementById('expense-list');
            if (!container) return;
            
            try {
                if (AppState.expenses.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <div class="w-24 h-24 bg-gradient-to-br from-slate-200 to-slate-300 dark:from-slate-600 dark:to-slate-700 rounded-3xl flex items-center justify-center mx-auto mb-6">
                                <span class="material-symbols-outlined text-4xl text-slate-400 dark:text-slate-500">receipt_long</span>
                            </div>
                            <h5 class="text-xl font-semibold text-slate-600 dark:text-slate-400 mb-2">No hay gastos registrados</h5>
                            <p class="text-slate-500 dark:text-slate-500">Comienza a√±adiendo tu primer gasto del viaje</p>
                        </div>
                    `;
                    return;
                }
                
                const expensesHTML = AppState.expenses.map(exp => `
                    <div class="expense-item group flex justify-between items-center p-6 bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-700 dark:to-slate-800 rounded-2xl border border-slate-200 dark:border-slate-600 hover:border-blue-300 dark:hover:border-blue-600 transition-all duration-300 hover:shadow-lg hover:scale-[1.02]" data-expense-id="${exp.id}">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300">
                                <span class="material-symbols-outlined text-white text-lg">receipt</span>
                            </div>
                            <div>
                                <p class="font-bold text-lg text-slate-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">${exp.concept}</p>
                                <div class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400">
                                    <div class="w-6 h-6 bg-slate-200 dark:bg-slate-600 rounded-lg flex items-center justify-center">
                                        <span class="material-symbols-outlined text-slate-600 dark:text-slate-400 text-xs">category</span>
                                </div>
                                    <span class="font-medium">${exp.category}</span>
                            </div>
                        </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="text-right">
                                <span class="font-black text-2xl text-green-600 dark:text-green-400">${Utils.formatCurrency(exp.amount, true)}</span>
                                <p class="text-xs text-slate-500 dark:text-slate-400">Gasto registrado</p>
                            </div>
                            <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-all duration-300">
                                <button class="edit-expense-btn p-3 text-blue-500 hover:text-blue-700 hover:bg-blue-100 dark:hover:bg-blue-900/30 rounded-xl transition-all duration-200 hover:scale-110" data-id="${exp.id}" title="Editar gasto">
                                    <span class="material-symbols-outlined">edit</span>
                                </button>
                                <button class="delete-expense-btn p-3 text-red-500 hover:text-red-700 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-xl transition-all duration-200 hover:scale-110" data-id="${exp.id}" title="Eliminar gasto">
                                    <span class="material-symbols-outlined">delete</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = `
                    <div class="space-y-6">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl flex items-center justify-center shadow-lg">
                                    <span class="material-symbols-outlined text-white text-2xl">receipt_long</span>
                                </div>
                                <div>
                                    <h5 class="font-bold text-2xl text-slate-900 dark:text-white">Gastos Registrados</h5>
                                    <p class="text-slate-600 dark:text-slate-400">${AppState.expenses.length} gastos en total</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-black text-green-600 dark:text-green-400">
                                    ${Utils.formatCurrency(AppState.expenses.reduce((sum, exp) => sum + (exp.amount || 0), 0), true)}
                                </div>
                                <p class="text-sm text-slate-500 dark:text-slate-400">Total gastado</p>
                            </div>
                        </div>
                        <div class="space-y-4">
                        ${expensesHTML}
                        </div>
                    </div>
                `;
                
                // Event listeners para editar y eliminar gastos
                container.addEventListener('click', (e) => {
                    const editBtn = e.target.closest('.edit-expense-btn');
                    const deleteBtn = e.target.closest('.delete-expense-btn');
                    
                    if (editBtn) {
                        const id = editBtn.dataset.id;
                        this.editExpense(id);
                    } else if (deleteBtn) {
                        const id = deleteBtn.dataset.id;
                        ExpenseManager.remove(id);
                        this.renderExpenseList();
                        this.showCategoryContent(); // Actualizar vista de categor√≠as
                    }
                });
                
            } catch (error) {
                Utils.error('Error al renderizar lista de gastos:', error);
            }
        },


        
        /**
         * Actualiza el indicador visual del formulario
         * Muestra si est√° en modo creaci√≥n o edici√≥n
         */
        updateFormIndicator() {
            const submitBtn = document.querySelector('#expense-form button[type="submit"]');
            const formTitle = document.querySelector('#expense-form h3');
            const currentEditId = submitBtn?.dataset.editId;
            
            if (currentEditId) {
                const expense = AppState.expenses.find(exp => exp.id === currentEditId);
                if (formTitle && expense) {
                    formTitle.textContent = `‚úèÔ∏è Editando: ${expense.concept}`;
                    formTitle.className = 'text-xl font-bold text-blue-600 dark:text-blue-400 mb-4';
                }
            } else {
                if (formTitle) {
                    formTitle.textContent = '‚ûï A√±adir Nuevo Gasto';
                    formTitle.className = 'text-xl font-bold text-slate-900 dark:text-white mb-4';
                }
            }
        },

        renderWeather() {
            Utils.log('üå§Ô∏è Renderizando secci√≥n de clima');
            const container = document.getElementById('weather');
            
            try {
                // Informaci√≥n clim√°tica detallada por ubicaci√≥n
                const weatherCards = tripConfig.weatherData.filter(w => w.dayTemp).map(weather => {
                    const tempRange = weather.dayTemp.split('-');
                    const dayTemp = tempRange[0];
                    const nightTemp = tempRange[1]?.replace('¬∞C', '') || tempRange[0];
                    
                    return `
                        <div class="bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-900 p-6 rounded-3xl shadow-2xl border border-slate-200/50 dark:border-slate-700/50 hover:shadow-3xl transition-all duration-300">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-gradient-to-br from-sky-400 to-sky-600 rounded-2xl flex items-center justify-center shadow-lg">
                                        <span class="text-white text-xl">${weather.icon}</span>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-lg text-slate-900 dark:text-white">${weather.location}</h4>
                                        <p class="text-sm text-slate-600 dark:text-slate-400">Clima t√≠pico</p>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="text-center p-4 bg-white dark:bg-slate-700 rounded-2xl border border-slate-200 dark:border-slate-600">
                                    <div class="w-10 h-10 bg-gradient-to-br from-orange-400 to-orange-600 rounded-xl flex items-center justify-center mx-auto mb-2">
                                        <span class="material-symbols-outlined text-white text-sm">wb_sunny</span>
                                    </div>
                                    <p class="text-xs text-slate-600 dark:text-slate-400 mb-1">D√≠a</p>
                                    <p class="text-xl font-bold text-slate-900 dark:text-white">${dayTemp}¬∞C</p>
                                </div>
                                <div class="text-center p-4 bg-white dark:bg-slate-700 rounded-2xl border border-slate-200 dark:border-slate-600">
                                    <div class="w-10 h-10 bg-gradient-to-br from-blue-400 to-blue-600 rounded-xl flex items-center justify-center mx-auto mb-2">
                                        <span class="material-symbols-outlined text-white text-sm">nights_stay</span>
                                    </div>
                                    <p class="text-xs text-slate-600 dark:text-slate-400 mb-1">Noche</p>
                                    <p class="text-xl font-bold text-slate-900 dark:text-white">${nightTemp}¬∞C</p>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Informaci√≥n general del clima
                const generalInfo = tripConfig.weatherData.find(w => !w.dayTemp);
                const generalInfoHTML = generalInfo ? `
                    <div class="bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-900 p-8 rounded-3xl shadow-2xl border border-slate-200/50 dark:border-slate-700/50 col-span-full">
                        <div class="flex items-center gap-4 mb-6">
                            <div class="w-16 h-16 bg-gradient-to-br from-sky-500 to-sky-600 rounded-2xl flex items-center justify-center shadow-lg">
                                <span class="text-white text-2xl">${generalInfo.icon}</span>
                            </div>
                            <div>
                                <h4 class="font-bold text-2xl text-slate-900 dark:text-white">Informaci√≥n Clim√°tica General</h4>
                                <p class="text-slate-600 dark:text-slate-400">Condiciones esperadas durante el viaje</p>
                            </div>
                        </div>
                        <div class="text-center p-6 bg-white dark:bg-slate-700 rounded-2xl border border-slate-200 dark:border-slate-600">
                            <p class="text-lg text-slate-700 dark:text-slate-300">${generalInfo.description}</p>
                        </div>
                    </div>
                ` : '';
                
                container.innerHTML = `
                    ${Utils.createSectionHeader('Informaci√≥n Clim√°tica del Viaje')}
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${weatherCards}
                        ${generalInfoHTML}
                    </div>
                `;
            } catch (error) {
                Utils.error('Error al renderizar weather:', error);
                container.innerHTML = `<div class="bg-red-100 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 text-red-700 dark:text-red-400">
                    <h3 class="font-semibold">Error al cargar la informaci√≥n clim√°tica</h3>
                    <p class="text-sm">${error.message}</p>
                </div>`;
            }
        },
        renderPackingList() {
            Utils.log('üéí Renderizando lista de equipaje');
            const container = document.getElementById('packing-list');
            const saved = JSON.parse(localStorage.getItem('packingListV2')) || {};
            
            const listHTML = Object.entries(tripConfig.packingListData).map(([category, items]) => {
                const categoryIcon = this.getCategoryIcon(category);
                
                return `<div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="material-symbols-outlined text-2xl text-blue-600 dark:text-blue-400">${categoryIcon}</span>
                        <h3 class="font-bold text-lg text-slate-900 dark:text-white">${category}</h3>
                    </div>
                    <ul class="space-y-3">
                        ${items.map((item, index) => { 
                            const id = `${category.replace(/\s+/g, '-')}-${index}`; 
                            return `<li class="flex items-center">
                                <input type="checkbox" id="${id}" data-item-id="${id}" ${saved[id] ? 'checked' : ''} 
                                       class="h-5 w-5 rounded border-slate-300 text-blue-600 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600">
                                <label for="${id}" class="ml-3 text-sm text-slate-700 dark:text-slate-300 transition-colors peer-checked:line-through peer-checked:text-slate-400 dark:peer-checked:text-slate-500">${item}</label>
                            </li>`; 
                        }).join('')}
                    </ul>
                </div>`;
            }).join('');
            
            container.innerHTML = `${Utils.createSectionHeader('Lista de Equipaje Esencial')}<div class="grid grid-cols-1 md:grid-cols-2 gap-6">${listHTML}</div>`;
            
            container.addEventListener('change', e => {
                if (e.target.matches('input[type="checkbox"]')) {
                    saved[e.target.dataset.itemId] = e.target.checked;
                    localStorage.setItem('packingListV2', JSON.stringify(saved));
                }
            });
        },
        
        getCategoryIcon(category) {
            const iconMap = {
                'üëï Ropa': 'checkroom',
                'üëü Calzado': 'sports_esports',
                'üéí Equipo': 'backpack',
                'üìÑ Documentos y Salud': 'health_and_safety'
            };
            return iconMap[category] || 'inventory';
        }
    };

/**
 * Gestor de gastos del viaje
 * Maneja la creaci√≥n, edici√≥n, eliminaci√≥n y persistencia de gastos
 */
const ExpenseManager = {
    /**
     * Guarda los gastos en localStorage
     * Persiste los datos entre sesiones del navegador
     */
        save() {
        AppState.saveAllData();
        },

    /**
     * A√±ade un nuevo gasto a la lista
     * @param {Object} expense - Objeto con concept, amount y category
     */
        add(expense) {
        Utils.log(`‚ûï A√±adiendo nuevo gasto: ${expense.concept}`);
        AppState.expenses.push({ ...expense, id: Date.now().toString() });
            this.save();
        Utils.log(`‚úÖ Gasto a√±adido exitosamente: ${expense.concept} - ${Utils.formatCurrency(expense.amount)}`);
        
        // Actualizar la lista de gastos para mostrar cambios visuales
        this.renderList();
        },

    /**
     * Elimina un gasto por su ID
     * @param {string} id - ID √∫nico del gasto a eliminar
     */
        remove(id) {
            Utils.log(`üóëÔ∏è Eliminando gasto con ID: ${id}`);
            const expense = AppState.expenses.find(exp => exp.id === id);
            
            if (!expense) {
                Utils.error(`‚ùå No se encontr√≥ gasto con ID: ${id} para eliminar`);
                return;
            }
            
            Utils.log(`üóëÔ∏è Eliminando gasto: ${expense.concept} - ${Utils.formatCurrency(expense.amount)}`);
            
            // Eliminar el gasto del array
            AppState.expenses = AppState.expenses.filter(exp => exp.id !== id);
            
            // Guardar en localStorage
            this.save();
            
            // Si se elimin√≥ el gasto que se estaba editando, cancelar edici√≥n
            const submitBtn = document.querySelector('#expense-form button[type="submit"]');
            if (submitBtn && submitBtn.dataset.editId === id) {
                Utils.log(`üîÑ Cancelando edici√≥n autom√°ticamente tras eliminar gasto en edici√≥n`);
                this.cancelEdit();
            }
            
            Utils.log(`‚úÖ Gasto eliminado exitosamente: ${expense.concept}`);
            
            // Actualizar la lista de gastos para mostrar cambios visuales
            this.renderList();
        },

    /**
     * Inicia o cancela la edici√≥n de un gasto (toggle)
     * @param {string} id - ID del gasto a editar
     */
    editExpense(id) {
        Utils.log(`üéØ editExpense llamado con ID: ${id}`);
        const submitBtn = document.querySelector('#expense-form button[type="submit"]');
        const currentEditId = submitBtn?.dataset.editId;
        Utils.log(`üìù Estado actual del formulario - editId: ${currentEditId || 'ninguno'}`);
        
        // Si ya estamos editando este mismo gasto, cancelar edici√≥n (toggle off)
        if (currentEditId === id) {
            Utils.log(`üîÑ Ya estamos editando este gasto: ${id}. Cancelando edici√≥n (toggle off)`);
            this.cancelEdit();
            return;
        }
        
        // Buscar el gasto a editar
        const expense = AppState.expenses.find(exp => exp.id === id);
        if (!expense) {
            Utils.error(`‚ùå No se encontr√≥ gasto con ID: ${id} para editar`);
            return;
        }
        
        Utils.log(`‚úèÔ∏è Cargando gasto para editar: ${id} - ${expense.concept}`);
        
        const conceptInput = document.getElementById('expense-concept');
        const amountInput = document.getElementById('expense-amount');
        const categorySelect = document.getElementById('expense-category');
        const budgetLinkSelect = document.getElementById('expense-budget-link');
        
        // Llenar formulario con datos del gasto
        conceptInput.value = expense.concept;
        amountInput.value = expense.amount;
        categorySelect.value = expense.category;
        if (budgetLinkSelect && expense.budgetLink) {
            budgetLinkSelect.value = expense.budgetLink;
        }
        
        // Cambiar el bot√≥n a "Actualizar Gasto"
        submitBtn.textContent = 'Actualizar ';
        submitBtn.dataset.editId = id;
        

        
        // Hacer scroll al formulario
        document.getElementById('expense-form').scrollIntoView({ behavior: 'smooth' });
        
        Utils.log(`‚úÖ Formulario preparado para editar: ${expense.concept}`);
        
        // Actualizar indicador visual del formulario
        if (window.UIRenderer && window.UIRenderer.updateFormIndicator) {
            window.UIRenderer.updateFormIndicator();
        }
        
        // Actualizar la lista para mostrar el estado visual
        this.renderList();
    },

    /**
     * Actualiza un gasto existente
     * @param {string} id - ID del gasto a actualizar
     * @param {Object} updatedExpense - Nuevos datos del gasto
     */
    update(id, updatedExpense) {
        Utils.log(`‚úèÔ∏è Actualizando gasto con ID: ${id}`);
        const index = AppState.expenses.findIndex(exp => exp.id === id);
        if (index !== -1) {
            AppState.expenses[index] = { ...AppState.expenses[index], ...updatedExpense };
            this.save();
            Utils.log(`‚úÖ Gasto actualizado exitosamente: ${updatedExpense.concept}`);
            
            // Mantener el modo edici√≥n activo para permitir m√°s cambios
            Utils.log(`üîÑ Manteniendo modo edici√≥n activo para el gasto: ${updatedExpense.concept}`);
            
            // Actualizar la lista de gastos para mostrar cambios visuales
            this.renderList();
        } else {
            Utils.error(`‚ùå No se encontr√≥ gasto con ID: ${id} para actualizar`);
        }
    },

    /**
     * Cancela el modo de edici√≥n y restaura el formulario
     * Limpia todos los campos y restaura el bot√≥n original
     */
    cancelEdit() {
        Utils.log('üîÑ Cancelando edici√≥n y restaurando formulario a modo creaci√≥n');
        
        // Restaurar bot√≥n original
        const submitBtn = document.querySelector('#expense-form button[type="submit"]');
        if (submitBtn) {
            submitBtn.textContent = 'A√±adir Gasto';
            delete submitBtn.dataset.editId;
        }
        

        
        // Limpiar formulario
        const form = document.getElementById('expense-form');
        if (form) {
            form.reset();
        }
        
        Utils.log('‚úÖ Formulario restaurado a modo creaci√≥n');
        
        // Actualizar indicador visual del formulario
        if (window.UIRenderer && window.UIRenderer.updateFormIndicator) {
            window.UIRenderer.updateFormIndicator();
        }
        
        // Actualizar la lista para quitar el resaltado
        this.renderList();
    },

    /**
     * Calcula el total de todos los gastos
     * @returns {number} Suma total de todos los gastos
     */
        getTotal() {
        return AppState.expenses.reduce((sum, exp) => sum + exp.amount, 0);
    },

    /**
     * Calcula el total de gastos por categor√≠a
     * @param {string} category - Categor√≠a a calcular
     * @returns {number} Suma total de gastos en esa categor√≠a
     */
        getCategoryTotal(category) {
        return AppState.expenses.filter(exp => exp.category === category).reduce((sum, exp) => sum + exp.amount, 0);
    },

            /**
         * Encuentra un item del presupuesto por fase, categor√≠a y concepto
         * @param {string} phase - Fase del viaje (vuelos, nepal, butan)
         * @param {string} category - Categor√≠a del presupuesto
         * @param {string} concept - Concepto espec√≠fico
         * @returns {Object|null} Item del presupuesto o null si no se encuentra
         */
        findBudgetItem(phase, category, concept) {
            if (!tripConfig.budgetData[phase]) return null;
            
            const categoryItems = tripConfig.budgetData[phase].filter(item => item.category === category);
            if (categoryItems.length === 0) return null;
            
            // Buscar en items principales
            let item = categoryItems.find(item => item.concept === concept);
            if (item) return item;
            
            // Buscar en subitems
            for (const categoryItem of categoryItems) {
                if (categoryItem.subItems) {
                    item = categoryItem.subItems.find(subItem => subItem.concept === concept);
                    if (item) return item;
                }
            }
            
            return null;
        },
        
        /**
         * Renderiza la lista de gastos en la interfaz
         * Muestra todos los gastos con opciones de editar y eliminar
         */
        renderList() {
            const listContainer = document.getElementById('expense-list');
            if (AppState.expenses.length === 0) {
                listContainer.innerHTML = `<p class="text-center text-sm text-slate-500 py-4">A√∫n no has a√±adido ning√∫n gasto.</p>`;
                return;
            }
            
            // Obtener el ID del gasto que se est√° editando actualmente
            const submitBtn = document.querySelector('#expense-form button[type="submit"]');
            const currentEditId = submitBtn?.dataset.editId;
            
            Utils.log(`üîÑ Renderizando lista de gastos. Gasto en edici√≥n: ${currentEditId || 'ninguno'}`);
            
            // Generar HTML para cada gasto con botones de acci√≥n
            listContainer.innerHTML = AppState.expenses.map(exp => {
            let budgetComparison = '';
            
            // Si el gasto est√° vinculado con el presupuesto, mostrar comparaci√≥n
            if (exp.budgetLink) {
                const [phase, category, concept] = exp.budgetLink.split(':');
                const budgetItem = this.findBudgetItem(phase, category, concept);
                
                if (budgetItem) {
                    const budgetAmount = budgetItem.cost;
                    const difference = exp.amount - budgetAmount;
                    const isOverBudget = difference > 0;
                    const isUnderBudget = difference < 0;
                    
                    budgetComparison = `
                        <div class="text-xs text-slate-500 mt-1">
                            <span class="font-medium">Presupuesto:</span> ${Utils.formatCurrency(budgetAmount)}
                            ${isOverBudget ? `<span class="text-red-500 font-medium"> (+${Utils.formatCurrency(difference)})</span>` : ''}
                            ${isUnderBudget ? `<span class="text-green-500 font-medium"> (${Utils.formatCurrency(difference)})</span>` : ''}
                        </div>
                    `;
                }
            }
            
            const isCurrentlyEditing = currentEditId === exp.id;
            const editButtonText = isCurrentlyEditing ? 'üîÑ' : '‚úèÔ∏è';
            const editButtonTitle = isCurrentlyEditing ? 'Cancelar edici√≥n' : 'Editar';
            const editButtonClass = isCurrentlyEditing 
                ? 'edit-expense-btn text-blue-500 hover:text-blue-600 text-lg leading-none p-1 font-bold' 
                : 'edit-expense-btn text-slate-400 hover:text-blue-500 text-lg leading-none p-1';
            
            return `
                <div class="expense-item flex items-center justify-between p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700/50 cursor-pointer transition-all ${isCurrentlyEditing ? 'bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-500' : ''}" data-expense-id="${exp.id}">
                    <div class="flex-1">
                        <p class="text-sm font-medium ${isCurrentlyEditing ? 'text-blue-700 dark:text-blue-300' : ''}">${exp.concept} ${isCurrentlyEditing ? '‚úèÔ∏è' : ''}</p>
                        <p class="text-xs text-slate-500">${exp.category}</p>
                        ${budgetComparison}
                    </div>
                    <div class="flex items-center gap-4">
                        <p class="font-semibold text-sm">${Utils.formatCurrency(exp.amount)}</p>
                        <div class="flex items-center gap-2">
                            <button data-id="${exp.id}" class="delete-expense-btn text-slate-400 hover:text-red-500 text-xl leading-none" title="Eliminar">&times;</button>
                    </div>
                    </div>
                </div>`;
        }).join('');
    }
};

// ===== INICIALIZACI√ìN DE LA APLICACI√ìN =====
/**
 * Clase principal de la aplicaci√≥n
 * Coordina la inicializaci√≥n de todos los managers y sistemas
 */
const App = {
    /**
     * Inicializa la aplicaci√≥n completa
     * Configura todos los managers y sistemas en el orden correcto
     */
    async init() {
        Utils.log('üöÄ Iniciando aplicaci√≥n Himalaya Adventure');
        
        try {
            // Inicializar todos los managers en orden de dependencia
    

            ParallaxManager.init();     // Efectos de scroll
            NavigationManager.init();   // Navegaci√≥n entre secciones
            PDFExporter.init();         // Exportaci√≥n de PDF
            UIRenderer.init();          // Renderizado de UI (debe ir √∫ltimo)
            
            // Configurar observadores de intersecci√≥n para animaciones
            this.setupIntersectionObserver();
            
            // Actualizar subt√≠tulos din√°micos
            setTimeout(() => {
                const totalDays = tripConfig.calendarData.getTotalDays();
                const sidebarSubtitle = document.getElementById('sidebar-subtitle');
                const heroSubtitle = document.getElementById('hero-subtitle');
                
                if (sidebarSubtitle) {
                    sidebarSubtitle.textContent = `Un recorrido de ${totalDays} d√≠as para descubrir Nepal y But√°n.`;
                }
                if (heroSubtitle) {
                    heroSubtitle.textContent = `Un recorrido de ${totalDays} d√≠as para descubrir Nepal y But√°n.`;
                }
                
                Utils.log(`Subt√≠tulos actualizados con ${totalDays} d√≠as`);
            }, 500);
            
            // Inicializar todas las secciones como expandidas
            setTimeout(() => {
                Utils.initializeSections();
            }, 1000);
            
            // Fallback de seguridad: asegurar que todas las secciones sean visibles
            // √ötil si hay problemas con el Intersection Observer
            setTimeout(() => {
                document.querySelectorAll('section').forEach(section => {
                    if (section.style.opacity === '0') {
                        Utils.log(`Fallback: haciendo visible secci√≥n ${section.id}`);
                        section.style.opacity = '1';
                        section.style.transform = 'translateY(0)';
                    }
                });
            }, 3000);
            
            Utils.log('‚úÖ Aplicaci√≥n iniciada correctamente');
        } catch (error) {
            Utils.error('Error al inicializar la aplicaci√≥n:', error);
        }
    },

    /**
     * Configura el Intersection Observer para animaciones de entrada
     * Hace que las secciones aparezcan con animaci√≥n al hacer scroll
     */
    setupIntersectionObserver() {
        Utils.log('Configurando Intersection Observer para animaciones');
        
        // Observer que detecta cuando las secciones entran en el viewport
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    // Hacer visible la secci√≥n con animaci√≥n
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                    Utils.log(`Secci√≥n ${entry.target.id} ahora visible`);
                }
            });
        }, { threshold: 0.1 }); // Se activa cuando el 10% de la secci√≥n es visible

        // Configurar todas las secciones para animaciones
        const sections = document.querySelectorAll('section');
        Utils.log(`Encontradas ${sections.length} secciones para animar`);
        
        sections.forEach(section => {
            // Estado inicial: invisible y desplazada hacia abajo
            section.style.opacity = '0';
            section.style.transform = 'translateY(20px)';
            section.style.transition = 'all 0.6s ease-out';
            
            // Observar la secci√≥n para animaciones
            observer.observe(section);
            
            // Timeout de seguridad: forzar visibilidad si hay problemas con el observer
            setTimeout(() => {
                if (section.style.opacity === '0') {
                    Utils.log(`Forzando visibilidad de secci√≥n ${section.id}`);
                    section.style.opacity = '1';
                    section.style.transform = 'translateY(0)';
                }
            }, 2000); // 2 segundos de timeout
        });
    }
};
</script>

<!-- Bloque 3: Inicializador (main.js) -->
<script>
// Funci√≥n global para cambiar vista - DEBE estar fuera del listener para ser accesible
function switchToView(view) {
    Utils.log(`üîÑ Cambiando a vista: ${view}`);
    
    // Ocultar todas las secciones
    const allSections = document.querySelectorAll('section[id]');
    Utils.log(`üìÑ Encontradas ${allSections.length} secciones`);
    allSections.forEach(section => {
        section.style.display = 'none';
        Utils.log(`‚ùå Ocultando secci√≥n: ${section.id}`);
    });
    
    // Controlar visibilidad del header
    const header = document.querySelector('header');
    if (header) {
        if (view === 'summary') {
            header.style.display = 'block';
        } else {
            header.style.display = 'none';
        }
    }
    
    // Mostrar secci√≥n correspondiente
    switch(view) {
        case 'today':
            const todayPanel = document.getElementById('today-panel');
            const todayDate = document.getElementById('today-date');
            const todayDay = document.getElementById('today-day');
            const nextDestination = document.getElementById('next-destination');
            const todayAccommodation = document.getElementById('today-accommodation');
            const todayActivity = document.getElementById('today-activity');
            const todayWeather = document.getElementById('today-weather');
            
            if (todayPanel) {
                todayPanel.style.display = 'block';
                Utils.log(`‚úÖ Mostrando: today-panel`);
                
                // Actualizar informaci√≥n del d√≠a actual
                if (typeof UIRenderer !== 'undefined' && UIRenderer.updateTodayInfo) {
                    UIRenderer.updateTodayInfo();
                }
            }
            break;
        case 'summary':
            const summary = document.getElementById('summary');
            const flights = document.getElementById('flights');
            
            if (summary) {
                summary.style.display = 'block';
                Utils.log(`‚úÖ Mostrando: summary`);
                // Renderizar contenido del resumen
                if (typeof UIRenderer !== 'undefined' && UIRenderer.renderSummary) {
                    UIRenderer.renderSummary();
                }
            }
            if (flights) {
                flights.style.display = 'block';
                Utils.log(`‚úÖ Mostrando: flights`);
                // Renderizar contenido de vuelos
                if (typeof UIRenderer !== 'undefined' && UIRenderer.renderFlights) {
                    UIRenderer.renderFlights();
                }
            }
            break;
        case 'overview':
            const overview = document.getElementById('overview');
            
            if (overview) {
                overview.style.display = 'block';
                Utils.log(`‚úÖ Mostrando: overview`);
            }
            break;
        case 'itinerary':
            const itinerary = document.getElementById('itinerary');
            if (itinerary) {
                itinerary.style.display = 'block';
                Utils.log(`‚úÖ Mostrando: itinerary`);
                // Renderizar contenido del itinerario
                if (typeof UIRenderer !== 'undefined' && UIRenderer.renderItinerary) {
                    UIRenderer.renderItinerary();
                }
            } else {
                Utils.error(`‚ùå No se encontr√≥ secci√≥n: itinerary`);
            }
            break;
        case 'map':
            const mapSection = document.getElementById('map-section');
            if (mapSection) {
                mapSection.style.display = 'block';
                Utils.log(`‚úÖ Mostrando: map-section`);
                // Renderizar contenido del mapa
                if (typeof UIRenderer !== 'undefined' && UIRenderer.renderMap) {
                    UIRenderer.renderMap();
                }
            } else {
                Utils.error(`‚ùå No se encontr√≥ secci√≥n: map-section`);
            }
            break;
        case 'tools':
            const budget = document.getElementById('budget');
            const packingList = document.getElementById('packing-list');
            const tourPackages = document.getElementById('tour-packages');
            const overviewSection = document.getElementById('overview');
            
            if (budget) {
                budget.style.display = 'block';
                Utils.log(`‚úÖ Mostrando: budget`);
                // Renderizar contenido del presupuesto
                if (typeof UIRenderer !== 'undefined' && UIRenderer.renderBudget) {
                    UIRenderer.renderBudget();
                }
            }
            if (packingList) {
                packingList.style.display = 'block';
                Utils.log(`‚úÖ Mostrando: packing-list`);
                // Renderizar contenido de equipaje
                if (typeof UIRenderer !== 'undefined' && UIRenderer.renderPackingList) {
                    UIRenderer.renderPackingList();
                }
            }
            if (tourPackages) {
                tourPackages.style.display = 'block';
                Utils.log(`‚úÖ Mostrando: tour-packages`);
                // Renderizar contenido de paquetes
                if (typeof UIRenderer !== 'undefined' && UIRenderer.renderTourPackages) {
                    UIRenderer.renderTourPackages();
                }
            }
            if (overviewSection) {
                overviewSection.style.display = 'block';
                Utils.log(`‚úÖ Mostrando: overview`);
                // Renderizar contenido de informaci√≥n adicional
                if (typeof UIRenderer !== 'undefined' && UIRenderer.renderOverview) {
                    UIRenderer.renderOverview();
                }
            }
            break;
        default:
            Utils.error(`‚ùå Vista no reconocida: ${view}`);
    }
    
    // Actualizar navegaci√≥n activa
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => {
        item.classList.remove('active');
        if (item.dataset.view === view) {
            item.classList.add('active');
        }
    });
    
    // Scroll al inicio
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Funci√≥n global para actualizar navegaci√≥n activa
function updateActiveNav(activeItem) {
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => {
        item.classList.remove('active');
    });
    activeItem.classList.add('active');
}

document.addEventListener('DOMContentLoaded', () => {
    // Inicializar la aplicaci√≥n
    
            // Funcionalidad PWA
        setTimeout(() => {
            // Registrar Service Worker
            if ('serviceWorker' in navigator && (location.protocol === 'https:' || location.protocol === 'http:')) {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => Utils.log('üì± Service Worker registrado'))
                    .catch(err => Utils.error('‚ùå Error SW:', err));
            } else if (location.protocol === 'file:') {
                Utils.log('üì± Service Worker no disponible en protocolo file:// (archivo local)');
            }
            
            // Prompt de instalaci√≥n PWA
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                // Solo mostrar prompt en protocolos HTTP/HTTPS
                if (location.protocol === 'file:') return;
                
                e.preventDefault();
                deferredPrompt = e;
                
                // Mostrar prompt despu√©s de 5 segundos
                setTimeout(() => {
                    const installDiv = document.createElement('div');
                    installDiv.className = 'fixed bottom-4 right-4 bg-blue-600 text-white p-4 rounded-lg shadow-lg z-50 max-w-sm';
                    installDiv.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">üì±</span>
                            <div class="flex-1">
                                <p class="font-semibold text-sm">¬°Instala la app!</p>
                                <p class="text-xs opacity-90">√ösala sin conexi√≥n</p>
                            </div>
                            <div class="flex flex-col gap-1">
                                <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove(); deferredPrompt.prompt()" class="bg-white text-blue-600 px-3 py-1 rounded text-xs font-medium">
                                    Instalar
                                </button>
                                <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove()" class="text-white/70 text-xs">
                                    Ahora no
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(installDiv);
                    
                    // Auto-remove despu√©s de 15 segundos
                    setTimeout(() => {
                        if (document.body.contains(installDiv)) installDiv.remove();
                    }, 15000);
                }, 5000);
            });
            
            // Auto-guardado mejorado
            if (location.protocol !== 'file:') {
                setInterval(() => AppState.saveAllData(), 30000);
                window.addEventListener('beforeunload', () => AppState.saveAllData());
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'hidden') AppState.saveAllData();
                });
            }
            
            // Inicializar nueva navegaci√≥n
            initNewNavigation();
            
            if (location.protocol === 'file:') {
                Utils.log('üì± PWA configurada (modo local - algunas funciones limitadas)');
            } else {
                Utils.log('üì± PWA configurada');
            }
            
            // Inicializar vista por defecto despu√©s de que todo est√© listo
            setTimeout(() => {
                switchToView('summary');
                Utils.log('üéØ Vista inicial cargada');
            }, 500);
        }, 2000);
        
        // Nueva funcionalidad de navegaci√≥n
        function initNewNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            const views = ['summary', 'itinerary', 'today', 'map', 'tools', 'overview'];
            
            // Event listeners para navegaci√≥n
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const view = item.dataset.view;
                    switchToView(view);
                    updateActiveNav(item);
                });
            });
            
            // Inicializar panel "Hoy"
            initTodayPanel();
        }
        

        
        // Inicializar panel "Hoy" din√°mico
        function initTodayPanel() {
            const todayDate = document.getElementById('today-date');
            const todayDay = document.getElementById('today-day');
            const nextDestination = document.getElementById('next-destination');
            const todayAccommodation = document.getElementById('today-accommodation');
            const todayActivity = document.getElementById('today-activity');
            const todayWeather = document.getElementById('today-weather');
            
            // Calcular d√≠a actual del viaje
            const tripStartDate = new Date('2025-10-09');
            const today = new Date();
            const dayDiff = Math.floor((today - tripStartDate) / (1000 * 60 * 60 * 24));
            
            if (dayDiff >= 0 && dayDiff < 18) {
                // Viaje en curso
                todayDay.textContent = dayDiff + 1;
                todayDate.textContent = today.toLocaleDateString('es-ES', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                // Obtener datos del d√≠a actual
                const currentDayData = tripConfig.itineraryData[dayDiff];
                if (currentDayData) {
                    nextDestination.textContent = currentDayData.title;
                    todayActivity.textContent = currentDayData.description;
                    
                    // Determinar alojamiento basado en la fase
                    if (currentDayData.phase === 'nepal') {
                        todayAccommodation.textContent = 'Hotel en Nepal';
                    } else if (currentDayData.phase === 'butan') {
                        todayAccommodation.textContent = 'Hotel en But√°n';
                    } else {
                        todayAccommodation.textContent = 'En tr√°nsito';
                    }
                    
                    // Obtener clima del d√≠a
                    const weatherInfo = getWeatherForDay(currentDayData.phase);
                    todayWeather.textContent = weatherInfo;
                }
            } else if (dayDiff < 0) {
                // Viaje no iniciado - mostrar informaci√≥n del primer d√≠a
                const daysUntilTrip = Math.abs(dayDiff);
                todayDay.textContent = '1';
                todayDate.textContent = `Viaje comienza en ${daysUntilTrip} d√≠a${daysUntilTrip > 1 ? 's' : ''}`;
                
                // Mostrar informaci√≥n del primer d√≠a del itinerario
                const firstDayData = tripConfig.itineraryData[0];
                if (firstDayData) {
                    nextDestination.textContent = firstDayData.title;
                    todayActivity.textContent = `Preparaci√≥n: ${firstDayData.description}`;
                    todayAccommodation.textContent = 'Vuelo Madrid ‚Üí Kathmandu';
                    todayWeather.textContent = 'Clima de Kathmandu: 22-25¬∞C ‚òÄÔ∏è';
                }
            } else {
                // Viaje finalizado
                todayDay.textContent = '18';
                todayDate.textContent = 'Viaje finalizado';
                nextDestination.textContent = 'Regreso a Madrid';
                todayAccommodation.textContent = 'Casa';
                todayActivity.textContent = 'Descanso y recuerdos';
                todayWeather.textContent = 'Clima de Madrid üå§Ô∏è';
            }
        }
        
        // Funci√≥n para obtener clima seg√∫n la fase del viaje
        function getWeatherForDay(phase) {
            const weatherData = {
                'nepal': '22-25¬∞C d√≠a, 5-10¬∞C noche ‚òÄÔ∏è',
                'butan': '15-22¬∞C d√≠a, 0-7¬∞C noche üèîÔ∏è',
                'farewell': '22-25¬∞C d√≠a, 5-10¬∞C noche ‚òÄÔ∏è'
            };
            return weatherData[phase] || 'Clima variable üå§Ô∏è';
        }
});
</script>

</body>
</html>

